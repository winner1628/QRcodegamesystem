<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡å¾Œå° - QRç¢¼éŠæˆ²ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f8fafc; color: #334155; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 2px solid #e2e8f0; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: #dc2626; }
        .btn-logout { padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-logout:hover { background: #b91c1c; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .tab-btn.active { background: #dc2626; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .tab-content.active { display: block; }
        .add-form { display: grid; gap: 15px; max-width: 500px; margin-bottom: 30px; }
        .batch-form, .filter-form, .export-form { margin: 20px 0; padding: 20px; border: 1px dashed #cbd5e1; border-radius: 8px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .form-row .form-group { flex: 1; min-width: 200px; }
        .form-group label { font-weight: 600; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .file-input { padding: 5px; }
        .btn-submit { padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-submit:hover { background: #15803d; }
        .btn-batch, .btn-export { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .btn-batch:hover, .btn-export:hover { background: #1d4ed8; }
        .btn-danger { padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn-danger:hover { background: #b91c1c; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .data-table th { background: #f1f5f9; font-weight: 600; cursor: pointer; position: relative; }
        .data-table th:hover { background: #e2e8f0; }
        .data-table th::after { content: " â†•"; font-size: 12px; opacity: 0.5; }
        .data-table tr:hover { background: #f8fafc; }
        .msg-box { padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none; }
        .success-msg { background: #f0fdf4; color: #16a34a; }
        .error-msg { background: #fef2f2; color: #dc2626; }
        .loading { text-align: center; padding: 20px; color: #64748b; }
        .stats-card { background: #f1f5f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; }
        .stat-item { flex: 1; min-width: 200px; background: white; padding: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-item h3 { font-size: 16px; color: #64748b; margin-bottom: 10px; }
        .stat-item .value { font-size: 24px; font-weight: bold; color: #dc2626; }
        .warning-box { background: #fffbeb; border: 1px solid #fbbf24; padding: 15px; border-radius: 6px; margin-bottom: 20px; color: #92400e; }
        .csv-template { margin-top: 10px; font-size: 14px; color: #64748b; }
        .csv-template a { color: #2563eb; text-decoration: none; }
        .batch-result, .export-result { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        .success-result { background: #f0fdf4; color: #16a34a; }
        .error-result { background: #fef2f2; color: #dc2626; }
        .export-item { margin: 10px 0; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px; }
        .export-btn { margin-top: 5px; padding: 8px 16px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ç®¡ç†å“¡å¾Œå°</div>
            <button class="btn-logout" onclick="adminLogout()">ç™»å‡º</button>
        </div>

        <!-- èª¿æ•´æ¨™ç±¤æ’åºï¼šæ•¸æ“šç®¡ç†ç§»è‡³æœ€å¾Œ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('user-scores')">ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆ</button>
            <button class="tab-btn" onclick="switchTab('games')">éŠæˆ²ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('users')">ç”¨æˆ¶ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('records')">éŠæˆ²ç´€éŒ„</button>
            <button class="tab-btn" onclick="switchTab('data-export')">æ•¸æ“šå°å‡º</button>
            <button class="tab-btn" onclick="switchTab('data-management')">æ•¸æ“šç®¡ç†</button>
        </div>

        <!-- ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆæ¨™ç±¤ -->
        <div id="user-scores" class="tab-content active">
            <h2>ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆ</h2>
            <div class="stats-card">
                <div class="stat-item">
                    <h3>ç¸½è¨»å†Šç”¨æˆ¶æ•¸</h3>
                    <div id="total-users" class="value">0</div>
                </div>
                <div class="stat-item">
                    <h3>ç¸½éŠæˆ²æ•¸</h3>
                    <div id="total-games" class="value">0</div>
                </div>
                <div class="stat-item">
                    <h3>ç¸½éŠæˆ²ç´€éŒ„æ•¸</h3>
                    <div id="total-records" class="value">0</div>
                </div>
                <div class="stat-item">
                    <h3>å…¨ç«™ç¸½åˆ†æœ€é«˜</h3>
                    <div id="highest-total-score" class="value">0</div>
                </div>
            </div>

            <div id="score-msg" class="msg-box"></div>
            <div id="user-scores-list" class="loading">åŠ è¼‰ç”¨æˆ¶ç¸½åˆ†æ•¸æ“šä¸­...</div>
        </div>

        <!-- éŠæˆ²ç®¡ç†æ¨™ç±¤ -->
        <div id="games" class="tab-content">
            <h2>éŠæˆ²ç®¡ç†</h2>
            
            <!-- å–®å€‹æ–°å¢éŠæˆ² -->
            <h3 style="margin-bottom: 15px;">æ–°å¢å–®å€‹éŠæˆ²</h3>
            <div class="add-form">
                <div class="form-group">
                    <label>éŠæˆ²ä»£ç¢¼ (ä¾‹å¦‚ï¼šGAME001)</label>
                    <input id="game-code" type="text" placeholder="è«‹è¼¸å…¥éŠæˆ²ä»£ç¢¼">
                </div>
                <div class="form-group">
                    <label>éŠæˆ²åç¨±</label>
                    <input id="game-name" type="text" placeholder="è«‹è¼¸å…¥éŠæˆ²åç¨±">
                </div>
                <div class="form-group">
                    <label>æœ€é«˜åˆ†æ•¸</label>
                    <input id="game-max-score" type="number" placeholder="è«‹è¼¸å…¥æœ€é«˜åˆ†æ•¸" min="0">
                </div>
                <div class="form-group">
                    <label>é»˜èªåˆ†æ•¸</label>
                    <input id="game-default-score" type="number" placeholder="è«‹è¼¸å…¥é»˜èªåˆ†æ•¸" min="0">
                </div>
                <button class="btn-submit" onclick="addNewGame()">æ–°å¢éŠæˆ²</button>
            </div>

            <!-- CSVæ‰¹é‡å°å…¥éŠæˆ² -->
            <h3 style="margin: 30px 0 15px 0;">æ‰¹é‡å°å…¥éŠæˆ² (CSV)</h3>
            <div class="batch-form">
                <div class="form-group">
                    <label>é¸æ“‡CSVæ–‡ä»¶</label>
                    <input type="file" id="game-csv-file" class="file-input" accept=".csv">
                    <div class="csv-template">
                        CSVæ ¼å¼ç¯„ä¾‹ï¼š<br>
                        game_code,game_name,max_score,default_score<br>
                        GAME001,æ¸¬è©¦éŠæˆ²1,1000,500<br>
                        GAME002,æ¸¬è©¦éŠæˆ²2,2000,1000
                    </div>
                </div>
                <button class="btn-batch" onclick="importGamesFromCSV()">æ‰¹é‡å°å…¥éŠæˆ²</button>
                <div id="game-batch-result" class="batch-result"></div>
            </div>

            <div id="game-msg" class="msg-box"></div>
            <div id="games-list" class="loading">åŠ è¼‰éŠæˆ²åˆ—è¡¨ä¸­...</div>
        </div>

        <!-- ç”¨æˆ¶ç®¡ç†æ¨™ç±¤ -->
        <div id="users" class="tab-content">
            <h2>ç”¨æˆ¶ç®¡ç†</h2>
            
            <!-- å–®å€‹æ–°å¢ç”¨æˆ¶ -->
            <h3 style="margin-bottom: 15px;">æ–°å¢å–®å€‹ç”¨æˆ¶</h3>
            <div class="add-form">
                <div class="form-group">
                    <label>ç”¨æˆ¶å</label>
                    <input id="user-username" type="text" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å">
                </div>
                <button class="btn-submit" onclick="addNewUser()">æ–°å¢ç”¨æˆ¶</button>
            </div>

            <!-- CSVæ‰¹é‡å°å…¥ç”¨æˆ¶ -->
            <h3 style="margin: 30px 0 15px 0;">æ‰¹é‡å°å…¥ç”¨æˆ¶ (CSV)</h3>
            <div class="batch-form">
                <div class="form-group">
                    <label>é¸æ“‡CSVæ–‡ä»¶</label>
                    <input type="file" id="user-csv-file" class="file-input" accept=".csv">
                    <div class="csv-template">
                        CSVæ ¼å¼ç¯„ä¾‹ï¼š<br>
                        username<br>
                        user001<br>
                        user002<br>
                        user003
                    </div>
                </div>
                <button class="btn-batch" onclick="importUsersFromCSV()">æ‰¹é‡å°å…¥ç”¨æˆ¶</button>
                <div id="user-batch-result" class="batch-result"></div>
            </div>

            <div id="user-msg" class="msg-box"></div>
            <div id="users-list" class="loading">åŠ è¼‰ç”¨æˆ¶åˆ—è¡¨ä¸­...</div>
        </div>

        <!-- éŠæˆ²ç´€éŒ„æ¨™ç±¤ (å„ªåŒ–ï¼šä¸‹æ‹‰é¸å–®ç¯©é¸) -->
        <div id="records" class="tab-content">
            <h2>éŠæˆ²ç´€éŒ„ç®¡ç†</h2>
            
            <!-- ç¯©é¸è¡¨å–® (ç”¨æˆ¶å/éŠæˆ²åæ”¹ç‚ºä¸‹æ‹‰é¸å–®) -->
            <div class="filter-form">
                <h3 style="margin-bottom: 15px;">ç¯©é¸èˆ‡æ’åº</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ¶åç¯©é¸</label>
                        <select id="filter-username" class="form-control">
                            <option value="">-- æ‰€æœ‰ç”¨æˆ¶ --</option>
                            <!-- å‹•æ…‹åŠ è¼‰ç”¨æˆ¶åˆ—è¡¨ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>éŠæˆ²åç¯©é¸</label>
                        <select id="filter-gamename" class="form-control">
                            <option value="">-- æ‰€æœ‰éŠæˆ² --</option>
                            <!-- å‹•æ…‹åŠ è¼‰éŠæˆ²åˆ—è¡¨ -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ†æ•¸ç¯„åœ (æœ€å°å€¼)</label>
                        <input type="number" id="filter-score-min" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>åˆ†æ•¸ç¯„åœ (æœ€å¤§å€¼)</label>
                        <input type="number" id="filter-score-max" placeholder="9999" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ’åºæ–¹å¼</label>
                        <select id="sort-by">
                            <option value="scanned_at_desc">æ™‚é–“ (æœ€æ–°åœ¨å‰)</option>
                            <option value="scanned_at_asc">æ™‚é–“ (æœ€èˆŠåœ¨å‰)</option>
                            <option value="score_desc">åˆ†æ•¸ (å¾é«˜åˆ°ä½)</option>
                            <option value="score_asc">åˆ†æ•¸ (å¾ä½åˆ°é«˜)</option>
                            <option value="username_asc">ç”¨æˆ¶å (A-Z)</option>
                            <option value="gamename_asc">éŠæˆ²å (A-Z)</option>
                        </select>
                    </div>
                </div>
                <button class="btn-submit" onclick="filterRecords()">æ‡‰ç”¨ç¯©é¸èˆ‡æ’åº</button>
                <button class="btn-submit" onclick="resetFilter()" style="margin-left: 10px;">é‡ç½®ç¯©é¸æ¢ä»¶</button>
            </div>

            <div id="records-list" class="loading">åŠ è¼‰éŠæˆ²ç´€éŒ„ä¸­...</div>
        </div>

        <!-- æ•¸æ“šå°å‡ºæ¨™ç±¤ -->
        <div id="data-export" class="tab-content">
            <h2>æ•¸æ“šå°å‡º (CSV)</h2>
            <div class="export-form">
                <div class="export-item">
                    <h3>ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆæ•¸æ“š</h3>
                    <p>å°å‡ºæ‰€æœ‰ç”¨æˆ¶çš„ç¸½åˆ†ã€éŠæˆ²æ¬¡æ•¸ç­‰çµ±è¨ˆä¿¡æ¯</p>
                    <button class="btn-export export-btn" onclick="exportUserTotalScores()">å°å‡ºCSVæ–‡ä»¶</button>
                </div>
                <div class="export-item">
                    <h3>éŠæˆ²ç®¡ç†æ•¸æ“š</h3>
                    <p>å°å‡ºæ‰€æœ‰éŠæˆ²çš„åŸºæœ¬ä¿¡æ¯</p>
                    <button class="btn-export export-btn" onclick="exportGames()">å°å‡ºCSVæ–‡ä»¶</button>
                </div>
                <div class="export-item">
                    <h3>ç”¨æˆ¶ç®¡ç†æ•¸æ“š</h3>
                    <p>å°å‡ºæ‰€æœ‰ç”¨æˆ¶çš„åŸºæœ¬ä¿¡æ¯</p>
                    <button class="btn-export export-btn" onclick="exportUsers()">å°å‡ºCSVæ–‡ä»¶</button>
                </div>
                <div class="export-item">
                    <h3>éŠæˆ²ç´€éŒ„æ•¸æ“š</h3>
                    <p>å°å‡ºæ‰€æœ‰éŠæˆ²ç´€éŒ„çš„è©³ç´°ä¿¡æ¯</p>
                    <button class="btn-export export-btn" onclick="exportGameRecords()">å°å‡ºCSVæ–‡ä»¶</button>
                </div>
                <div id="export-result" class="export-result"></div>
            </div>
        </div>

        <!-- æ•¸æ“šç®¡ç†æ¨™ç±¤ (ç§»è‡³æœ€å¾Œï¼Œå¢å¼·åˆªé™¤åŠŸèƒ½) -->
        <div id="data-management" class="tab-content">
            <h2>ç³»çµ±æ•¸æ“šç®¡ç†</h2>
            <div class="warning-box">
                <strong>âš ï¸ è­¦å‘Šï¼š</strong> ä»¥ä¸‹æ“ä½œå°‡åˆªé™¤ç³»çµ±å…§<strong>æ‰€æœ‰æ•¸æ“š</strong>ï¼ˆç”¨æˆ¶/éŠæˆ²/ç´€éŒ„ï¼‰ï¼Œåƒ…ä¿ç•™ç®¡ç†å“¡å¸³è™Ÿï¼æ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼
            </div>
            
            <button class="btn-danger" onclick="confirmDeleteAllData()">åˆªé™¤æ‰€æœ‰ç³»çµ±æ•¸æ“š</button>
            <div id="data-msg" class="msg-box"></div>
            <div id="data-status" class="loading">æ•¸æ“šç‹€æ…‹ï¼šæ­£å¸¸</div>
        </div>
    </div>

    <!-- JSåŠ è¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===== æ ¸å¿ƒä¿®å¾©ï¼šç¨ç«‹çš„è³‡æ–™åº«é…ç½®èˆ‡åˆå§‹åŒ– =====
        const SUPABASE_URL = "YOUR_SUPABASE_URL"; // æ›¿æ›ç‚ºä½ çš„Supabase URL
        const SUPABASE_KEY = "YOUR_SUPABASE_KEY";   // æ›¿æ›ç‚ºä½ çš„Supabase Key
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ¶ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // å…¨å±€è®Šé‡
        let currentUser = null;
        let allGameRecords = [];
        let allUsers = [];       // å­˜å„²æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨
        let allGames = [];       // å­˜å„²æ‰€æœ‰éŠæˆ²åˆ—è¡¨
        
        // ===== ä¿®å¾©ï¼šé é¢åŠ è¼‰åˆå§‹åŒ– =====
        window.onload = async function() {
            try {
                // 1. æª¢æŸ¥ç®¡ç†å“¡ç™»éŒ„ç‹€æ…‹
                currentUser = JSON.parse(localStorage.getItem('qrGameUser'));
                if (!currentUser || currentUser.role !== 'admin') {
                    alert("âš ï¸ è«‹å…ˆä»¥ç®¡ç†å“¡èº«ä»½ç™»éŒ„ï¼");
                    window.location.href = "admin-login.html";
                    return;
                }
                
                // 2. åˆå§‹åŒ–æ•¸æ“šåŠ è¼‰
                await loadDashboardStats();
                await loadUserTotalScoresList();
                
                // 3. é åŠ è¼‰åŸºç¤æ•¸æ“š
                await Promise.all([
                    loadUsersForFilter(),
                    loadGamesForFilter()
                ]);
                
                console.log("âœ… ç®¡ç†å¾Œå°åˆå§‹åŒ–å®Œæˆ");
            } catch (error) {
                console.error("âŒ åˆå§‹åŒ–å¤±æ•—ï¼š", error);
                alert(`åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}\nè«‹åˆ·æ–°é é¢é‡è©¦`);
            }
        };

        // ===== ä¿®å¾©ï¼šç™»å‡ºåŠŸèƒ½ =====
        function adminLogout() {
            try {
                localStorage.removeItem('qrGameUser');
                currentUser = null;
                alert("âœ… ç®¡ç†å“¡å·²æˆåŠŸç™»å‡ºï¼");
                window.location.href = "admin-login.html";
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—ï¼š", error);
                alert(`ç™»å‡ºå¤±æ•—ï¼š${error.message}`);
            }
        }

        // ===== ä¿®å¾©ï¼šæ¨™ç±¤åˆ‡æ›åŠŸèƒ½ =====
        async function switchTab(tabId) {
            try {
                // åˆ‡æ›æ¨™ç±¤æ¨£å¼
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // å»¶é²åŠ è¼‰æ•¸æ“šï¼Œé¿å…å¡é “
                setTimeout(async () => {
                    if (tabId === 'games' && document.getElementById('games-list').classList.contains('loading')) {
                        await loadGamesList();
                    }
                    if (tabId === 'users' && document.getElementById('users-list').classList.contains('loading')) {
                        await loadUsersList();
                    }
                    if (tabId === 'records') {
                        if (document.getElementById('records-list').classList.contains('loading')) {
                            await loadRecordsList();
                        }
                    }
                    if (tabId === 'data-management') {
                        await updateDataStatus();
                    }
                }, 50);
            } catch (error) {
                console.error("åˆ‡æ›æ¨™ç±¤å¤±æ•—ï¼š", error);
                showMessage('score-msg', `åˆ‡æ›æ¨™ç±¤å¤±æ•—ï¼š${error.message}`, false);
            }
        }

        // ===== ç¯©é¸ä¸‹æ‹‰åˆ—è¡¨åŠ è¼‰ =====
        async function loadUsersForFilter() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, username')
                    .order('username');
                
                if (error) throw error;
                
                allUsers = users || [];
                const selectElement = document.getElementById('filter-username');
                selectElement.innerHTML = '<option value="">-- æ‰€æœ‰ç”¨æˆ¶ --</option>';
                
                if (users && users.length > 0) {
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = user.username;
                        selectElement.appendChild(option);
                    });
                }
            } catch (err) {
                console.error("åŠ è¼‰ç”¨æˆ¶ç¯©é¸åˆ—è¡¨å¤±æ•—ï¼š", err);
            }
        }

        async function loadGamesForFilter() {
            try {
                const { data: games, error } = await supabase
                    .from('games')
                    .select('id, game_name')
                    .order('game_name');
                
                if (error) throw error;
                
                allGames = games || [];
                const selectElement = document.getElementById('filter-gamename');
                selectElement.innerHTML = '<option value="">-- æ‰€æœ‰éŠæˆ² --</option>';
                
                if (games && games.length > 0) {
                    games.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.game_name;
                        option.textContent = game.game_name;
                        selectElement.appendChild(option);
                    });
                }
            } catch (err) {
                console.error("åŠ è¼‰éŠæˆ²ç¯©é¸åˆ—è¡¨å¤±æ•—ï¼š", err);
            }
        }

        // ===== é€šç”¨å·¥å…·å‡½æ•¸ =====
        function showMessage(elementId, text, isSuccess = true) {
            const msgBox = document.getElementById(elementId);
            if (!msgBox) return;
            
            msgBox.textContent = text;
            msgBox.className = `msg-box ${isSuccess ? 'success-msg' : 'error-msg'}`;
            msgBox.style.display = 'block';
            
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 3000);
        }

        function showResult(elementId, text, isSuccess = true) {
            const resultBox = document.getElementById(elementId);
            if (!resultBox) return;
            
            resultBox.textContent = text;
            resultBox.className = `${elementId.includes('export') ? 'export-result' : 'batch-result'} ${isSuccess ? 'success-result' : 'error-result'}`;
            resultBox.style.display = 'block';
            
            setTimeout(() => {
                resultBox.style.display = 'none';
            }, 5000);
        }

        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.trim().split('\n');
                    
                    const validLines = lines.filter(line => line.trim() !== '');
                    
                    if (validLines.length === 0) {
                        reject("CSVæ–‡ä»¶ç‚ºç©º");
                        return;
                    }

                    const headers = validLines[0].split(',').map(header => header.trim());
                    const rows = [];

                    for (let i = 1; i < validLines.length; i++) {
                        const line = validLines[i].trim();
                        if (line === '') continue;
                        
                        const values = line.split(',').map(value => value.trim());
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        rows.push(row);
                    }

                    resolve({ headers, rows });
                };
                
                reader.onerror = function() {
                    reject("è®€å–CSVæ–‡ä»¶å¤±æ•—");
                };
                
                reader.readAsText(file);
            });
        }

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.display = "none";
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ===== æ•¸æ“šç®¡ç†åŠŸèƒ½ =====
        async function updateDataStatus() {
            const dataStatus = document.getElementById('data-status');
            try {
                const [usersRes, gamesRes, recordsRes] = await Promise.all([
                    supabase.from('users').select('id'),
                    supabase.from('games').select('id'),
                    supabase.from('game_records').select('id')
                ]);

                if (usersRes.error) throw usersRes.error;
                if (gamesRes.error) throw gamesRes.error;
                if (recordsRes.error) throw recordsRes.error;

                const usersCount = usersRes.data ? usersRes.data.length : 0;
                const gamesCount = gamesRes.data ? gamesRes.data.length : 0;
                const recordsCount = recordsRes.data ? recordsRes.data.length : 0;

                dataStatus.innerHTML = `
                    <div>ğŸ“Š ç•¶å‰æ•¸æ“šç‹€æ…‹ï¼š</div>
                    <div>â€¢ ç”¨æˆ¶æ•¸é‡ï¼š${usersCount}</div>
                    <div>â€¢ éŠæˆ²æ•¸é‡ï¼š${gamesCount}</div>
                    <div>â€¢ éŠæˆ²ç´€éŒ„ï¼š${recordsCount}</div>
                `;
            } catch (err) {
                dataStatus.innerHTML = `<div class="error-msg" style="display:block">âŒ ç²å–æ•¸æ“šç‹€æ…‹å¤±æ•—ï¼š${err.message}</div>`;
                console.error("æ›´æ–°æ•¸æ“šç‹€æ…‹å¤±æ•—ï¼š", err);
            }
        }

        // ===== å¢å¼·ç‰ˆï¼šåˆªé™¤æ‰€æœ‰ç³»çµ±æ•¸æ“š =====
        async function confirmDeleteAllData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç³»çµ±æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰ç”¨æˆ¶ã€éŠæˆ²ã€ç´€éŒ„ï¼Œåƒ…ä¿ç•™ç®¡ç†å“¡å¸³è™Ÿï¼æ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼')) {
                return;
            }

            const dataMsg = document.getElementById('data-msg');
            const dataStatus = document.getElementById('data-status');
            
            try {
                dataStatus.innerHTML = '<div class="loading">æ­£åœ¨åˆªé™¤æ‰€æœ‰ç³»çµ±æ•¸æ“š...</div>';
                
                // 1. åˆªé™¤æ‰€æœ‰éŠæˆ²ç´€éŒ„
                const deleteRecords = await supabase.from('game_records').delete().not('id', 'eq', 0);
                if (deleteRecords.error) throw deleteRecords.error;
                
                // 2. åˆªé™¤æ‰€æœ‰éŠæˆ²
                const deleteGames = await supabase.from('games').delete().not('id', 'eq', 0);
                if (deleteGames.error) throw deleteGames.error;
                
                // 3. åˆªé™¤æ‰€æœ‰æ™®é€šç”¨æˆ¶
                const deleteUsers = await supabase.from('users').delete().not('id', 'eq', 0);
                if (deleteUsers.error) throw deleteUsers.error;
                
                // 4. ç¢ºä¿ç®¡ç†å“¡å¸³è™Ÿå­˜åœ¨ (åˆªé™¤èˆŠçš„å†é‡å»º)
                await supabase.from('admins').delete().eq('username', 'admin');
                const createAdmin = await supabase.from('admins').insert([{ 
                    username: 'admin', 
                    password: 'admin123'  // é»˜èªç®¡ç†å“¡å¯†ç¢¼
                }]);
                if (createAdmin.error) throw createAdmin.error;

                showMessage('data-msg', 'âœ… æ‰€æœ‰ç³»çµ±æ•¸æ“šå·²æˆåŠŸåˆªé™¤ï¼Œç®¡ç†å“¡å¸³è™Ÿå·²é‡å»ºï¼', true);
                
                // æ›´æ–°æ‰€æœ‰åˆ—è¡¨å’Œç‹€æ…‹
                await Promise.all([
                    updateDataStatus(),
                    loadDashboardStats(),
                    loadUserTotalScoresList(),
                    loadGamesList(),
                    loadUsersList(),
                    loadRecordsList(),
                    loadUsersForFilter(),
                    loadGamesForFilter()
                ]);

            } catch (err) {
                showMessage('data-msg', `âŒ æ“ä½œå¤±æ•—ï¼š${err.message}`, false);
                console.error("åˆªé™¤æ•¸æ“šå¤±æ•—ï¼š", err);
                await updateDataStatus();
            }
        }

        // ===== å„€è¡¨æ¿çµ±è¨ˆ =====
        async function loadDashboardStats() {
            try {
                // åŠ è¼‰ç”¨æˆ¶æ•¸é‡
                const usersRes = await supabase.from('users').select('id');
                document.getElementById('total-users').textContent = usersRes.data ? usersRes.data.length : 0;

                // åŠ è¼‰éŠæˆ²æ•¸é‡
                const gamesRes = await supabase.from('games').select('id');
                document.getElementById('total-games').textContent = gamesRes.data ? gamesRes.data.length : 0;

                // åŠ è¼‰ç´€éŒ„æ•¸é‡
                const recordsRes = await supabase.from('game_records').select('id');
                document.getElementById('total-records').textContent = recordsRes.data ? recordsRes.data.length : 0;

                // è¨ˆç®—æœ€é«˜åˆ†
                const allRecordsRes = await supabase.from('game_records').select('user_id, score');
                if (allRecordsRes.data && allRecordsRes.data.length > 0) {
                    const userTotalScores = {};
                    allRecordsRes.data.forEach(record => {
                        userTotalScores[record.user_id] = (userTotalScores[record.user_id] || 0) + record.score;
                    });
                    const highestTotal = Math.max(...Object.values(userTotalScores), 0);
                    document.getElementById('highest-total-score').textContent = highestTotal;
                } else {
                    document.getElementById('highest-total-score').textContent = 0;
                }

            } catch (err) {
                console.error("åŠ è¼‰å„€è¡¨æ¿çµ±è¨ˆå¤±æ•—ï¼š", err);
                showMessage('score-msg', `åŠ è¼‰çµ±è¨ˆæ•¸æ“šå¤±æ•—ï¼š${err.message}`, false);
            }
        }

        // ===== ç”¨æˆ¶ç¸½åˆ†åˆ—è¡¨ =====
        async function loadUserTotalScoresList() {
            const scoresList = document.getElementById('user-scores-list');
            
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, username');
                
                if (error) throw error;
                
                if (!users || users.length === 0) {
                    scoresList.innerHTML = '<div class="loading">æš«ç„¡ç”¨æˆ¶æ•¸æ“š</div>';
                    return;
                }

                const userTotalScores = [];
                for (const user of users) {
                    const { data: records } = await supabase
                        .from('game_records')
                        .select('score, games(game_name, game_code)')
                        .eq('user_id', user.id);
                    
                    let totalScore = 0;
                    let gameCount = 0;
                    let lastGameName = 'ç„¡éŠæˆ²ç´€éŒ„';
                    let lastGameCode = '-';

                    if (records && records.length > 0) {
                        totalScore = records.reduce((sum, record) => sum + record.score, 0);
                        gameCount = records.length;
                        const lastRecord = records[records.length - 1];
                        lastGameName = lastRecord.games?.game_name || 'æœªçŸ¥éŠæˆ²';
                        lastGameCode = lastRecord.games?.game_code || 'æœªçŸ¥ä»£ç¢¼';
                    }

                    userTotalScores.push({
                        user_id: user.id,
                        username: user.username,
                        total_score: totalScore,
                        game_count: gameCount,
                        last_game_name: lastGameName,
                        last_game_code: lastGameCode
                    });
                }

                userTotalScores.sort((a, b) => b.total_score - a.total_score);

                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>ç”¨æˆ¶å</th>
                                <th>ç¸½åˆ†æ•¸</th>
                                <th>åƒèˆ‡éŠæˆ²æ¬¡æ•¸</th>
                                <th>æœ€å¾Œåƒèˆ‡éŠæˆ²</th>
                                <th>éŠæˆ²ä»£ç¢¼</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                userTotalScores.forEach((item, index) => {
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.username}</td>
                            <td>${item.total_score}</td>
                            <td>${item.game_count}</td>
                            <td>${item.last_game_name}</td>
                            <td>${item.last_game_code}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                scoresList.innerHTML = tableHTML;

            } catch (err) {
                scoresList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("åŠ è¼‰ç”¨æˆ¶ç¸½åˆ†å¤±æ•—ï¼š", err);
            }
        }

        // ===== éŠæˆ²ç®¡ç†åŠŸèƒ½ =====
        async function addNewGame() {
            const gameCode = document.getElementById('game-code').value.trim();
            const gameName = document.getElementById('game-name').value.trim();
            const maxScore = parseInt(document.getElementById('game-max-score').value) || 0;
            const defaultScore = parseInt(document.getElementById('game-default-score').value) || 0;

            if (!gameCode) {
                showMessage('game-msg', 'âŒ è«‹è¼¸å…¥éŠæˆ²ä»£ç¢¼ï¼', false);
                return;
            }
            if (!gameName) {
                showMessage('game-msg', 'âŒ è«‹è¼¸å…¥éŠæˆ²åç¨±ï¼', false);
                return;
            }

            try {
                const { error } = await supabase
                    .from('games')
                    .insert([{
                        game_code: gameCode,
                        game_name: gameName,
                        max_score: maxScore,
                        default_score: defaultScore
                    }]);

                if (error) throw error;

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('game-code').value = '';
                document.getElementById('game-name').value = '';
                document.getElementById('game-max-score').value = '';
                document.getElementById('game-default-score').value = '';

                showMessage('game-msg', 'âœ… éŠæˆ²æ–°å¢æˆåŠŸï¼');
                
                // æ›´æ–°ç›¸é—œåˆ—è¡¨
                await Promise.all([
                    loadGamesList(),
                    loadDashboardStats(),
                    loadUserTotalScoresList(),
                    loadGamesForFilter()
                ]);

            } catch (err) {
                showMessage('game-msg', `âŒ æ–°å¢å¤±æ•—ï¼š${err.message}`, false);
                console.error("æ–°å¢éŠæˆ²å¤±æ•—ï¼š", err);
            }
        }

        async function importGamesFromCSV() {
            const fileInput = document.getElementById('game-csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('game-batch-result', 'âŒ è«‹é¸æ“‡CSVæ–‡ä»¶', false);
                return;
            }

            try {
                const { headers, rows } = await parseCSV(file);
                
                // é©—è­‰æ¨™é¡Œ
                const requiredHeaders = ['game_code', 'game_name', 'max_score', 'default_score'];
                const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
                
                if (missingHeaders.length > 0) {
                    showResult('game-batch-result', `âŒ CSVæ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘å¿…è¦æ¬„ä½ ${missingHeaders.join(', ')}`, false);
                    return;
                }

                if (rows.length === 0) {
                    showResult('game-batch-result', 'âŒ CSVæ–‡ä»¶ä¸­æ²’æœ‰æ•¸æ“šè¡Œ', false);
                    return;
                }

                const gamesToImport = [];
                const errors = [];

                rows.forEach((row, index) => {
                    const rowNum = index + 2;
                    
                    if (!row.game_code) {
                        errors.push(`ç¬¬${rowNum}è¡Œï¼šéŠæˆ²ä»£ç¢¼ç‚ºç©º`);
                        return;
                    }
                    if (!row.game_name) {
                        errors.push(`ç¬¬${rowNum}è¡Œï¼šéŠæˆ²åç¨±ç‚ºç©º`);
                        return;
                    }
                    
                    const maxScore = parseInt(row.max_score) || 0;
                    const defaultScore = parseInt(row.default_score) || 0;

                    gamesToImport.push({
                        game_code: row.game_code,
                        game_name: row.game_name,
                        max_score: maxScore,
                        default_score: defaultScore
                    });
                });

                if (errors.length > 0) {
                    showResult('game-batch-result', `âŒ æ•¸æ“šé©—è­‰å¤±æ•—ï¼š${errors.join('ï¼›')}`, false);
                    return;
                }

                const { error } = await supabase
                    .from('games')
                    .insert(gamesToImport);

                if (error) throw error;

                showResult('game-batch-result', `âœ… æˆåŠŸå°å…¥ ${gamesToImport.length} å€‹éŠæˆ²`, true);
                fileInput.value = '';
                
                await Promise.all([
                    loadGamesList(),
                    loadDashboardStats(),
                    loadGamesForFilter()
                ]);

            } catch (err) {
                showResult('game-batch-result', `âŒ å°å…¥å¤±æ•—ï¼š${err.message}`, false);
                console.error("æ‰¹é‡å°å…¥éŠæˆ²å¤±æ•—ï¼š", err);
            }
        }

        async function loadGamesList() {
            const gamesList = document.getElementById('games-list');
            
            try {
                const { data, error } = await supabase
                    .from('games')
                    .select('*')
                    .order('game_code');

                if (error) throw error;

                if (!data || data.length === 0) {
                    gamesList.innerHTML = '<div class="loading">æš«ç„¡éŠæˆ²æ•¸æ“š</div>';
                    return;
                }

                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>éŠæˆ²ä»£ç¢¼</th>
                                <th>éŠæˆ²åç¨±</th>
                                <th>æœ€é«˜åˆ†æ•¸</th>
                                <th>é»˜èªåˆ†æ•¸</th>
                                <th>å‰µå»ºæ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(game => {
                    const createTime = new Date(game.created_at).toLocaleString('zh-TW');
                    tableHTML += `
                        <tr>
                            <td>${game.game_code}</td>
                            <td>${game.game_name}</td>
                            <td>${game.max_score}</td>
                            <td>${game.default_score}</td>
                            <td>${createTime}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                gamesList.innerHTML = tableHTML;

            } catch (err) {
                gamesList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("åŠ è¼‰éŠæˆ²åˆ—è¡¨å¤±æ•—ï¼š", err);
            }
        }

        // ===== ç”¨æˆ¶ç®¡ç†åŠŸèƒ½ =====
        async function addNewUser() {
            const username = document.getElementById('user-username').value.trim();

            if (!username) {
                showMessage('user-msg', 'âŒ è«‹è¼¸å…¥ç”¨æˆ¶åï¼', false);
                return;
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .insert([{ username: username }]);

                if (error) throw error;

                document.getElementById('user-username').value = '';

                showMessage('user-msg', 'âœ… ç”¨æˆ¶æ–°å¢æˆåŠŸï¼');
                
                await Promise.all([
                    loadUsersList(),
                    loadDashboardStats(),
                    loadUserTotalScoresList(),
                    loadUsersForFilter()
                ]);

            } catch (err) {
                showMessage('user-msg', `âŒ æ–°å¢å¤±æ•—ï¼š${err.message}`, false);
                console.error("æ–°å¢ç”¨æˆ¶å¤±æ•—ï¼š", err);
            }
        }

        async function importUsersFromCSV() {
            const fileInput = document.getElementById('user-csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('user-batch-result', 'âŒ è«‹é¸æ“‡CSVæ–‡ä»¶', false);
                return;
            }

            try {
                const { headers, rows } = await parseCSV(file);
                
                if (!headers.includes('username')) {
                    showResult('user-batch-result', 'âŒ CSVæ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘ username æ¬„ä½', false);
                    return;
                }

                if (rows.length === 0) {
                    showResult('user-batch-result', 'âŒ CSVæ–‡ä»¶ä¸­æ²’æœ‰æ•¸æ“šè¡Œ', false);
                    return;
                }

                const usersToImport = [];
                const errors = [];
                const usernameSet = new Set();

                rows.forEach((row, index) => {
                    const rowNum = index + 2;
                    
                    if (!row.username) {
                        errors.push(`ç¬¬${rowNum}è¡Œï¼šç”¨æˆ¶åç‚ºç©º`);
                        return;
                    }
                    
                    if (usernameSet.has(row.username)) {
                        errors.push(`ç¬¬${rowNum}è¡Œï¼šç”¨æˆ¶å ${row.username} é‡è¤‡`);
                        return;
                    }
                    
                    usernameSet.add(row.username);
                    usersToImport.push({ username: row.username });
                });

                if (errors.length > 0) {
                    showResult('user-batch-result', `âŒ æ•¸æ“šé©—è­‰å¤±æ•—ï¼š${errors.join('ï¼›')}`, false);
                    return;
                }

                const { error } = await supabase
                    .from('users')
                    .insert(usersToImport);

                if (error) throw error;

                showResult('user-batch-result', `âœ… æˆåŠŸå°å…¥ ${usersToImport.length} å€‹ç”¨æˆ¶`, true);
                fileInput.value = '';
                
                await Promise.all([
                    loadUsersList(),
                    loadDashboardStats(),
                    loadUsersForFilter()
                ]);

            } catch (err) {
                showResult('user-batch-result', `âŒ å°å…¥å¤±æ•—ï¼š${err.message}`, false);
                console.error("æ‰¹é‡å°å…¥ç”¨æˆ¶å¤±æ•—ï¼š", err);
            }
        }

        async function loadUsersList() {
            const usersList = document.getElementById('users-list');
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('username');

                if (error) throw error;

                if (!data || data.length === 0) {
                    usersList.innerHTML = '<div class="loading">æš«ç„¡ç”¨æˆ¶æ•¸æ“š</div>';
                    return;
                }

                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ¶ID</th>
                                <th>ç”¨æˆ¶å</th>
                                <th>å‰µå»ºæ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(user => {
                    const createTime = new Date(user.created_at).toLocaleString('zh-TW');
                    tableHTML += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${createTime}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                usersList.innerHTML = tableHTML;

            } catch (err) {
                usersList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("åŠ è¼‰ç”¨æˆ¶åˆ—è¡¨å¤±æ•—ï¼š", err);
            }
        }

        // ===== éŠæˆ²ç´€éŒ„ç®¡ç† =====
        async function loadRecordsList() {
            const recordsList = document.getElementById('records-list');
            
            try {
                const { data, error } = await supabase
                    .from('game_records')
                    .select(`
                        *,
                        users(username),
                        games(game_name, game_code)
                    `)
                    .order('scanned_at', { ascending: false });

                if (error) throw error;

                allGameRecords = data || [];

                if (!data || data.length === 0) {
                    recordsList.innerHTML = '<div class="loading">æš«ç„¡éŠæˆ²ç´€éŒ„</div>';
                    return;
                }

                renderRecordsTable(data);

            } catch (err) {
                recordsList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("åŠ è¼‰éŠæˆ²ç´€éŒ„å¤±æ•—ï¼š", err);
            }
        }

        function renderRecordsTable(records) {
            const recordsList = document.getElementById('records-list');
            
            if (!records || records.length === 0) {
                recordsList.innerHTML = '<div class="loading">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„éŠæˆ²ç´€éŒ„</div>';
                return;
            }

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortRecords('username')">ç”¨æˆ¶å</th>
                            <th onclick="sortRecords('gamename')">éŠæˆ²åç¨±</th>
                            <th onclick="sortRecords('gamecode')">éŠæˆ²ä»£ç¢¼</th>
                            <th onclick="sortRecords('score')">åˆ†æ•¸</th>
                            <th onclick="sortRecords('time')">æƒææ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            records.forEach(record => {
                const scanTime = new Date(record.scanned_at).toLocaleString('zh-TW');
                tableHTML += `
                    <tr>
                        <td>${record.users?.username || 'æœªçŸ¥ç”¨æˆ¶'}</td>
                        <td>${record.games?.game_name || 'æœªçŸ¥éŠæˆ²'}</td>
                        <td>${record.games?.game_code || 'æœªçŸ¥ä»£ç¢¼'}</td>
                        <td>${record.score}</td>
                        <td>${scanTime}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            recordsList.innerHTML = tableHTML;
        }

        function filterRecords() {
            if (allGameRecords.length === 0) {
                showResult('export-result', 'âŒ æ²’æœ‰å¯ç”¨çš„éŠæˆ²ç´€éŒ„æ•¸æ“š', false);
                return;
            }

            const usernameFilter = document.getElementById('filter-username').value.trim().toLowerCase();
            const gamenameFilter = document.getElementById('filter-gamename').value.trim().toLowerCase();
            const scoreMin = parseInt(document.getElementById('filter-score-min').value) || 0;
            const scoreMax = parseInt(document.getElementById('filter-score-max').value) || 999999;
            const sortBy = document.getElementById('sort-by').value;

            let filteredRecords = [...allGameRecords];
            
            if (usernameFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    (record.users?.username || '').toLowerCase() === usernameFilter
                );
            }

            if (gamenameFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    (record.games?.game_name || '').toLowerCase() === gamenameFilter
                );
            }

            filteredRecords = filteredRecords.filter(record => 
                record.score >= scoreMin && record.score <= scoreMax
            );

            switch (sortBy) {
                case 'scanned_at_desc':
                    filteredRecords.sort((a, b) => new Date(b.scanned_at) - new Date(a.scanned_at));
                    break;
                case 'scanned_at_asc':
                    filteredRecords.sort((a, b) => new Date(a.scanned_at) - new Date(b.scanned_at));
                    break;
                case 'score_desc':
                    filteredRecords.sort((a, b) => b.score - a.score);
                    break;
                case 'score_asc':
                    filteredRecords.sort((a, b) => a.score - b.score);
                    break;
                case 'username_asc':
                    filteredRecords.sort((a, b) => 
                        (a.users?.username || '').localeCompare(b.users?.username || '')
                    );
                    break;
                case 'gamename_asc':
                    filteredRecords.sort((a, b) => 
                        (a.games?.game_name || '').localeCompare(b.games?.game_name || '')
                    );
                    break;
            }

            renderRecordsTable(filteredRecords);
            showResult('export-result', `âœ… ç¯©é¸å®Œæˆï¼Œå…±æ‰¾åˆ° ${filteredRecords.length} æ¢ç´€éŒ„`, true);
        }

        function resetFilter() {
            document.getElementById('filter-username').value = '';
            document.getElementById('filter-gamename').value = '';
            document.getElementById('filter-score-min').value = '';
            document.getElementById('filter-score-max').value = '';
            document.getElementById('sort-by').value = 'scanned_at_desc';
            
            renderRecordsTable(allGameRecords);
            showResult('export-result', 'âœ… ç¯©é¸æ¢ä»¶å·²é‡ç½®', true);
        }

        function sortRecords(sortType) {
            const sortMap = {
                'username': 'username_asc',
                'gamename': 'gamename_asc',
                'gamecode': 'gamename_asc',
                'score': 'score_desc',
                'time': 'scanned_at_desc'
            };
            
            document.getElementById('sort-by').value = sortMap[sortType];
            filterRecords();
        }

        // ===== æ•¸æ“šå°å‡ºåŠŸèƒ½ =====
        async function exportUserTotalScores() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, username');
                
                if (error) throw error;
                
                if (!users || users.length === 0) {
                    showResult('export-result', 'âŒ æ²’æœ‰å¯ç”¨çš„ç”¨æˆ¶æ•¸æ“š', false);
                    return;
                }

                let csvContent = "æ’å,ç”¨æˆ¶å,ç¸½åˆ†æ•¸,åƒèˆ‡éŠæˆ²æ¬¡æ•¸,æœ€å¾Œåƒèˆ‡éŠæˆ²,éŠæˆ²ä»£ç¢¼\n";
                const userTotalScores = [];

                for (const user of users) {
                    const { data: records } = await supabase
                        .from('game_records')
                        .select('score, games(game_name, game_code)')
                        .eq('user_id', user.id);
                    
                    let totalScore = 0;
                    let gameCount = 0;
                    let lastGameName = 'ç„¡éŠæˆ²ç´€éŒ„';
                    let lastGameCode = '-';

                    if (records && records.length > 0) {
                        totalScore = records.reduce((sum, record) => sum + record.score, 0);
                        gameCount = records.length;
                        const lastRecord = records[records.length - 1];
                        lastGameName = lastRecord.games?.game_name || 'æœªçŸ¥éŠæˆ²';
                        lastGameCode = lastRecord.games?.game_code || 'æœªçŸ¥ä»£ç¢¼';
                    }

                    userTotalScores.push({
                        username: user.username,
                        total_score: totalScore,
                        game_count: gameCount,
                        last_game_name: lastGameName,
                        last_game_code: lastGameCode
                    });
                }

                userTotalScores.sort((a, b) => b.total_score - a.total_score);
                userTotalScores.forEach((item, index) => {
                    csvContent += `${index + 1},${item.username},${item.total_score},${item.game_count},${item.last_game_name},${item.last_game_code}\n`;
                });

                const fileName = `ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆ_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
                downloadCSV(csvContent, fileName);
                
                showResult('export-result', `âœ… æˆåŠŸå°å‡º ${userTotalScores.length} å€‹ç”¨æˆ¶çš„ç¸½åˆ†çµ±è¨ˆæ•¸æ“š`, true);

            } catch (err) {
                showResult('export-result', `âŒ å°å‡ºå¤±æ•—ï¼š${err.message}`, false);
                console.error("å°å‡ºç”¨æˆ¶ç¸½åˆ†å¤±æ•—ï¼š", err);
            }
        }

        async function exportGames() {
            try {
                const { data: games, error } = await supabase
                    .from('games')
                    .select('*')
                    .order('game_code');
                
                if (error) throw error;
                
                if (!games || games.length === 0) {
                    showResult('export-result', 'âŒ æ²’æœ‰å¯ç”¨çš„éŠæˆ²æ•¸æ“š', false);
                    return;
                }

                let csvContent = "éŠæˆ²ä»£ç¢¼,éŠæˆ²åç¨±,æœ€é«˜åˆ†æ•¸,é»˜èªåˆ†æ•¸,å‰µå»ºæ™‚é–“\n";
                games.forEach(game => {
                    const createTime = new Date(game.created_at).toLocaleString('zh-TW');
                    csvContent += `${game.game_code},${game.game_name},${game.max_score},${game.default_score},${createTime}\n`;
                });

                const fileName = `éŠæˆ²ç®¡ç†æ•¸æ“š_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
                downloadCSV(csvContent, fileName);
                
                showResult('export-result', `âœ… æˆåŠŸå°å‡º ${games.length} å€‹éŠæˆ²çš„æ•¸æ“š`, true);

            } catch (err) {
                showResult('export-result', `âŒ å°å‡ºå¤±æ•—ï¼š${err.message}`, false);
                console.error("å°å‡ºéŠæˆ²æ•¸æ“šå¤±æ•—ï¼š", err);
            }
        }

        async function exportUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('username');
                
                if (error) throw error;
                
                if (!users || users.length === 0) {
                    showResult('export-result', 'âŒ æ²’æœ‰å¯ç”¨çš„ç”¨æˆ¶æ•¸æ“š', false);
                    return;
                }

                let csvContent = "ç”¨æˆ¶ID,ç”¨æˆ¶å,å‰µå»ºæ™‚é–“\n";
                users.forEach(user => {
                    const createTime = new Date(user.created_at).toLocaleString('zh-TW');
                    csvContent += `${user.id},${user.username},${createTime}\n`;
                });

                const fileName = `ç”¨æˆ¶ç®¡ç†æ•¸æ“š_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
                downloadCSV(csvContent, fileName);
                
                showResult('export-result', `âœ… æˆåŠŸå°å‡º ${users.length} å€‹ç”¨æˆ¶çš„æ•¸æ“š`, true);

            } catch (err) {
                showResult('export-result', `âŒ å°å‡ºå¤±æ•—ï¼š${err.message}`, false);
                console.error("å°å‡ºç”¨æˆ¶æ•¸æ“šå¤±æ•—ï¼š", err);
            }
        }

        async function exportGameRecords() {
            try {
                const { data: records, error } = await supabase
                    .from('game_records')
                    .select(`
                        *,
                        users(username),
                        games(game_name, game_code)
                    `)
                    .order('scanned_at', { ascending: false });
                
                if (error) throw error;
                
                if (!records || records.length === 0) {
                    showResult('export-result', 'âŒ æ²’æœ‰å¯ç”¨çš„éŠæˆ²ç´€éŒ„æ•¸æ“š', false);
                    return;
                }

                let csvContent = "ç”¨æˆ¶å,éŠæˆ²åç¨±,éŠæˆ²ä»£ç¢¼,åˆ†æ•¸,æƒææ™‚é–“\n";
                records.forEach(record => {
                    const scanTime = new Date(record.scanned_at).toLocaleString('zh-TW');
                    csvContent += `${record.users?.username || 'æœªçŸ¥ç”¨æˆ¶'},${record.games?.game_name || 'æœªçŸ¥éŠæˆ²'},${record.games?.game_code || 'æœªçŸ¥ä»£ç¢¼'},${record.score},${scanTime}\n`;
                });

                const fileName = `éŠæˆ²ç´€éŒ„æ•¸æ“š_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
                downloadCSV(csvContent, fileName);
                
                showResult('export-result', `âœ… æˆåŠŸå°å‡º ${records.length} æ¢éŠæˆ²ç´€éŒ„æ•¸æ“š`, true);

            } catch (err) {
                showResult('export-result', `âŒ å°å‡ºå¤±æ•—ï¼š${err.message}`, false);
                console.error("å°å‡ºéŠæˆ²ç´€éŒ„å¤±æ•—ï¼š", err);
            }
        }
    </script>
</body>
</html>
