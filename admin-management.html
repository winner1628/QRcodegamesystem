<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡å¾Œå° - QRç¢¼éŠæˆ²ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f8fafc; color: #334155; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 2px solid #e2e8f0; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: #dc2626; }
        .btn-logout { padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-logout:hover { background: #b91c1c; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .tab-btn.active { background: #dc2626; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .tab-content.active { display: block; }
        .add-form { display: grid; gap: 15px; max-width: 500px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: 600; }
        .form-group input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-submit { padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-submit:hover { background: #15803d; }
        .btn-danger { padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn-danger:hover { background: #b91c1c; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .data-table th { background: #f1f5f9; font-weight: 600; }
        .data-table tr:hover { background: #f8fafc; }
        .msg-box { padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none; }
        .success-msg { background: #f0fdf4; color: #16a34a; }
        .error-msg { background: #fef2f2; color: #dc2626; }
        .loading { text-align: center; padding: 20px; color: #64748b; }
        .stats-card { background: #f1f5f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; }
        .stat-item { flex: 1; min-width: 200px; background: white; padding: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-item h3 { font-size: 16px; color: #64748b; margin-bottom: 10px; }
        .stat-item .value { font-size: 24px; font-weight: bold; color: #dc2626; }
        .warning-box { background: #fffbeb; border: 1px solid #fbbf24; padding: 15px; border-radius: 6px; margin-bottom: 20px; color: #92400e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ç®¡ç†å“¡å¾Œå°</div>
            <button class="btn-logout" onclick="adminLogout()">ç™»å‡º</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('user-scores')">ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆ</button>
            <button class="tab-btn" onclick="switchTab('games')">éŠæˆ²ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('users')">ç”¨æˆ¶ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('records')">éŠæˆ²ç´€éŒ„</button>
            <button class="tab-btn" onclick="switchTab('data-management')">æ•¸æ“šç®¡ç†</button>
        </div>

        <!-- ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆæ¨™ç±¤ (ä¿®æ”¹ç‚ºç¸½åˆ†) -->
        <div id="user-scores" class="tab-content active">
            <h2>ç”¨æˆ¶ç¸½åˆ†çµ±è¨ˆ</h2>
            <div class="stats-card">
                <div class="stat-item">
                    <h3>ç¸½è¨»å†Šç”¨æˆ¶æ•¸</h3>
                    <div id="total-users" class="value">0</div>
                </div>
                <div class="stat-item">
                    <h3>ç¸½éŠæˆ²æ•¸</h3>
                    <div id="total-games" class="value">0</div>
                </div>
                <div class="stat-item">
                    <h3>ç¸½éŠæˆ²ç´€éŒ„æ•¸</h3>
                    <div id="total-records" class="value">0</div>
                </div>
                <div class="stat-item">
                    <h3>å…¨ç«™ç¸½åˆ†æœ€é«˜</h3>
                    <div id="highest-total-score" class="value">0</div>
                </div>
            </div>

            <div id="score-msg" class="msg-box"></div>
            <div id="user-scores-list" class="loading">åŠ è¼‰ç”¨æˆ¶ç¸½åˆ†æ•¸æ“šä¸­...</div>
        </div>

        <!-- éŠæˆ²ç®¡ç†æ¨™ç±¤ -->
        <div id="games" class="tab-content">
            <h2>æ–°å¢éŠæˆ²</h2>
            <div class="add-form">
                <div class="form-group">
                    <label>éŠæˆ²ä»£ç¢¼ (ä¾‹å¦‚ï¼šGAME001)</label>
                    <input id="game-code" type="text" placeholder="è«‹è¼¸å…¥éŠæˆ²ä»£ç¢¼">
                </div>
                <div class="form-group">
                    <label>éŠæˆ²åç¨±</label>
                    <input id="game-name" type="text" placeholder="è«‹è¼¸å…¥éŠæˆ²åç¨±">
                </div>
                <div class="form-group">
                    <label>æœ€é«˜åˆ†æ•¸</label>
                    <input id="game-max-score" type="number" placeholder="è«‹è¼¸å…¥æœ€é«˜åˆ†æ•¸" min="0">
                </div>
                <div class="form-group">
                    <label>é»˜èªåˆ†æ•¸</label>
                    <input id="game-default-score" type="number" placeholder="è«‹è¼¸å…¥é»˜èªåˆ†æ•¸" min="0">
                </div>
                <button class="btn-submit" onclick="addNewGame()">æ–°å¢éŠæˆ²</button>
            </div>

            <div id="game-msg" class="msg-box"></div>
            <div id="games-list" class="loading">åŠ è¼‰éŠæˆ²åˆ—è¡¨ä¸­...</div>
        </div>

        <!-- ç”¨æˆ¶ç®¡ç†æ¨™ç±¤ -->
        <div id="users" class="tab-content">
            <h2>ç”¨æˆ¶åˆ—è¡¨</h2>
            <div id="users-list" class="loading">åŠ è¼‰ç”¨æˆ¶åˆ—è¡¨ä¸­...</div>
        </div>

        <!-- éŠæˆ²ç´€éŒ„æ¨™ç±¤ -->
        <div id="records" class="tab-content">
            <h2>éŠæˆ²ç´€éŒ„</h2>
            <div id="records-list" class="loading">åŠ è¼‰éŠæˆ²ç´€éŒ„ä¸­...</div>
        </div>

        <!-- æ•¸æ“šç®¡ç†æ¨™ç±¤ (æ–°å¢) -->
        <div id="data-management" class="tab-content">
            <h2>ç³»çµ±æ•¸æ“šç®¡ç†</h2>
            <div class="warning-box">
                <strong>âš ï¸ è­¦å‘Šï¼š</strong> ä»¥ä¸‹æ“ä½œå°‡åˆªé™¤ç³»çµ±å…§æ‰€æœ‰æ•¸æ“šï¼Œè«‹è¬¹æ…æ“ä½œï¼åˆªé™¤å¾Œå°‡è‡ªå‹•å‰µå»ºæ¸¬è©¦ç”¨æˆ¶å’Œæ¸¬è©¦éŠæˆ²ã€‚
            </div>
            
            <button class="btn-danger" onclick="confirmDeleteAllData()">åˆªé™¤æ‰€æœ‰ç³»çµ±æ•¸æ“š</button>
            <div id="data-msg" class="msg-box"></div>
            <div id="data-status" class="loading">æ•¸æ“šç‹€æ…‹ï¼šæ­£å¸¸</div>
        </div>
    </div>

    <!-- JSåŠ è¼‰ (æ‰‹å‹•åˆå§‹åŒ–ï¼Œä¸å½ˆçª—) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // é é¢åŠ è¼‰æ™‚æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        window.onload = async function() {
            // æª¢æŸ¥æ˜¯å¦ç™»å…¥ä¸”ç‚ºç®¡ç†å“¡
            if (!checkAdmin()) return;
            
            // æ‰‹å‹•åˆå§‹åŒ–è³‡æ–™åº« (åªåœ¨æ§åˆ¶å°è¼¸å‡ºï¼Œä¸å½ˆçª—)
            await window.dbManager.init();
            
            // åŠ è¼‰åˆå§‹æ•¸æ“š (å„ªå…ˆåŠ è¼‰ç”¨æˆ¶ç¸½åˆ†)
            loadDashboardStats();
            loadUserTotalScoresList();
        };

        // ç®¡ç†å“¡å°ˆç”¨ç™»å‡ºå‡½æ•¸ (è¿”å›ç®¡ç†å“¡ç™»å…¥é )
        function adminLogout() {
            localStorage.removeItem('qrGameUser');
            window.currentUser = null;
            alert("âœ… ç®¡ç†å“¡å·²æˆåŠŸç™»å‡ºï¼");
            window.location.href = "admin-login.html"; // æ”¹ç‚ºè¿”å›ç®¡ç†å“¡ç™»å…¥é 
        }

        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabId) {
            // ç§»é™¤æ‰€æœ‰activeé¡
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ–°å¢ç•¶å‰activeé¡
            document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // åŠ è¼‰å°æ‡‰æ•¸æ“š
            if (tabId === 'games' && document.getElementById('games-list').classList.contains('loading')) {
                loadGamesList();
            }
            if (tabId === 'users' && document.getElementById('users-list').classList.contains('loading')) {
                loadUsersList();
            }
            if (tabId === 'records' && document.getElementById('records-list').classList.contains('loading')) {
                loadRecordsList();
            }
            if (tabId === 'user-scores' && document.getElementById('user-scores-list').classList.contains('loading')) {
                loadUserTotalScoresList();
            }
            if (tabId === 'data-management') {
                updateDataStatus();
            }
        }

        // é¡¯ç¤ºæ¶ˆæ¯
        function showMessage(elementId, text, isSuccess = true) {
            const msgBox = document.getElementById(elementId);
            msgBox.textContent = text;
            msgBox.className = `msg-box ${isSuccess ? 'success-msg' : 'error-msg'}`;
            msgBox.style.display = 'block';
            
            // 3ç§’å¾Œéš±è—
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 3000);
        }

        // æ›´æ–°æ•¸æ“šç‹€æ…‹ (ä¿®å¾©ï¼šæ­£ç¢ºç²å–æ•¸æ“šé‡)
        async function updateDataStatus() {
            const dataStatus = document.getElementById('data-status');
            try {
                const initOk = await window.dbManager.init();
                if (!initOk) {
                    dataStatus.innerHTML = '<div class="error-msg" style="display:block">âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—</div>';
                    return;
                }

                // ä¿®æ­£ï¼šæ­£ç¢ºç²å–å„è¡¨æ•¸æ“šé‡ (ç§»é™¤ head: true å°è‡´çš„éŒ¯èª¤)
                const [usersRes, gamesRes, recordsRes] = await Promise.all([
                    window.dbManager.client.from('users').select('id'),
                    window.dbManager.client.from('games').select('id'),
                    window.dbManager.client.from('game_records').select('id')
                ]);

                // è¨ˆç®—æ•¸æ“šé‡
                const usersCount = usersRes.data ? usersRes.data.length : 0;
                const gamesCount = gamesRes.data ? gamesRes.data.length : 0;
                const recordsCount = recordsRes.data ? recordsRes.data.length : 0;

                dataStatus.innerHTML = `
                    <div>ğŸ“Š ç•¶å‰æ•¸æ“šç‹€æ…‹ï¼š</div>
                    <div>â€¢ ç”¨æˆ¶æ•¸é‡ï¼š${usersCount}</div>
                    <div>â€¢ éŠæˆ²æ•¸é‡ï¼š${gamesCount}</div>
                    <div>â€¢ éŠæˆ²ç´€éŒ„ï¼š${recordsCount}</div>
                `;
            } catch (err) {
                dataStatus.innerHTML = `<div class="error-msg" style="display:block">âŒ ç²å–æ•¸æ“šç‹€æ…‹å¤±æ•—ï¼š${err.message}</div>`;
                console.error("Update Data Status Error:", err);
            }
        }

        // ç¢ºèªåˆªé™¤æ‰€æœ‰æ•¸æ“š (ä¿®å¾©ï¼šé¿å…é‡è¤‡å‰µå»ºæ¸¬è©¦ç”¨æˆ¶)
        async function confirmDeleteAllData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç³»çµ±æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼åˆªé™¤å¾Œå°‡è‡ªå‹•å‰µå»ºæ¸¬è©¦æ•¸æ“šã€‚')) {
                return;
            }

            const dataMsg = document.getElementById('data-msg');
            const dataStatus = document.getElementById('data-status');
            
            try {
                const initOk = await window.dbManager.init();
                if (!initOk) {
                    showMessage('data-msg', 'âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—ï¼Œç„¡æ³•åŸ·è¡Œåˆªé™¤æ“ä½œ', false);
                    return;
                }

                dataStatus.innerHTML = '<div class="loading">æ­£åœ¨åˆªé™¤æ‰€æœ‰æ•¸æ“š...</div>';
                
                // 1. å…ˆæª¢æŸ¥ä¸¦åˆªé™¤å·²å­˜åœ¨çš„æ¸¬è©¦ç”¨æˆ¶ (é¿å…é‡è¤‡)
                await window.dbManager.client.from('users').delete().eq('username', 'testuser1');
                
                // 2. å…ˆæª¢æŸ¥ä¸¦åˆªé™¤å·²å­˜åœ¨çš„æ¸¬è©¦éŠæˆ² (é¿å…é‡è¤‡)
                await window.dbManager.client.from('games').delete().eq('game_code', 'GAME001');
                
                // 3. åˆªé™¤æ‰€æœ‰éŠæˆ²ç´€éŒ„
                const deleteRecords = await window.dbManager.client.from('game_records').delete().not('id', 'eq', 0);
                if (deleteRecords.error) console.warn("åˆªé™¤éŠæˆ²ç´€éŒ„è­¦å‘Šï¼š", deleteRecords.error.message);
                
                // 4. åˆªé™¤æ‰€æœ‰éŠæˆ² (é™¤äº†å¯èƒ½çš„æ¸¬è©¦éŠæˆ²ï¼Œå·²å–®ç¨åˆªé™¤)
                const deleteGames = await window.dbManager.client.from('games').delete().not('id', 'eq', 0);
                if (deleteGames.error) console.warn("åˆªé™¤éŠæˆ²è­¦å‘Šï¼š", deleteGames.error.message);
                
                // 5. åˆªé™¤æ‰€æœ‰æ™®é€šç”¨æˆ¶ (é™¤äº†ç®¡ç†å“¡ç›¸é—œ)
                const deleteUsers = await window.dbManager.client.from('users').delete().not('id', 'eq', 0);
                if (deleteUsers.error) console.warn("åˆªé™¤ç”¨æˆ¶è­¦å‘Šï¼š", deleteUsers.error.message);

                showMessage('data-msg', 'âœ… æ‰€æœ‰æ•¸æ“šå·²æˆåŠŸåˆªé™¤ï¼Œæ­£åœ¨å‰µå»ºæ¸¬è©¦æ•¸æ“š...');
                
                // 6. å‰µå»ºæ¸¬è©¦ç”¨æˆ¶ (ä¿è­‰å”¯ä¸€æ€§)
                const { data: testUser, error: userError } = await window.dbManager.client
                    .from('users')
                    .insert([{ username: 'testuser1' }])
                    .select()
                    .single();
                
                if (userError) {
                    // å¦‚æœå‰µå»ºå¤±æ•—ï¼Œå˜—è©¦æŸ¥è©¢å·²å­˜åœ¨çš„testuser1
                    const { data: existingUser } = await window.dbManager.client
                        .from('users')
                        .select('id')
                        .eq('username', 'testuser1')
                        .single();
                    
                    if (existingUser) {
                        testUser = existingUser;
                        console.log("ä½¿ç”¨å·²å­˜åœ¨çš„æ¸¬è©¦ç”¨æˆ¶ï¼štestuser1");
                    } else {
                        throw new Error(`å‰µå»ºæ¸¬è©¦ç”¨æˆ¶å¤±æ•—ï¼š${userError.message}`);
                    }
                }

                // 7. å‰µå»ºæ¸¬è©¦éŠæˆ² (ä¿è­‰å”¯ä¸€æ€§)
                const { data: testGame, error: gameError } = await window.dbManager.client
                    .from('games')
                    .insert([{ 
                        game_code: 'GAME001', 
                        game_name: 'æ¸¬è©¦éŠæˆ²1', 
                        max_score: 1000, 
                        default_score: 500 
                    }])
                    .select()
                    .single();
                
                if (gameError) {
                    // å¦‚æœå‰µå»ºå¤±æ•—ï¼Œå˜—è©¦æŸ¥è©¢å·²å­˜åœ¨çš„GAME001
                    const { data: existingGame } = await window.dbManager.client
                        .from('games')
                        .select('id')
                        .eq('game_code', 'GAME001')
                        .single();
                    
                    if (existingGame) {
                        testGame = existingGame;
                        console.log("ä½¿ç”¨å·²å­˜åœ¨çš„æ¸¬è©¦éŠæˆ²ï¼šGAME001");
                    } else {
                        throw new Error(`å‰µå»ºæ¸¬è©¦éŠæˆ²å¤±æ•—ï¼š${gameError.message}`);
                    }
                }

                // 8. å‰µå»ºæ¸¬è©¦ç´€éŒ„ï¼ˆçµ¦æ¸¬è©¦ç”¨æˆ¶åŠ åˆå§‹åˆ†æ•¸ï¼‰
                await window.dbManager.client
                    .from('game_records')
                    .insert([{ 
                        user_id: testUser.id, 
                        game_id: testGame.id, 
                        score: 500 
                    }]);

                showMessage('data-msg', 'âœ… æ‰€æœ‰æ•¸æ“šå·²åˆªé™¤ï¼Œä¸¦æˆåŠŸå‰µå»ºæ¸¬è©¦ç”¨æˆ¶å’Œæ¸¬è©¦éŠæˆ²ï¼');
                
                // æ›´æ–°æ•¸æ“šç‹€æ…‹å’Œå„åˆ—è¡¨
                updateDataStatus();
                loadDashboardStats();
                loadUserTotalScoresList();
                loadGamesList();
                loadUsersList();
                loadRecordsList();

            } catch (err) {
                showMessage('data-msg', `âŒ æ“ä½œå¤±æ•—ï¼š${err.message}`, false);
                console.error("Delete All Data Error:", err);
                // å³ä½¿å‡ºéŒ¯ä¹Ÿæ›´æ–°æ•¸æ“šç‹€æ…‹
                updateDataStatus();
            }
        }

        // åŠ è¼‰å„€è¡¨æ¿çµ±è¨ˆæ•¸æ“š (ä¿®æ”¹ç‚ºç¸½åˆ†çµ±è¨ˆ)
        async function loadDashboardStats() {
            try {
                const initOk = await window.dbManager.init();
                if (!initOk) {
                    showMessage('score-msg', 'âŒ ç„¡æ³•åŠ è¼‰çµ±è¨ˆæ•¸æ“šï¼šè³‡æ–™åº«é€£æ¥å¤±æ•—', false);
                    return;
                }

                // 1. ç²å–ç¸½ç”¨æˆ¶æ•¸ (ä¿®æ­£ï¼šæ­£ç¢ºè¨ˆæ•¸)
                const { data: usersData } = await window.dbManager.client.from('users').select('id');
                document.getElementById('total-users').textContent = usersData ? usersData.length : 0;

                // 2. ç²å–ç¸½éŠæˆ²æ•¸ (ä¿®æ­£ï¼šæ­£ç¢ºè¨ˆæ•¸)
                const { data: gamesData } = await window.dbManager.client.from('games').select('id');
                document.getElementById('total-games').textContent = gamesData ? gamesData.length : 0;

                // 3. ç²å–ç¸½ç´€éŒ„æ•¸ (ä¿®æ­£ï¼šæ­£ç¢ºè¨ˆæ•¸)
                const { data: recordsData } = await window.dbManager.client.from('game_records').select('id');
                document.getElementById('total-records').textContent = recordsData ? recordsData.length : 0;

                // 4. ç²å–å…¨ç«™ç¸½åˆ†æœ€é«˜ (ä¿®æ”¹ç‚ºè¨ˆç®—ç”¨æˆ¶ç¸½åˆ†)
                const { data: allRecords, error: recordsErr } = await window.dbManager.client
                    .from('game_records')
                    .select('user_id, score');
                
                if (!recordsErr && allRecords && allRecords.length > 0) {
                    // è¨ˆç®—æ¯å€‹ç”¨æˆ¶çš„ç¸½åˆ†
                    const userTotalScores = {};
                    allRecords.forEach(record => {
                        if (!userTotalScores[record.user_id]) {
                            userTotalScores[record.user_id] = 0;
                        }
                        userTotalScores[record.user_id] += record.score;
                    });

                    // æ‰¾å‡ºæœ€é«˜ç¸½åˆ†
                    const highestTotal = Math.max(...Object.values(userTotalScores), 0);
                    document.getElementById('highest-total-score').textContent = highestTotal;
                } else {
                    document.getElementById('highest-total-score').textContent = 0;
                }

            } catch (err) {
                console.error("Load Dashboard Stats Error:", err);
            }
        }

        // åŠ è¼‰ç”¨æˆ¶ç¸½åˆ†åˆ—è¡¨ (æ ¸å¿ƒä¿®æ”¹ï¼šè¨ˆç®—æ‰€æœ‰éŠæˆ²åˆ†æ•¸ç´¯åŠ )
        async function loadUserTotalScoresList() {
            const scoresList = document.getElementById('user-scores-list');
            
            try {
                const initOk = await window.dbManager.init();
                if (!initOk) {
                    scoresList.innerHTML = '<div class="error-msg" style="display:block">âŒ ç„¡æ³•åŠ è¼‰æ•¸æ“šï¼šè³‡æ–™åº«é€£æ¥å¤±æ•—</div>';
                    return;
                }

                // Step 1: ç²å–æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨
                const { data: users, error: usersError } = await window.dbManager.client
                    .from('users')
                    .select('id, username');
                
                if (usersError) throw new Error(`ç²å–ç”¨æˆ¶åˆ—è¡¨å¤±æ•—ï¼š${usersError.message}`);
                
                if (!users || users.length === 0) {
                    scoresList.innerHTML = '<div class="loading">æš«ç„¡ç”¨æˆ¶æ•¸æ“š</div>';
                    return;
                }

                // Step 2: è¨ˆç®—æ¯å€‹ç”¨æˆ¶çš„ç¸½åˆ†
                const userTotalScores = [];
                for (const user of users) {
                    // æŸ¥è©¢ç•¶å‰ç”¨æˆ¶çš„æ‰€æœ‰éŠæˆ²ç´€éŒ„
                    const { data: records, error: recordsError } = await window.dbManager.client
                        .from('game_records')
                        .select('score, games(game_name, game_code)')
                        .eq('user_id', user.id);
                    
                    let totalScore = 0;
                    let gameCount = 0;
                    let lastGameName = 'ç„¡éŠæˆ²ç´€éŒ„';
                    let lastGameCode = '-';

                    if (!recordsError && records && records.length > 0) {
                        // è¨ˆç®—ç¸½åˆ†
                        totalScore = records.reduce((sum, record) => sum + record.score, 0);
                        gameCount = records.length;
                        // å–æœ€å¾Œä¸€æ¢ç´€éŒ„çš„éŠæˆ²ä¿¡æ¯
                        const lastRecord = records[records.length - 1];
                        lastGameName = lastRecord.games?.game_name || 'æœªçŸ¥éŠæˆ²';
                        lastGameCode = lastRecord.games?.game_code || 'æœªçŸ¥ä»£ç¢¼';
                    }

                    userTotalScores.push({
                        user_id: user.id,
                        username: user.username,
                        total_score: totalScore,
                        game_count: gameCount,
                        last_game_name: lastGameName,
                        last_game_code: lastGameCode
                    });
                }

                // æŒ‰ç¸½åˆ†é™åºæ’åº
                userTotalScores.sort((a, b) => b.total_score - a.total_score);

                // ç”Ÿæˆè¡¨æ ¼
                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>ç”¨æˆ¶å</th>
                                <th>ç¸½åˆ†æ•¸</th>
                                <th>åƒèˆ‡éŠæˆ²æ¬¡æ•¸</th>
                                <th>æœ€å¾Œåƒèˆ‡éŠæˆ²</th>
                                <th>éŠæˆ²ä»£ç¢¼</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                userTotalScores.forEach((item, index) => {
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.username}</td>
                            <td>${item.total_score}</td>
                            <td>${item.game_count}</td>
                            <td>${item.last_game_name}</td>
                            <td>${item.last_game_code}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                scoresList.innerHTML = tableHTML;

            } catch (err) {
                scoresList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("Load User Total Scores Error:", err);
            }
        }

        // æ–°å¢éŠæˆ²
        async function addNewGame() {
            const gameCode = document.getElementById('game-code').value.trim();
            const gameName = document.getElementById('game-name').value.trim();
            const maxScore = parseInt(document.getElementById('game-max-score').value) || 0;
            const defaultScore = parseInt(document.getElementById('game-default-score').value) || 0;

            // è¡¨å–®é©—è­‰
            if (!gameCode) {
                showMessage('game-msg', 'âŒ è«‹è¼¸å…¥éŠæˆ²ä»£ç¢¼ï¼', false);
                return;
            }
            if (!gameName) {
                showMessage('game-msg', 'âŒ è«‹è¼¸å…¥éŠæˆ²åç¨±ï¼', false);
                return;
            }

            // åˆå§‹åŒ–è³‡æ–™åº«
            const initOk = await window.dbManager.init();
            if (!initOk) {
                showMessage('game-msg', 'âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—ï¼', false);
                return;
            }

            try {
                // æ’å…¥æ•¸æ“š
                const { error } = await window.dbManager.client
                    .from('games')
                    .insert([{
                        game_code: gameCode,
                        game_name: gameName,
                        max_score: maxScore,
                        default_score: defaultScore
                    }]);

                if (error) throw new Error(error.message);

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('game-code').value = '';
                document.getElementById('game-name').value = '';
                document.getElementById('game-max-score').value = '';
                document.getElementById('game-default-score').value = '';

                showMessage('game-msg', 'âœ… éŠæˆ²æ–°å¢æˆåŠŸï¼');
                
                // é‡æ–°åŠ è¼‰åˆ—è¡¨
                loadGamesList();
                // æ›´æ–°å„€è¡¨æ¿çµ±è¨ˆ
                loadDashboardStats();
                loadUserTotalScoresList();

            } catch (err) {
                showMessage('game-msg', `âŒ æ–°å¢å¤±æ•—ï¼š${err.message}`, false);
                console.error("Add Game Error:", err);
            }
        }

        // åŠ è¼‰éŠæˆ²åˆ—è¡¨
        async function loadGamesList() {
            const gamesList = document.getElementById('games-list');
            
            try {
                const initOk = await window.dbManager.init();
                if (!initOk) {
                    gamesList.innerHTML = '<div class="error-msg" style="display:block">âŒ ç„¡æ³•åŠ è¼‰æ•¸æ“šï¼šè³‡æ–™åº«é€£æ¥å¤±æ•—</div>';
                    return;
                }

                const { data, error } = await window.dbManager.client
                    .from('games')
                    .select('*')
                    .order('game_code');

                if (error) throw new Error(error.message);

                if (!data || data.length === 0) {
                    gamesList.innerHTML = '<div class="loading">æš«ç„¡éŠæˆ²æ•¸æ“š</div>';
                    return;
                }

                // ç”Ÿæˆè¡¨æ ¼
                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>éŠæˆ²ä»£ç¢¼</th>
                                <th>éŠæˆ²åç¨±</th>
                                <th>æœ€é«˜åˆ†æ•¸</th>
                                <th>é»˜èªåˆ†æ•¸</th>
                                <th>å‰µå»ºæ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(game => {
                    const createTime = new Date(game.created_at).toLocaleString('zh-TW');
                    tableHTML += `
                        <tr>
                            <td>${game.game_code}</td>
                            <td>${game.game_name}</td>
                            <td>${game.max_score}</td>
                            <td>${game.default_score}</td>
                            <td>${createTime}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                gamesList.innerHTML = tableHTML;

            } catch (err) {
                gamesList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("Load Games Error:", err);
            }
        }

        // åŠ è¼‰ç”¨æˆ¶åˆ—è¡¨
        async function loadUsersList() {
            const usersList = document.getElementById('users-list');
            
            try {
                const initOk = await window.dbManager.init();
                if (!initOk) {
                    usersList.innerHTML = '<div class="error-msg" style="display:block">âŒ ç„¡æ³•åŠ è¼‰æ•¸æ“šï¼šè³‡æ–™åº«é€£æ¥å¤±æ•—</div>';
                    return;
                }

                const { data, error } = await window.dbManager.client
                    .from('users')
                    .select('*')
                    .order('username');

                if (error) throw new Error(error.message);

                if (!data || data.length === 0) {
                    usersList.innerHTML = '<div class="loading">æš«ç„¡ç”¨æˆ¶æ•¸æ“š</div>';
                    return;
                }

                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ¶ID</th>
                                <th>ç”¨æˆ¶å</th>
                                <th>å‰µå»ºæ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(user => {
                    const createTime = new Date(user.created_at).toLocaleString('zh-TW');
                    tableHTML += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${createTime}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                usersList.innerHTML = tableHTML;

            } catch (err) {
                usersList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("Load Users Error:", err);
            }
        }

        // åŠ è¼‰éŠæˆ²ç´€éŒ„
        async function loadRecordsList() {
            const recordsList = document.getElementById('records-list');
            
            try {
                const initOk = await window.dbManager.init();
                if (!initOk) {
                    recordsList.innerHTML = '<div class="error-msg" style="display:block">âŒ ç„¡æ³•åŠ è¼‰æ•¸æ“šï¼šè³‡æ–™åº«é€£æ¥å¤±æ•—</div>';
                    return;
                }

                const { data, error } = await window.dbManager.client
                    .from('game_records')
                    .select(`
                        *,
                        users(username),
                        games(game_name, game_code)
                    `)
                    .order('scanned_at', { ascending: false });

                if (error) throw new Error(error.message);

                if (!data || data.length === 0) {
                    recordsList.innerHTML = '<div class="loading">æš«ç„¡éŠæˆ²ç´€éŒ„</div>';
                    return;
                }

                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ¶å</th>
                                <th>éŠæˆ²åç¨±</th>
                                <th>éŠæˆ²ä»£ç¢¼</th>
                                <th>åˆ†æ•¸</th>
                                <th>æƒææ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(record => {
                    const scanTime = new Date(record.scanned_at).toLocaleString('zh-TW');
                    tableHTML += `
                        <tr>
                            <td>${record.users?.username || 'æœªçŸ¥ç”¨æˆ¶'}</td>
                            <td>${record.games?.game_name || 'æœªçŸ¥éŠæˆ²'}</td>
                            <td>${record.games?.game_code || 'æœªçŸ¥ä»£ç¢¼'}</td>
                            <td>${record.score}</td>
                            <td>${scanTime}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                recordsList.innerHTML = tableHTML;

            } catch (err) {
                recordsList.innerHTML = `<div class="error-msg" style="display:block">âŒ åŠ è¼‰å¤±æ•—ï¼š${err.message}</div>`;
                console.error("Load Records Error:", err);
            }
        }
    </script>
</body>
</html>
