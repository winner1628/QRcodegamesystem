<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數據庫設置 - QR碼遊戲系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #333333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .header p {
            font-size: 1.125rem;
            opacity: 0.9;
        }

        .card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 8px;
            color: #3b82f6;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid #d1d5db;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: bold;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .info-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .info-box h3 {
            color: #0369a1;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .info-box h3 i {
            margin-right: 6px;
        }

        .info-box p {
            color: #0369a1;
            margin-bottom: 4px;
            font-size: 0.875rem;
        }

        .database-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .database-info h4 {
            color: #374151;
            font-size: 0.875rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .database-info p {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            color: #333333;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-label {
            color: #374151;
            font-weight: bold;
            margin-bottom: 6px;
            display: block;
            font-size: 0.875rem;
        }

        .logs-container {
            background: #1f2937;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            color: #e5e7eb;
            font-size: 0.875rem;
            margin-bottom: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-info {
            color: #3b82f6;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .back-link {
            color: #3b82f6;
            text-decoration: none;
            transition: color 0.3s ease;
            display: inline-flex;
            align-items: center;
        }

        .back-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 返回首页链接 -->
        <div class="text-center mb-6">
            <a href="index.html" class="back-link">
                <i class="fa fa-arrow-left mr-2"></i>返回首頁
            </a>
        </div>

        <!-- 页面标题 -->
        <div class="header">
            <h1><i class="fa fa-database mr-3"></i>數據庫設置</h1>
            <p>初始化和重置數據庫，管理系統數據</p>
        </div>

        <!-- 连接状态 -->
        <div class="card">
            <div class="card-title">
                <i class="fa fa-plug"></i>數據庫連接狀態
            </div>
            <div class="database-info">
                <h4><i class="fa fa-server mr-2"></i>Supabase 連接信息</h4>
                <p><strong>URL:</strong> <span id="dbUrl">--</span></p>
                <p><strong>API Key:</strong> <span id="dbKey">--</span></p>
                <p><strong>連接狀態:</strong> <span id="connectionStatus" class="status-indicator status-info">
                    <i class="fa fa-spinner fa-spin mr-2"></i>檢查中...
                </span></p>
            </div>
            <div class="btn-group">
                <button id="testConnectionBtn" class="btn-primary">
                    <i class="fa fa-refresh mr-2"></i>測試連接
                </button>
                <button id="showConfigBtn" class="btn-secondary">
                    <i class="fa fa-eye mr-2"></i>查看配置
                </button>
            </div>
        </div>

        <!-- 数据库操作 -->
        <div class="card">
            <div class="card-title">
                <i class="fa fa-cogs"></i>數據庫操作
            </div>
            
            <div class="info-box">
                <h3><i class="fa fa-info-circle"></i>操作說明</h3>
                <p>• 初始化數據庫：創建默認表結構和初始數據</p>
                <p>• 重置數據庫：清空所有數據，重新初始化</p>
                <p>• 備份數據：導出當前所有數據</p>
                <p>• 還原數據：從備份文件還原數據</p>
            </div>

            <div class="btn-group">
                <button id="initializeBtn" class="btn-primary">
                    <i class="fa fa-play mr-2"></i>初始化數據庫
                </button>
                <button id="resetBtn" class="btn-danger">
                    <i class="fa fa-refresh mr-2"></i>重置數據庫
                </button>
                <button id="backupBtn" class="btn-secondary">
                    <i class="fa fa-download mr-2"></i>備份數據
                </button>
                <button id="restoreBtn" class="btn-secondary">
                    <i class="fa fa-upload mr-2"></i>還原數據
                </button>
            </div>
        </div>

        <!-- 数据库信息 -->
        <div class="card">
            <div class="card-title">
                <i class="fa fa-table"></i>數據庫信息
            </div>
            <div id="databaseInfo">
                <div class="text-center py-4 text-gray-500">
                    <i class="fa fa-spinner fa-spin mr-2"></i>加載數據庫信息...
                </div>
            </div>
        </div>

        <!-- 操作日志 -->
        <div class="card">
            <div class="card-title">
                <i class="fa fa-history"></i>操作日志
            </div>
            <div class="logs-container" id="logsContainer">
                <div class="log-entry log-info">
                    <i class="fa fa-info-circle mr-2"></i>
                    系統啟動，等待操作...
                </div>
            </div>
        </div>

        <!-- 系统信息 -->
        <div class="text-center mt-8 text-sm text-gray-500">
            <p>© 2024 QR碼遊戲系統. 保留所有權利.</p>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // 全局变量
        let dbManager = new DatabaseManager();
        let logs = [];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('数据库设置页面加载完成');
            
            // 显示配置信息
            displayConfig();
            
            // 测试数据库连接
            testConnection();
            
            // 加载数据库信息
            loadDatabaseInfo();
            
            // 绑定事件
            bindEvents();
        });

        // 显示配置信息
        function displayConfig() {
            const config = window.AppConfig;
            document.getElementById('dbUrl').textContent = config.supabase.url;
            document.getElementById('dbKey').textContent = config.supabase.key.substring(0, 10) + '...';
        }

        // 测试数据库连接
        async function testConnection() {
            try {
                addLog('正在測試數據庫連接...', 'info');
                
                const result = await dbManager.testConnection();
                
                const statusElement = document.getElementById('connectionStatus');
                if (result.success) {
                    statusElement.className = 'status-indicator status-success';
                    statusElement.innerHTML = '<i class="fa fa-check-circle mr-2"></i>連接成功';
                    addLog('數據庫連接成功', 'success');
                } else {
                    statusElement.className = 'status-indicator status-error';
                    statusElement.innerHTML = `<i class="fa fa-times-circle mr-2"></i>連接失敗: ${result.error}`;
                    addLog(`數據庫連接失敗: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('测试连接失败:', error);
                addLog(`測試連接過程中出錯: ${error.message}`, 'error');
            }
        }

        // 加载数据库信息
        async function loadDatabaseInfo() {
            try {
                addLog('正在加載數據庫信息...', 'info');
                
                const games = await dbManager.getAllGames();
                const users = await dbManager.getAllUsers();
                const statistics = await dbManager.getGameStatistics();
                
                const infoHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${games.length}</div>
                            <div class="text-sm text-blue-800">遊戲數量</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">${users.length}</div>
                            <div class="text-sm text-green-800">用戶數量</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">${statistics.reduce((sum, stat) => sum + stat.total_records, 0)}</div>
                            <div class="text-sm text-purple-800">記錄數量</div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="font-bold text-gray-700 mb-2">最近的遊戲</h4>
                        <div class="space-y-2">
                            ${games.slice(0, 3).map(game => `
                                <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <span>${game.name}</span>
                                    <span class="text-sm text-gray-500">${new Date(game.created_at).toLocaleDateString('zh-TW')}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">最近的用戶</h4>
                        <div class="space-y-2">
                            ${users.slice(0, 3).map(user => `
                                <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <span>${user.name}</span>
                                    <span class="text-sm text-gray-500">${user.id}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('databaseInfo').innerHTML = infoHtml;
                addLog('數據庫信息加載完成', 'success');
                
            } catch (error) {
                console.error('加载数据库信息失败:', error);
                document.getElementById('databaseInfo').innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <i class="fa fa-exclamation-triangle mr-2"></i>加載數據庫信息失敗
                    </div>
                `;
                addLog(`加載數據庫信息失敗: ${error.message}`, 'error');
            }
        }

        // 绑定事件
        function bindEvents() {
            // 测试连接按钮
            document.getElementById('testConnectionBtn').addEventListener('click', () => {
                testConnection();
            });

            // 显示配置按钮
            document.getElementById('showConfigBtn').addEventListener('click', () => {
                const config = window.AppConfig;
                alert(`Supabase URL: ${config.supabase.url}\nAPI Key: ${config.supabase.key}\n\n默認管理員: ${config.DEFAULT_ADMIN.username}/${config.DEFAULT_ADMIN.password}`);
            });

            // 初始化数据库按钮
            document.getElementById('initializeBtn').addEventListener('click', () => {
                initializeDatabase();
            });

            // 重置数据库按钮
            document.getElementById('resetBtn').addEventListener('click', () => {
                if (confirm('警告！重置數據庫將清空所有數據，此操作不可撤銷。確定要繼續嗎？')) {
                    resetDatabase();
                }
            });

            // 备份数据按钮
            document.getElementById('backupBtn').addEventListener('click', () => {
                backupData();
            });

            // 还原数据按钮
            document.getElementById('restoreBtn').addEventListener('click', () => {
                alert('暫不支持還原功能');
            });
        }

        // 初始化数据库
        async function initializeDatabase() {
            try {
                addLog('正在初始化數據庫...', 'info');
                
                const success = await dbManager.initializeDatabase();
                
                if (success) {
                    addLog('數據庫初始化成功', 'success');
                    alert('數據庫初始化成功！');
                    // 重新加载信息
                    loadDatabaseInfo();
                } else {
                    addLog('數據庫初始化失敗', 'error');
                    alert('數據庫初始化失敗，請檢查日誌');
                }
            } catch (error) {
                console.error('初始化数据库失败:', error);
                addLog(`初始化數據庫出錯: ${error.message}`, 'error');
                alert(`初始化失敗: ${error.message}`);
            }
        }

        // 重置数据库
        async function resetDatabase() {
            try {
                addLog('正在重置數據庫...', 'info');
                
                // 清空所有记录
                await dbManager.clearAllRecords();
                
                // 删除所有用户
                const users = await dbManager.getAllUsers();
                for (const user of users) {
                    await dbManager.deleteUser(user.id);
                }
                
                // 删除所有游戏
                const games = await dbManager.getAllGames();
                for (const game of games) {
                    await dbManager.deleteGame(game.id);
                }
                
                // 重新初始化
                await dbManager.initializeDatabase();
                
                addLog('數據庫重置成功', 'success');
                alert('數據庫重置成功！');
                
                // 重新加载信息
                loadDatabaseInfo();
                
            } catch (error) {
                console.error('重置数据库失败:', error);
                addLog(`重置數據庫出錯: ${error.message}`, 'error');
                alert(`重置失敗: ${error.message}`);
            }
        }

        // 备份数据
        async function backupData() {
            try {
                addLog('正在備份數據...', 'info');
                
                const csv = await dbManager.exportDataToCSV();
                
                if (!csv) {
                    addLog('備份數據為空', 'warning');
                    alert('備份數據為空');
                    return;
                }

                // 创建下载链接
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `qr_game_backup_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog('數據備份成功', 'success');
                
            } catch (error) {
                console.error('备份数据失败:', error);
                addLog(`備份數據出錯: ${error.message}`, 'error');
                alert(`備份失敗: ${error.message}`);
            }
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = {
                timestamp,
                message,
                type
            };
            
            logs.unshift(logEntry);
            if (logs.length > 50) {
                logs = logs.slice(0, 50);
            }
            
            updateLogsDisplay();
        }

        // 更新日志显示
        function updateLogsDisplay() {
            const container = document.getElementById('logsContainer');
            container.innerHTML = logs.map(log => `
                <div class="log-entry log-${log.type}">
                    <i class="fa fa-${
                        log.type === 'success' ? 'check-circle' :
                        log.type === 'error' ? 'times-circle' :
                        log.type === 'warning' ? 'exclamation-triangle' :
                        'info-circle'
                    } mr-2"></i>
                    [${log.timestamp}] ${log.message}
                </div>
            `).join('');
        }

        // 页面卸载时的清理
        window.addEventListener('beforeunload', () => {
            addLog('頁面關閉', 'info');
        });
    </script>
</body>
</html>