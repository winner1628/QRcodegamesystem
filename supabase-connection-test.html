<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase è¿æ¥æµ‹è¯• - QRç¢¼éŠæˆ²ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333333;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .status-info { background-color: #3b82f6; }
        
        .log-entry {
            border-left: 3px solid #667eea;
            padding: 8px 12px;
            margin: 4px 0;
            background-color: rgba(102, 126, 234, 0.05);
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-success { border-left-color: #10b981; }
        .log-error { border-left-color: #ef4444; }
        .log-warning { border-left-color: #f59e0b; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="glass-card p-8 max-w-4xl w-full">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fa fa-database text-blue-600 mr-3"></i>
                Supabase è¿æ¥æµ‹è¯•
            </h1>
            <p class="text-gray-600">æµ‹è¯•ä¸ Supabase PostgreSQL æ•°æ®åº“çš„è¿æ¥å’Œæ•°æ®æŸ¥è¯¢åŠŸèƒ½</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- è¿æ¥ä¿¡æ¯ -->
            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fa fa-info-circle text-blue-600 mr-2"></i>
                    è¿æ¥é…ç½®
                </h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="font-medium">æ•°æ®åº“ URL:</span>
                        <span id="db-url" class="text-blue-600 font-mono truncate max-w-[200px]">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">API Key:</span>
                        <span id="api-key" class="text-blue-600 font-mono truncate max-w-[200px]">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">SDK çŠ¶æ€:</span>
                        <span id="sdk-status" class="font-medium">
                            <span class="status-indicator status-warning"></span>
                            æœªåŠ è½½
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">å®¢æˆ·ç«¯çŠ¶æ€:</span>
                        <span id="client-status" class="font-medium">
                            <span class="status-indicator status-warning"></span>
                            æœªåˆå§‹åŒ–
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- æµ‹è¯•ç»“æœ -->
            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fa fa-check-circle text-green-600 mr-2"></i>
                    è¿æ¥çŠ¶æ€
                </h3>
                <div class="space-y-3">
                    <div class="flex items-center">
                        <span id="connection-status" class="font-medium">
                            <span class="status-indicator status-warning"></span>
                            æœªè¿æ¥
                        </span>
                    </div>
                    <div class="flex items-center">
                        <span id="query-status" class="font-medium">
                            <span class="status-indicator status-warning"></span>
                            æœªæŸ¥è¯¢
                        </span>
                    </div>
                    <div class="flex items-center">
                        <span id="data-status" class="font-medium">
                            <span class="status-indicator status-warning"></span>
                            æ— æ•°æ®
                        </span>
                    </div>
                    <div class="mt-4">
                        <button id="test-connection-btn" class="btn-primary w-full">
                            <i class="fa fa-play-circle mr-2"></i>
                            å¼€å§‹æµ‹è¯•è¿æ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•é¡¹ç›® -->
        <div class="bg-gray-50 p-6 rounded-xl mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fa fa-list-alt text-purple-600 mr-2"></i>
                æµ‹è¯•é¡¹ç›®
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="test-admins-btn" class="btn-primary">
                    <i class="fa fa-user-circle mr-2"></i>
                    æŸ¥è¯¢ç®¡ç†å‘˜è¡¨
                </button>
                <button id="test-users-btn" class="btn-primary">
                    <i class="fa fa-users mr-2"></i>
                    æŸ¥è¯¢ç”¨æˆ·è¡¨
                </button>
                <button id="test-games-btn" class="btn-primary">
                    <i class="fa fa-gamepad mr-2"></i>
                    æŸ¥è¯¢æ¸¸æˆè¡¨
                </button>
                <button id="test-records-btn" class="btn-primary">
                    <i class="fa fa-history mr-2"></i>
                    æŸ¥è¯¢è®°å½•è¡¨
                </button>
            </div>
        </div>
        
        <!-- æµ‹è¯•æ—¥å¿— -->
        <div class="bg-gray-900 text-white p-6 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">
                    <i class="fa fa-terminal mr-2"></i>
                    æµ‹è¯•æ—¥å¿—
                </h3>
                <button id="clear-log-btn" class="text-gray-400 hover:text-white">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
            <div id="test-log" class="max-h-60 overflow-y-auto space-y-2">
                <div class="log-entry">
                    <span class="text-gray-400">[ç³»ç»Ÿ] </span>
                    æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…å¼€å§‹æµ‹è¯•...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç³»ç»Ÿé…ç½®
        window.AppConfig = {
            supabase: {
                url: 'https://vphihqysgdhdnuszybib.supabase.co',
                key: 'sb_publishable_yQ8Br7S-Zk2YdmhtD2dAyg_8Gho4wDS'
            }
        };

        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        document.getElementById('db-url').textContent = window.AppConfig.supabase.url;
        document.getElementById('api-key').textContent = '***' + window.AppConfig.supabase.key.slice(-8);

        let supabaseClient = null;

        // æ—¥å¿—è®°å½•å‡½æ•°
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const typeColors = {
                'success': 'text-green-400',
                'error': 'text-red-400', 
                'warning': 'text-yellow-400',
                'info': 'text-blue-400'
            };
            
            logEntry.innerHTML = `
                <span class="${typeColors[type] || typeColors.info}">[${timestamp}] </span>
                ${message}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const indicators = {
                'success': '<span class="status-indicator status-success"></span>',
                'error': '<span class="status-indicator status-error"></span>',
                'warning': '<span class="status-indicator status-warning"></span>',
                'info': '<span class="status-indicator status-info"></span>'
            };
            
            element.innerHTML = `${indicators[status]}${message}`;
        }

        // æµ‹è¯•è¿æ¥å‡½æ•°
        async function testConnection() {
            try {
                addLog('å¼€å§‹æµ‹è¯• Supabase è¿æ¥...', 'info');
                
                // 1. æ£€æŸ¥ SDK åŠ è½½
                if (typeof createClient === 'undefined') {
                    addLog('âŒ Supabase SDK æœªåŠ è½½', 'error');
                    updateStatus('sdk-status', 'error', 'åŠ è½½å¤±è´¥');
                    return false;
                }
                
                addLog('âœ… Supabase SDK åŠ è½½æˆåŠŸ', 'success');
                updateStatus('sdk-status', 'success', 'å·²åŠ è½½');
                
                // 2. åˆå§‹åŒ–å®¢æˆ·ç«¯
                try {
                    supabaseClient = createClient(
                        window.AppConfig.supabase.url,
                        window.AppConfig.supabase.key
                    );
                    
                    if (supabaseClient && typeof supabaseClient === 'object') {
                        addLog('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                        updateStatus('client-status', 'success', 'å·²åˆå§‹åŒ–');
                        
                        const clientKeys = Object.keys(supabaseClient);
                        addLog(`âœ… å®¢æˆ·ç«¯æ–¹æ³•æ•°é‡: ${clientKeys.length}`, 'success');
                        
                        if (typeof supabaseClient.from === 'function') {
                            addLog('âœ… from æ–¹æ³•å¯ç”¨', 'success');
                        } else {
                            addLog('âŒ from æ–¹æ³•ä¸å¯ç”¨', 'error');
                            updateStatus('client-status', 'error', 'å®¢æˆ·ç«¯ä¸å®Œæ•´');
                            return false;
                        }
                    } else {
                        addLog('âŒ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥', 'error');
                        updateStatus('client-status', 'error', 'åˆå§‹åŒ–å¤±è´¥');
                        return false;
                    }
                } catch (error) {
                    addLog(`âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¼‚å¸¸: ${error.message}`, 'error');
                    updateStatus('client-status', 'error', 'åˆå§‹åŒ–å¼‚å¸¸');
                    return false;
                }
                
                // 3. æµ‹è¯•æ•°æ®åº“è¿æ¥
                try {
                    addLog('å¼€å§‹æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
                    
                    // å°è¯•ç®€å•çš„æŸ¥è¯¢
                    const { data, error } = await supabaseClient.from('admins').select('*').limit(1);
                    
                    if (error) {
                        addLog(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                        updateStatus('connection-status', 'error', 'è¿æ¥å¤±è´¥');
                        addLog(`âŒ é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error)}`, 'error');
                        return false;
                    } else {
                        addLog('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
                        updateStatus('connection-status', 'success', 'å·²è¿æ¥');
                        updateStatus('query-status', 'success', 'æŸ¥è¯¢æˆåŠŸ');
                        
                        if (data && data.length > 0) {
                            addLog(`âœ… æŸ¥è¯¢åˆ° ${data.length} æ¡è®°å½•`, 'success');
                            updateStatus('data-status', 'success', `æœ‰æ•°æ® (${data.length}æ¡)`);
                        } else {
                            addLog('âš ï¸ æŸ¥è¯¢æˆåŠŸä½†æ— æ•°æ®', 'warning');
                            updateStatus('data-status', 'warning', 'æ— æ•°æ®');
                        }
                    }
                } catch (error) {
                    addLog(`âŒ æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸: ${error.message}`, 'error');
                    updateStatus('connection-status', 'error', 'æŸ¥è¯¢å¼‚å¸¸');
                    return false;
                }
                
                addLog('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Supabase è¿æ¥æ­£å¸¸', 'success');
                return true;
                
            } catch (error) {
                addLog(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }

        // æµ‹è¯•ç‰¹å®šè¡¨
        async function testTable(tableName, tableDescription) {
            try {
                addLog(`å¼€å§‹æŸ¥è¯¢ ${tableDescription} (${tableName})...`, 'info');
                
                if (!supabaseClient) {
                    addLog('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆæµ‹è¯•è¿æ¥', 'error');
                    return;
                }
                
                const { data, error } = await supabaseClient.from(tableName).select('*');
                
                if (error) {
                    addLog(`âŒ æŸ¥è¯¢ ${tableDescription} å¤±è´¥: ${error.message}`, 'error');
                } else {
                    addLog(`âœ… æŸ¥è¯¢ ${tableDescription} æˆåŠŸï¼Œæ‰¾åˆ° ${data.length} æ¡è®°å½•`, 'success');
                    
                    if (data.length > 0) {
                        const sampleData = JSON.stringify(data.slice(0, 2), null, 2);
                        addLog(`ğŸ“Š ç¤ºä¾‹æ•°æ®: ${sampleData}`, 'info');
                    } else {
                        addLog(`âš ï¸ ${tableDescription} è¡¨ä¸ºç©º`, 'warning');
                    }
                }
            } catch (error) {
                addLog(`âŒ æŸ¥è¯¢ ${tableDescription} æ—¶å‘ç”Ÿå¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            addLog('é¡µé¢åŠ è½½å®Œæˆï¼ŒSupabase è¿æ¥æµ‹è¯•å‡†å¤‡å°±ç»ª', 'info');
            
            // æµ‹è¯•è¿æ¥æŒ‰é’®
            document.getElementById('test-connection-btn').addEventListener('click', testConnection);
            
            // æ¸…é™¤æ—¥å¿—æŒ‰é’®
            document.getElementById('clear-log-btn').addEventListener('click', function() {
                const logContainer = document.getElementById('test-log');
                logContainer.innerHTML = '<div class="log-entry"><span class="text-gray-400">[ç³»ç»Ÿ] </span>æ—¥å¿—å·²æ¸…é™¤</div>';
                addLog('æ—¥å¿—å·²æ¸…é™¤', 'info');
            });
            
            // æµ‹è¯•è¡¨æŒ‰é’®
            document.getElementById('test-admins-btn').addEventListener('click', function() {
                testTable('admins', 'ç®¡ç†å‘˜è¡¨');
            });
            
            document.getElementById('test-users-btn').addEventListener('click', function() {
                testTable('users', 'ç”¨æˆ·è¡¨');
            });
            
            document.getElementById('test-games-btn').addEventListener('click', function() {
                testTable('games', 'æ¸¸æˆè¡¨');
            });
            
            document.getElementById('test-records-btn').addEventListener('click', function() {
                testTable('game_records', 'æ¸¸æˆè®°å½•è¡¨');
            });
        });
    </script>
</body>
</html>