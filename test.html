<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统测试 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }
        .card {
            @apply bg-white rounded-lg shadow-lg p-6 border border-gray-200;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300;
        }
        .status-success {
            @apply text-green-600;
        }
        .status-error {
            @apply text-red-600;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="container mx-auto">
        <div class="max-w-4xl mx-auto">
            <div class="card mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">系统测试工具</h1>
                <p class="text-gray-600 mb-4">此工具用于测试系统功能是否正常工作</p>
            </div>

            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">数据库连接测试</h2>
                <div id="dbStatus" class="mb-4">
                    <i class="fa fa-spinner fa-spin mr-2"></i>正在测试数据库连接...
                </div>
                <button id="testDbBtn" class="btn-primary">
                    <i class="fa fa-refresh mr-2"></i>重新测试
                </button>
            </div>

            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">管理员账号测试</h2>
                <div class="space-y-4">
                    <div>
                        <label for="testUsername" class="block text-gray-700 mb-2">用户名</label>
                        <input type="text" id="testUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="admin">
                    </div>
                    <div>
                        <label for="testPassword" class="block text-gray-700 mb-2">密码</label>
                        <input type="password" id="testPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="admin123">
                    </div>
                    <button id="testLoginBtn" class="btn-primary">
                        <i class="fa fa-sign-in mr-2"></i>测试登录
                    </button>
                </div>
                <div id="loginStatus" class="mt-4 hidden"></div>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">系统信息</h2>
                <div class="space-y-2">
                    <p><strong>系统版本：</strong> v1.0.0</p>
                    <p><strong>技术栈：</strong> HTML5, JavaScript, Tailwind CSS, Supabase</p>
                    <p><strong>支持浏览器：</strong> Chrome 88+, Firefox 85+, Safari 14+</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 导入模块
        import './js/config.js';
        import './js/database.js';
        import './js/auth.js';

        // 页面加载完成后测试
        document.addEventListener('DOMContentLoaded', async () => {
            await testDatabaseConnection();
            
            // 绑定事件
            document.getElementById('testDbBtn').addEventListener('click', testDatabaseConnection);
            document.getElementById('testLoginBtn').addEventListener('click', testAdminLogin);
        });

        // 测试数据库连接
        async function testDatabaseConnection() {
            const dbStatus = document.getElementById('dbStatus');
            dbStatus.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在测试数据库连接...';
            
            try {
                const db = new DatabaseManager();
                const supabase = window.AppConfig.supabase;
                
                // 测试连接
                const { data, error } = await supabase.from('admins').select('id').limit(1);
                
                if (error) {
                    // 表可能不存在，尝试初始化
                    const initialized = await db.initializeDatabase();
                    if (initialized) {
                        dbStatus.innerHTML = '<i class="fa fa-check-circle mr-2 status-success"></i>数据库连接成功，已初始化默认管理员账号';
                    } else {
                        dbStatus.innerHTML = `<i class="fa fa-times-circle mr-2 status-error"></i>数据库连接失败：${error.message}`;
                    }
                } else {
                    dbStatus.innerHTML = '<i class="fa fa-check-circle mr-2 status-success"></i>数据库连接成功';
                }
            } catch (error) {
                console.error('数据库测试失败:', error);
                dbStatus.innerHTML = `<i class="fa fa-times-circle mr-2 status-error"></i>数据库测试失败：${error.message}`;
            }
        }

        // 测试管理员登录
        async function testAdminLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            const loginStatus = document.getElementById('loginStatus');
            
            loginStatus.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在测试登录...';
            loginStatus.classList.remove('hidden');
            
            try {
                const auth = new AuthManager();
                const result = await auth.adminLogin(username, password);
                
                if (result.success) {
                    loginStatus.innerHTML = '<i class="fa fa-check-circle mr-2 status-success"></i>登录成功！';
                } else {
                    loginStatus.innerHTML = `<i class="fa fa-times-circle mr-2 status-error"></i>登录失败：${result.message}`;
                }
            } catch (error) {
                console.error('登录测试失败:', error);
                loginStatus.innerHTML = `<i class="fa fa-times-circle mr-2 status-error"></i>登录测试失败：${error.message}`;
            }
        }
    </script>
</body>
</html>
