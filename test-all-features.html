<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能测试 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            color: #333;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 30px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px 0 rgba(102, 126, 234, 0.6);
        }

        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.8);
        }

        .test-result {
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="container mx-auto">
        <div class="glass-card p-8 max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">QR码游戏系统 - 功能测试</h1>
                <p class="text-gray-600">验证系统所有功能是否正常工作</p>
            </div>

            <!-- 测试结果显示区域 -->
            <div id="testResults" class="space-y-4 mb-8"></div>

            <!-- 测试按钮 -->
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="testAllBtn" class="btn-primary">
                    <i class="fa fa-check-circle mr-2"></i>测试所有功能
                </button>
                <button id="testAuthBtn" class="btn-primary">
                    <i class="fa fa-user-circle mr-2"></i>测试认证功能
                </button>
                <button id="testDatabaseBtn" class="btn-primary">
                    <i class="fa fa-database mr-2"></i>测试数据库连接
                </button>
                <button id="clearResultsBtn" class="btn-secondary">
                    <i class="fa fa-refresh mr-2"></i>清空结果
                </button>
            </div>

            <!-- 系统信息 -->
            <div class="test-section mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">系统信息</h3>
                <div id="systemInfo" class="space-y-2">
                    <p><strong>系统状态:</strong> <span id="systemStatus">加载中...</span></p>
                    <p><strong>数据库连接:</strong> <span id="dbStatus">未测试</span></p>
                    <p><strong>认证状态:</strong> <span id="authStatus">未测试</span></p>
                    <p><strong>当前用户:</strong> <span id="currentUser">未登录</span></p>
                </div>
            </div>

            <!-- 快速导航 -->
            <div class="test-section mt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">快速导航</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="window.location.href='index.html'" class="btn-secondary w-full">
                        <i class="fa fa-home mr-2"></i>系统首页
                    </button>
                    <button onclick="window.location.href='admin-login.html'" class="btn-secondary w-full">
                        <i class="fa fa-lock mr-2"></i>管理员登录
                    </button>
                    <button onclick="window.location.href='user-login.html'" class="btn-secondary w-full">
                        <i class="fa fa-user mr-2"></i>用户登录
                    </button>
                    <button onclick="window.location.href='setup-database.html'" class="btn-secondary w-full">
                        <i class="fa fa-cog mr-2"></i>数据库设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 导入模块
        import './js/config.js';
        import './js/database.js';
        import './js/auth.js';

        // 全局变量
        let authManager = new AuthManager();
        let dbManager = new DatabaseManager();

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('功能测试页面加载完成');
            updateSystemInfo();
            bindTestEvents();
        });

        // 绑定测试事件
        function bindTestEvents() {
            document.getElementById('testAllBtn').addEventListener('click', testAllFeatures);
            document.getElementById('testAuthBtn').addEventListener('click', testAuthentication);
            document.getElementById('testDatabaseBtn').addEventListener('click', testDatabaseConnection);
            document.getElementById('clearResultsBtn').addEventListener('click', clearTestResults);
        }

        // 更新系统信息
        function updateSystemInfo() {
            document.getElementById('systemStatus').textContent = '运行中';
            document.getElementById('currentUser').textContent = authManager.getCurrentUser() ? 
                authManager.getCurrentUser().name : '未登录';
        }

        // 测试所有功能
        async function testAllFeatures() {
            addTestResult('info', '开始测试所有功能...');
            
            try {
                // 测试数据库连接
                await testDatabaseConnection();
                
                // 测试认证功能
                await testAuthentication();
                
                // 测试用户功能
                await testUserFunctions();
                
                // 测试管理员功能
                await testAdminFunctions();
                
                addTestResult('success', '✅ 所有功能测试完成！系统运行正常');
            } catch (error) {
                addTestResult('error', `❌ 测试过程中出现错误: ${error.message}`);
            }
        }

        // 测试数据库连接
        async function testDatabaseConnection() {
            addTestResult('info', '测试数据库连接...');
            
            try {
                const result = await dbManager.testConnection();
                if (result.success) {
                    addTestResult('success', '✅ 数据库连接成功');
                    document.getElementById('dbStatus').textContent = '已连接';
                } else {
                    addTestResult('error', '❌ 数据库连接失败');
                    document.getElementById('dbStatus').textContent = '连接失败';
                }
            } catch (error) {
                addTestResult('error', `❌ 数据库连接测试失败: ${error.message}`);
                document.getElementById('dbStatus').textContent = '测试失败';
            }
        }

        // 测试认证功能
        async function testAuthentication() {
            addTestResult('info', '测试认证功能...');
            
            try {
                // 测试管理员登录
                const adminLogin = await testAdminLogin();
                if (adminLogin) {
                    addTestResult('success', '✅ 管理员登录功能正常');
                }
                
                // 测试用户登录
                const userLogin = await testUserLogin();
                if (userLogin) {
                    addTestResult('success', '✅ 用户登录功能正常');
                }
                
                document.getElementById('authStatus').textContent = '功能正常';
            } catch (error) {
                addTestResult('error', `❌ 认证功能测试失败: ${error.message}`);
                document.getElementById('authStatus').textContent = '测试失败';
            }
        }

        // 测试管理员登录
        async function testAdminLogin() {
            try {
                const adminResult = await authManager.login('admin', 'admin123');
                if (adminResult.success) {
                    addTestResult('success', '✅ 管理员登录成功');
                    authManager.logout(); // 立即登出
                    return true;
                } else {
                    addTestResult('error', `❌ 管理员登录失败: ${adminResult.message}`);
                    return false;
                }
            } catch (error) {
                addTestResult('error', `❌ 管理员登录测试失败: ${error.message}`);
                return false;
            }
        }

        // 测试用户登录
        async function testUserLogin() {
            try {
                // 尝试获取第一个用户进行测试
                const users = await dbManager.getAllUsers();
                if (users && users.length > 0) {
                    const testUser = users[0];
                    const loginResult = await authManager.loginAsUser(testUser.id);
                    if (loginResult.success) {
                        addTestResult('success', `✅ 用户登录成功: ${testUser.name}`);
                        authManager.logout(); // 立即登出
                        return true;
                    } else {
                        addTestResult('error', `❌ 用户登录失败: ${loginResult.message}`);
                        return false;
                    }
                } else {
                    addTestResult('info', 'ℹ️ 没有用户数据，跳过用户登录测试');
                    return true;
                }
            } catch (error) {
                addTestResult('error', `❌ 用户登录测试失败: ${error.message}`);
                return false;
            }
        }

        // 测试用户功能
        async function testUserFunctions() {
            addTestResult('info', '测试用户功能...');
            
            try {
                // 测试获取游戏列表
                const games = await dbManager.getAllGames();
                addTestResult('success', `✅ 获取游戏列表成功，共 ${games.length} 个游戏`);
                
                // 测试获取用户记录
                const records = await dbManager.getGameRecords();
                addTestResult('success', `✅ 获取游戏记录成功，共 ${records.length} 条记录`);
                
            } catch (error) {
                addTestResult('error', `❌ 用户功能测试失败: ${error.message}`);
            }
        }

        // 测试管理员功能
        async function testAdminFunctions() {
            addTestResult('info', '测试管理员功能...');
            
            try {
                // 测试生成递增ID
                const gameId = await dbManager.generateGameId();
                const userId = await dbManager.generateUserId();
                
                addTestResult('success', `✅ 生成游戏ID成功: ${gameId}`);
                addTestResult('success', `✅ 生成用户ID成功: ${userId}`);
                
            } catch (error) {
                addTestResult('error', `❌ 管理员功能测试失败: ${error.message}`);
            }
        }

        // 添加测试结果
        function addTestResult(type, message) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<i class="fa fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle mr-2"></i>${message}`;
            resultsDiv.appendChild(resultDiv);
            
            // 滚动到最新结果
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // 清空测试结果
        function clearTestResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('dbStatus').textContent = '未测试';
            document.getElementById('authStatus').textContent = '未测试';
            addTestResult('info', '测试结果已清空');
        }
    </script>
</body>
</html>
