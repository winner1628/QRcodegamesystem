<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRéŠæˆ²ç³»çµ± - ç®¡ç†æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="config.js"></script>
    <style>
        .nav-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover {
            background-color: #4b5563;
        }
        .nav-item.active {
            background-color: #3b82f6;
            color: white;
        }
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex">
    <!-- å´é‚Šå°èˆª -->
    <div class="w-64 bg-gray-800 text-white flex-shrink-0">
        <div class="p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold flex items-center">
                <i class="fa fa-qrcode mr-2"></i>
                ç®¡ç†æ§åˆ¶å°
            </h1>
        </div>
        
        <!-- å°èˆªèœå–® - ä½¿ç”¨divå’Œonclick -->
        <div class="mt-4">
            <div class="nav-item active px-4 py-3 flex items-center" onclick="switchPage('dashboard')">
                <i class="fa fa-dashboard w-6"></i>
                <span>æ•¸æ“šæ¦‚è¦½</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center" onclick="switchPage('games')">
                <i class="fa fa-gamepad w-6"></i>
                <span>éŠæˆ²ç®¡ç†</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center" onclick="switchPage('users')">
                <i class="fa fa-users w-6"></i>
                <span>ç”¨æˆ¶ç®¡ç†</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center" onclick="switchPage('records')">
                <i class="fa fa-history w-6"></i>
                <span>è¨˜éŒ„æŸ¥è©¢</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center" onclick="switchPage('export')">
                <i class="fa fa-download w-6"></i>
                <span>æ•¸æ“šå°å‡º</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center" onclick="switchPage('settings')">
                <i class="fa fa-cog w-6"></i>
                <span>ç³»çµ±è¨­ç½®</span>
            </div>
        </div>
        
        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <div class="absolute bottom-0 w-64 p-4 border-t border-gray-700">
            <button onclick="logout()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">
                <i class="fa fa-sign-out mr-2"></i> ç™»å‡ºç³»çµ±
            </button>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="flex-1 flex flex-col">
        <!-- é ‚éƒ¨æ¨™é¡Œ -->
        <header class="bg-white shadow-sm p-4">
            <h2 id="pageTitle" class="text-xl font-semibold text-gray-800">æ•¸æ“šæ¦‚è¦½</h2>
        </header>
        
        <!-- å…§å®¹å€åŸŸ -->
        <main class="flex-1 p-6 overflow-y-auto">
            <!-- æ•¸æ“šæ¦‚è¦½é  -->
            <div id="dashboard" class="page-content active">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fa fa-gamepad text-blue-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">å·²è¨­ç½®éŠæˆ²</p>
                                <p class="text-2xl font-bold" id="totalGames">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fa fa-users text-green-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">åƒèˆ‡ç”¨æˆ¶</p>
                                <p class="text-2xl font-bold" id="totalUsers">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i class="fa fa-play-circle text-yellow-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">ä»Šæ—¥åƒèˆ‡æ¬¡æ•¸</p>
                                <p class="text-2xl font-bold" id="todayPlays">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="bg-red-100 p-3 rounded-full">
                                <i class="fa fa-gift text-red-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">ç¦®å“ç™¼æ”¾</p>
                                <p class="text-2xl font-bold" id="totalGifts">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">å¿«é€Ÿæ“ä½œ</h3>
                        <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <i class="fa fa-refresh mr-2"></i>åˆ·æ–°æ•¸æ“š
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="switchPage('games')" class="border p-4 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-plus-circle text-blue-600 text-xl mr-3"></i>
                            <span>æ–°å¢éŠæˆ²</span>
                        </button>
                        <button onclick="switchPage('users')" class="border p-4 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-user-plus text-green-600 text-xl mr-3"></i>
                            <span>ç®¡ç†ç”¨æˆ¶</span>
                        </button>
                        <button onclick="switchPage('records')" class="border p-4 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-search text-yellow-600 text-xl mr-3"></i>
                            <span>æŸ¥è©¢è¨˜éŒ„</span>
                        </button>
                        <button onclick="switchPage('export')" class="border p-4 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-download text-purple-600 text-xl mr-3"></i>
                            <span>å°å‡ºæ•¸æ“š</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- éŠæˆ²ç®¡ç†é  -->
            <div id="games" class="page-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold">éŠæˆ²ç®¡ç†</h3>
                        <button onclick="showAddGameModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <i class="fa fa-plus mr-2"></i>æ–°å¢éŠæˆ²
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">éŠæˆ²åç¨±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">æ”¤ä½è™Ÿç¢¼</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">åƒèˆ‡æ¬¡æ•¸</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">ç¦®å“æ•¸é‡</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">ç‹€æ…‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="gamesTableBody">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500 border">
                                        <i class="fa fa-spinner fa-spin mr-2"></i>æ­£åœ¨åŠ è¼‰æ•¸æ“š...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ¶ç®¡ç†é  -->
            <div id="users" class="page-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">ç”¨æˆ¶ç®¡ç†</h3>
                    <div id="usersContent">
                        <p class="text-gray-600">æ­£åœ¨åŠ è¼‰ç”¨æˆ¶æ•¸æ“š...</p>
                    </div>
                </div>
            </div>

            <!-- è¨˜éŒ„æŸ¥è©¢é  -->
            <div id="records" class="page-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">è¨˜éŒ„æŸ¥è©¢</h3>
                    <div id="recordsContent">
                        <p class="text-gray-600">æ­£åœ¨åŠ è¼‰è¨˜éŒ„æ•¸æ“š...</p>
                    </div>
                </div>
            </div>

            <!-- æ•¸æ“šå°å‡ºé  -->
            <div id="export" class="page-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">æ•¸æ“šå°å‡º</h3>
                    <div class="space-y-4">
                        <button onclick="exportGamesData()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                            <i class="fa fa-file-text-o mr-2"></i> å°å‡ºéŠæˆ²æ•¸æ“š (CSV)
                        </button>
                        <button onclick="exportUsersData()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fa fa-users mr-2"></i> å°å‡ºç”¨æˆ¶æ•¸æ“š (CSV)
                        </button>
                        <button onclick="exportRecordsData()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center">
                            <i class="fa fa-history mr-2"></i> å°å‡ºè¨˜éŒ„æ•¸æ“š (CSV)
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±è¨­ç½®é  -->
            <div id="settings" class="page-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">ç³»çµ±è¨­ç½®</h3>
                    <div id="settingsContent">
                        <p class="text-gray-600">æ­£åœ¨åŠ è¼‰è¨­ç½®...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ–°å¢éŠæˆ²æ¨¡æ…‹æ¡† -->
    <div id="addGameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">æ–°å¢éŠæˆ²</h3>
            <form id="addGameForm" class="space-y-4">
                <div>
                    <label for="gameName" class="block text-sm font-medium text-gray-700">éŠæˆ²åç¨±</label>
                    <input type="text" id="gameName" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="boothNumber" class="block text-sm font-medium text-gray-700">æ”¤ä½è™Ÿç¢¼</label>
                    <input type="text" id="boothNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="gameDescription" class="block text-sm font-medium text-gray-700">éŠæˆ²æè¿°</label>
                    <textarea id="gameDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideAddGameModal()" class="px-4 py-2 bg-gray-600 text-white rounded">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let supabase;
        let games = [];
        let users = [];
        let records = [];
        let currentPage = 'dashboard';

        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ç®¡ç†æ§åˆ¶å°åˆå§‹åŒ–ä¸­...');
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
            if (!isLoggedIn) {
                alert('è«‹å…ˆç™»å…¥ç³»çµ±');
                window.location.href = 'admin.html';
                return;
            }
            
            // åˆå§‹åŒ–Supabase
            initializeSupabase();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
            initEventListeners();
            
            // åŠ è¼‰åˆå§‹æ•¸æ“š
            loadInitialData();
            
            console.log('âœ… ç®¡ç†æ§åˆ¶å°åˆå§‹åŒ–å®Œæˆï¼');
        });

        // åˆå§‹åŒ–Supabase
        function initializeSupabase() {
            try {
                if (!window.config || !window.config.supabase) {
                    throw new Error('é…ç½®æ–‡ä»¶æœªåŠ è¼‰æˆ–é…ç½®ä¸å®Œæ•´');
                }
                
                supabase = createClient(window.config.supabase.url, window.config.supabase.anonKey);
                console.log('âœ… Supabaseåˆå§‹åŒ–æˆåŠŸï¼');
                
                // æ¸¬è©¦é€£æ¥
                testConnection();
                
            } catch (error) {
                console.error('âŒ Supabaseåˆå§‹åŒ–å¤±æ•—:', error);
                alert('æ•¸æ“šåº«é€£æ¥å¤±æ•—: ' + error.message);
            }
        }

        // æ¸¬è©¦æ•¸æ“šåº«é€£æ¥
        async function testConnection() {
            try {
                const { data, error } = await supabase.from('games').select('*').limit(1);
                if (error) {
                    console.warn('âš ï¸ é€£æ¥æ¸¬è©¦è­¦å‘Š:', error.message);
                } else {
                    console.log('âœ… æ•¸æ“šåº«é€£æ¥æ¸¬è©¦æˆåŠŸï¼Œæ‰¾åˆ°', data.length, 'æ¢è¨˜éŒ„');
                }
            } catch (error) {
                console.error('âŒ é€£æ¥æ¸¬è©¦å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        function initEventListeners() {
            // æ–°å¢éŠæˆ²è¡¨å–®æäº¤
            document.getElementById('addGameForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addGame();
            });
            
            console.log('âœ… äº‹ä»¶ç›£è½å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // åŠ è¼‰åˆå§‹æ•¸æ“š
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadGames(),
                    loadUsers(),
                    loadRecords()
                ]);
                updateStatistics();
            } catch (error) {
                console.error('âŒ åŠ è¼‰åˆå§‹æ•¸æ“šå¤±æ•—:', error);
            }
        }

        // åˆ‡æ›é é¢
        function switchPage(pageName) {
            console.log('ğŸ”„ åˆ‡æ›åˆ°é é¢:', pageName);
            
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // é¡¯ç¤ºç›®æ¨™é é¢
            const targetPage = document.getElementById(pageName);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageName;
            }
            
            // æ›´æ–°å°èˆªé«˜äº®
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // é«˜äº®ç•¶å‰å°èˆªé …
            const targetNavItem = event.currentTarget;
            if (targetNavItem) {
                targetNavItem.classList.add('active');
            }
            
            // æ›´æ–°é é¢æ¨™é¡Œ
            const pageTitles = {
                'dashboard': 'æ•¸æ“šæ¦‚è¦½',
                'games': 'éŠæˆ²ç®¡ç†',
                'users': 'ç”¨æˆ¶ç®¡ç†',
                'records': 'è¨˜éŒ„æŸ¥è©¢',
                'export': 'æ•¸æ“šå°å‡º',
                'settings': 'ç³»çµ±è¨­ç½®'
            };
            
            document.getElementById('pageTitle').textContent = pageTitles[pageName] || 'æ•¸æ“šæ¦‚è¦½';
            
            // æ ¹æ“šé é¢åŠ è¼‰ç›¸æ‡‰æ•¸æ“š
            if (pageName === 'games') {
                loadGames();
            } else if (pageName === 'users') {
                loadUsers();
            } else if (pageName === 'records') {
                loadRecords();
            }
            
            console.log('âœ… æˆåŠŸåˆ‡æ›åˆ°:', pageTitles[pageName]);
        }

        // åŠ è¼‰éŠæˆ²æ•¸æ“š
        async function loadGames() {
            try {
                const { data, error } = await supabase.from('games').select('*');
                if (error) {
                    console.error('âŒ åŠ è¼‰éŠæˆ²æ•¸æ“šå¤±æ•—:', error);
                    games = [];
                } else {
                    games = data || [];
                    console.log('âœ… æˆåŠŸåŠ è¼‰', games.length, 'å€‹éŠæˆ²');
                }
                
                renderGamesTable();
            } catch (error) {
                console.error('âŒ åŠ è¼‰éŠæˆ²æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                games = [];
                renderGamesTable();
            }
        }

        // æ¸²æŸ“éŠæˆ²è¡¨æ ¼
        function renderGamesTable() {
            const tbody = document.getElementById('gamesTableBody');
            tbody.innerHTML = '';
            
            if (games.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 border">
                            <i class="fa fa-info-circle mr-2"></i>æš«ç„¡éŠæˆ²æ•¸æ“š
                        </td>
                    </tr>
                `;
                return;
            }
            
            games.forEach(game => {
                const statusBadge = game.status === 'active' 
                    ? '<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">æ­£å¸¸</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">ç¶­è­·ä¸­</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 border">${game.name}</td>
                    <td class="px-6 py-4 border">${game.booth_number}</td>
                    <td class="px-6 py-4 border">${game.plays || 0}</td>
                    <td class="px-6 py-4 border">${game.gifts || 0}</td>
                    <td class="px-6 py-4 border">${statusBadge}</td>
                    <td class="px-6 py-4 border">
                        <button onclick="editGame('${game.id}')" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fa fa-edit"></i> ç·¨è¼¯
                        </button>
                        <button onclick="deleteGame('${game.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fa fa-trash"></i> åˆªé™¤
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // åŠ è¼‰ç”¨æˆ¶æ•¸æ“š
        async function loadUsers() {
            try {
                const { data, error } = await supabase.from('users').select('*');
                if (error) {
                    console.error('âŒ åŠ è¼‰ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
                    users = [];
                } else {
                    users = data || [];
                    console.log('âœ… æˆåŠŸåŠ è¼‰', users.length, 'å€‹ç”¨æˆ¶');
                }
                
                renderUsersContent();
            } catch (error) {
                console.error('âŒ åŠ è¼‰ç”¨æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                users = [];
                renderUsersContent();
            }
        }

        // æ¸²æŸ“ç”¨æˆ¶å…§å®¹
        function renderUsersContent() {
            const content = document.getElementById('usersContent');
            content.innerHTML = `<p class="text-gray-600">æ‰¾åˆ° ${users.length} å€‹ç”¨æˆ¶</p>`;
        }

        // åŠ è¼‰è¨˜éŒ„æ•¸æ“š
        async function loadRecords() {
            try {
                const { data, error } = await supabase.from('game_records').select('*');
                if (error) {
                    console.error('âŒ åŠ è¼‰è¨˜éŒ„æ•¸æ“šå¤±æ•—:', error);
                    records = [];
                } else {
                    records = data || [];
                    console.log('âœ… æˆåŠŸåŠ è¼‰', records.length, 'æ¢è¨˜éŒ„');
                }
                
                renderRecordsContent();
            } catch (error) {
                console.error('âŒ åŠ è¼‰è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                records = [];
                renderRecordsContent();
            }
        }

        // æ¸²æŸ“è¨˜éŒ„å…§å®¹
        function renderRecordsContent() {
            const content = document.getElementById('recordsContent');
            content.innerHTML = `<p class="text-gray-600">æ‰¾åˆ° ${records.length} æ¢è¨˜éŒ„</p>`;
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStatistics() {
            document.getElementById('totalGames').textContent = games.length;
            document.getElementById('totalUsers').textContent = users.length;
            
            const totalPlays = games.reduce((sum, game) => sum + (game.plays || 0), 0);
            const totalGifts = games.reduce((sum, game) => sum + (game.gifts || 0), 0);
            
            document.getElementById('todayPlays').textContent = totalPlays;
            document.getElementById('totalGifts').textContent = totalGifts;
        }

        // åˆ·æ–°æ•¸æ“š
        async function refreshData() {
            console.log('ğŸ”„ åˆ·æ–°æ•¸æ“š...');
            await loadInitialData();
            showToast('æ•¸æ“šåˆ·æ–°æˆåŠŸï¼');
        }

        // é¡¯ç¤ºæ–°å¢éŠæˆ²æ¨¡æ…‹æ¡†
        function showAddGameModal() {
            document.getElementById('addGameModal').classList.remove('hidden');
        }

        // éš±è—æ–°å¢éŠæˆ²æ¨¡æ…‹æ¡†
        function hideAddGameModal() {
            document.getElementById('addGameModal').classList.add('hidden');
            document.getElementById('addGameForm').reset();
        }

        // æ–°å¢éŠæˆ²
        async function addGame() {
            try {
                const name = document.getElementById('gameName').value.trim();
                const boothNumber = document.getElementById('boothNumber').value.trim();
                const description = document.getElementById('gameDescription').value.trim();
                
                if (!name || !boothNumber) {
                    alert('è«‹å¡«å¯«å¿…å¡«å­—æ®µï¼');
                    return;
                }
                
                const newGame = {
                    id: 'G' + Date.now().toString().slice(-6),
                    name,
                    booth_number: boothNumber,
                    description,
                    status: 'active',
                    plays: 0,
                    gifts: 0,
                    created_at: new Date().toISOString()
                };
                
                const { error } = await supabase.from('games').insert(newGame);
                if (error) {
                    throw error;
                }
                
                console.log('âœ… æ–°å¢éŠæˆ²æˆåŠŸ:', newGame.name);
                hideAddGameModal();
                await loadGames();
                updateStatistics();
                showToast('æ–°å¢éŠæˆ²æˆåŠŸï¼');
                
            } catch (error) {
                console.error('âŒ æ–°å¢éŠæˆ²å¤±æ•—:', error);
                alert('æ–°å¢éŠæˆ²å¤±æ•—: ' + error.message);
            }
        }

        // ç·¨è¼¯éŠæˆ²
        function editGame(gameId) {
            console.log('ç·¨è¼¯éŠæˆ²:', gameId);
            alert('ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        // åˆªé™¤éŠæˆ²
        async function deleteGame(gameId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹éŠæˆ²å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const { error } = await supabase.from('games').delete().eq('id', gameId);
                if (error) {
                    throw error;
                }
                
                console.log('âœ… åˆªé™¤éŠæˆ²æˆåŠŸ:', gameId);
                await loadGames();
                updateStatistics();
                showToast('åˆªé™¤éŠæˆ²æˆåŠŸï¼');
                
            } catch (error) {
                console.error('âŒ åˆªé™¤éŠæˆ²å¤±æ•—:', error);
                alert('åˆªé™¤éŠæˆ²å¤±æ•—: ' + error.message);
            }
        }

        // å°å‡ºéŠæˆ²æ•¸æ“š
        function exportGamesData() {
            if (games.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥å°å‡ºï¼');
                return;
            }
            
            const csvContent = convertToCSV(games);
            downloadCSV(csvContent, 'games_data.csv');
            showToast('éŠæˆ²æ•¸æ“šå°å‡ºæˆåŠŸï¼');
        }

        // å°å‡ºç”¨æˆ¶æ•¸æ“š
        function exportUsersData() {
            if (users.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥å°å‡ºï¼');
                return;
            }
            
            const csvContent = convertToCSV(users);
            downloadCSV(csvContent, 'users_data.csv');
            showToast('ç”¨æˆ¶æ•¸æ“šå°å‡ºæˆåŠŸï¼');
        }

        // å°å‡ºè¨˜éŒ„æ•¸æ“š
        function exportRecordsData() {
            if (records.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥å°å‡ºï¼');
                return;
            }
            
            const csvContent = convertToCSV(records);
            downloadCSV(csvContent, 'records_data.csv');
            showToast('è¨˜éŒ„æ•¸æ“šå°å‡ºæˆåŠŸï¼');
        }

        // å°‡æ•¸æ“šè½‰æ›ç‚ºCSVæ ¼å¼
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [];
            
            // æ·»åŠ æ¨™é¡Œè¡Œ
            csvRows.push(headers.join(','));
            
            // æ·»åŠ æ•¸æ“šè¡Œ
            for (const row of data) {
                const values = headers.map(header => {
                    const value = row[header] ?? '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }
            
            return csvRows.join('\n');
        }

        // ä¸‹è¼‰CSVæ–‡ä»¶
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // é¡¯ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ')) {
                sessionStorage.removeItem('adminLoggedIn');
                window.location.href = 'admin.html';
            }
        }

        // å°‡å‡½æ•¸ç¶å®šåˆ°å…¨å±€ä½œç”¨åŸŸ
        window.switchPage = switchPage;
        window.refreshData = refreshData;
        window.showAddGameModal = showAddGameModal;
        window.hideAddGameModal = hideAddGameModal;
        window.editGame = editGame;
        window.deleteGame = deleteGame;
        window.exportGamesData = exportGamesData;
        window.exportUsersData = exportUsersData;
        window.exportRecordsData = exportRecordsData;
        window.logout = logout;
    </script>
</body>
</html>