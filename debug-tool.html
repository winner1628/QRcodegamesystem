<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详细调试工具 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }
        .card {
            @apply bg-white rounded-lg shadow-lg p-6 border border-gray-200;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300;
        }
        .log-container {
            @apply bg-gray-100 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm;
        }
        .log-entry {
            @apply mb-1;
        }
        .log-error {
            @apply text-red-600;
        }
        .log-success {
            @apply text-green-600;
        }
        .log-info {
            @apply text-blue-600;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="container mx-auto">
        <div class="max-w-4xl mx-auto">
            <div class="card mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">详细调试工具</h1>
                <p class="text-gray-600 mb-4">此工具用于详细诊断系统问题</p>
            </div>

            <!-- 日志显示区域 -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">调试日志</h2>
                <div id="debugLog" class="log-container">
                    <div class="log-entry">系统启动中...</div>
                </div>
            </div>

            <!-- 测试按钮 -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">测试操作</h2>
                <div class="space-y-4">
                    <button id="testConnectionBtn" class="btn-primary">
                        <i class="fa fa-database mr-2"></i>测试数据库连接
                    </button>
                    <button id="initializeDbBtn" class="btn-secondary">
                        <i class="fa fa-refresh mr-2"></i>初始化数据库
                    </button>
                    <button id="checkAdminBtn" class="btn-primary">
                        <i class="fa fa-user-circle mr-2"></i>检查管理员账号
                    </button>
                    <button id="createAdminBtn" class="btn-secondary">
                        <i class="fa fa-plus-circle mr-2"></i>创建管理员账号
                    </button>
                    <button id="testLoginBtn" class="btn-primary">
                        <i class="fa fa-sign-in mr-2"></i>测试登录
                    </button>
                    <button id="clearLogBtn" class="btn-secondary">
                        <i class="fa fa-trash mr-2"></i>清空日志
                    </button>
                </div>
            </div>

            <!-- 配置信息 -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">系统配置</h2>
                <div class="space-y-2">
                    <p><strong>数据库URL：</strong> <span id="dbUrl">加载中...</span></p>
                    <p><strong>API密钥：</strong> <span id="apiKey">加载中...</span></p>
                    <p><strong>默认管理员：</strong> <span id="defaultAdmin">加载中...</span></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 导入模块
        import './js/config.js';
        import './js/database.js';
        import './js/auth.js';

        // 全局变量
        let logCount = 0;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            log('系统初始化完成');
            displayConfig();
            
            // 绑定事件
            document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
            document.getElementById('initializeDbBtn').addEventListener('click', initializeDatabase);
            document.getElementById('checkAdminBtn').addEventListener('click', checkAdminAccount);
            document.getElementById('createAdminBtn').addEventListener('click', createAdminAccount);
            document.getElementById('testLoginBtn').addEventListener('click', testLogin);
            document.getElementById('clearLogBtn').addEventListener('click', clearLog);
        });

        // 显示配置信息
        function displayConfig() {
            try {
                const config = window.AppConfig;
                if (config && config.supabase) {
                    document.getElementById('dbUrl').textContent = config.supabase.url || '未配置';
                    document.getElementById('apiKey').textContent = (config.supabase.key || '').substring(0, 10) + '...';
                    document.getElementById('defaultAdmin').textContent = (config.DEFAULT_ADMIN ? `${config.DEFAULT_ADMIN.username}/${config.DEFAULT_ADMIN.password}` : '未配置');
                    log('配置信息加载成功', 'info');
                } else {
                    log('配置信息不完整', 'error');
                    document.getElementById('dbUrl').textContent = '未配置';
                    document.getElementById('apiKey').textContent = '未配置';
                    document.getElementById('defaultAdmin').textContent = '未配置';
                }
            } catch (error) {
                log('配置信息加载失败: ' + error.message, 'error');
                document.getElementById('dbUrl').textContent = '加载失败';
                document.getElementById('apiKey').textContent = '加载失败';
                document.getElementById('defaultAdmin').textContent = '加载失败';
            }
        }

        // 记录日志
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span>[${timestamp}] ${++logCount}. ${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // 控制台也输出
            switch(type) {
                case 'error':
                    console.error(message);
                    break;
                case 'success':
                    console.log('%c' + message, 'color: green');
                    break;
                default:
                    console.log(message);
            }
        }

        // 清空日志
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
            logCount = 0;
            log('日志已清空');
        }

        // 测试数据库连接
        async function testConnection() {
            log('开始测试数据库连接...');
            try {
                const supabase = window.AppConfig.supabase;
                log('正在连接到: ' + supabase.url);
                
                // 测试基本连接
                const start = Date.now();
                const { data, error } = await supabase.from('admins').select('*').limit(1);
                const duration = Date.now() - start;
                
                if (error) {
                    log(`连接测试完成 (${duration}ms)，但有错误: ${error.code} - ${error.message}`, 'error');
                    log('可能是表不存在，这是正常的');
                } else {
                    log(`连接测试成功 (${duration}ms)，返回数据: ${JSON.stringify(data)}`, 'success');
                }
            } catch (error) {
                log('连接测试异常: ' + error.message, 'error');
            }
        }

        // 初始化数据库
        async function initializeDatabase() {
            log('开始初始化数据库...');
            try {
                const db = new DatabaseManager();
                const result = await db.initializeDatabase();
                if (result) {
                    log('数据库初始化成功', 'success');
                } else {
                    log('数据库初始化失败', 'error');
                }
            } catch (error) {
                log('数据库初始化异常: ' + error.message, 'error');
            }
        }

        // 检查管理员账号
        async function checkAdminAccount() {
            log('开始检查管理员账号...');
            try {
                const supabase = window.AppConfig.supabase;
                const { data, error } = await supabase.from('admins').select('*');
                
                if (error) {
                    log('检查管理员账号失败: ' + error.message, 'error');
                } else if (data.length === 0) {
                    log('管理员表存在，但没有账号', 'error');
                } else {
                    log(`发现 ${data.length} 个管理员账号`, 'success');
                    data.forEach((admin, index) => {
                        log(`账号 ${index + 1}: ${admin.username}, 密码: ${admin.password.substring(0, 6)}...`);
                    });
                }
            } catch (error) {
                log('检查管理员账号异常: ' + error.message, 'error');
            }
        }

        // 创建管理员账号
        async function createAdminAccount() {
            log('开始创建管理员账号...');
            try {
                const config = window.AppConfig;
                const db = new DatabaseManager();
                const hashedPassword = db.hashPassword(config.DEFAULT_ADMIN.password);
                
                log(`准备创建账号: ${config.DEFAULT_ADMIN.username}`);
                
                const { error } = await config.supabase.from('admins').insert({
                    username: config.DEFAULT_ADMIN.username,
                    password: hashedPassword,
                    created_at: new Date().toISOString()
                });
                
                if (error) {
                    log('创建管理员账号失败: ' + error.message, 'error');
                } else {
                    log('管理员账号创建成功', 'success');
                    log(`账号: ${config.DEFAULT_ADMIN.username}`);
                    log(`密码: ${config.DEFAULT_ADMIN.password}`);
                    log(`哈希后密码: ${hashedPassword}`);
                }
            } catch (error) {
                log('创建管理员账号异常: ' + error.message, 'error');
            }
        }

        // 测试登录
        async function testLogin() {
            log('开始测试登录...');
            try {
                const config = window.AppConfig;
                const auth = new AuthManager();
                
                log(`尝试登录: ${config.DEFAULT_ADMIN.username}`);
                
                const start = Date.now();
                const result = await auth.adminLogin(config.DEFAULT_ADMIN.username, config.DEFAULT_ADMIN.password);
                const duration = Date.now() - start;
                
                if (result.success) {
                    log(`登录成功 (${duration}ms)`, 'success');
                } else {
                    log(`登录失败 (${duration}ms): ${result.message}`, 'error');
                }
            } catch (error) {
                log('登录测试异常: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>