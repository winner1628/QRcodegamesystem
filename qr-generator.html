<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 生成器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #f5f5f5; 
            padding: 20px; 
            /* 避免页面内容过宽 */
            max-width: 100vw;
            overflow-x: hidden;
        }
        .container { 
            max-width: 100%; /* 改为100%宽度，适配所有屏幕 */
            margin: 0 auto; 
            background: #fff; 
            padding: 20px 15px; /* 减少左右内边距，增加空间 */
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        .alert { 
            padding: 12px; 
            border-radius: 4px; 
            margin-bottom: 15px; 
            text-align: center; 
            font-weight: 600; 
            display: none; 
        }
        .error { 
            background: #fef2f2; 
            color: #dc2626; 
            border: 1px solid #fecdd3; 
        }
        .loading { 
            background: #eff6ff; 
            color: #2563eb; 
            border: 1px solid #bfdbfe; 
        }
        h1 { 
            text-align: center; 
            color: #dc2626; 
            margin-bottom: 8px; 
            font-size: 20px; /* 调小标题字号，节省空间 */
        }
        .subtitle { 
            text-align: center; 
            color: #64748b; 
            margin-bottom: 18px; 
            font-size: 14px; 
        }
        .tabs { 
            display: flex; 
            justify-content: center; 
            gap: 8px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .tab-btn { 
            padding: 8px 18px; 
            border: none; 
            border-radius: 4px; 
            background: #e2e8f0; 
            cursor: pointer; 
            font-size: 14px; 
        }
        .tab-btn.active { 
            background: #dc2626; 
            color: #fff; 
        }
        .actions { 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .action-btn { 
            padding: 8px 15px; 
            border: none; 
            border-radius: 4px; 
            color: #fff; 
            cursor: pointer; 
            font-size: 14px; 
            margin: 0 4px 8px; /* 增加底部外边距，避免挤压 */
        }
        .btn-print { background: #16a34a; }
        .btn-refresh { background: #f59e0b; }
        .btn-test { background: #6366f1; }
        
        /* ========== 核心优化：二维码网格+卡片布局 ========== */
        .qr-grid { 
            display: grid; 
            /* 减少列宽，增加列间距，确保每个卡片有足够空间 */
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 25px; /* 大幅增加卡片间距，避免重叠 */
            padding: 0 5px; /* 左右留白，避免贴边 */
        }
        /* 二维码卡片：大幅增加内边距和行间距 */
        .qr-card { 
            text-align: center; 
            padding: 25px 15px; /* 上下内边距增加，左右适当 */
            border-radius: 8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* 卡片内元素间距从12px→15px，大幅增加 */
            min-height: 320px; /* 固定最小高度，确保元素都能显示 */
        }
        /* 二维码容器：尺寸不变，居中显示 */
        .qr-container { 
            width: 180px; 
            height: 180px; 
            margin: 0 auto; 
            background: #fff; 
            border: 1px solid #eee; 
            position: relative; 
            flex-shrink: 0; /* 防止容器被压缩 */
        }
        /* 二维码文本标注：核心优化行间距 */
        .qr-text-label { 
            font-size: var(--text-size); 
            color: var(--text-color); 
            font-weight: 600; 
            line-height: 1.6; /* 行间距从1.4→1.6，大幅增加 */
            word-break: break-all;
            padding: 0 10px;
            text-align: center;
            max-width: 200px; /* 限制文本宽度，避免溢出 */
            flex-shrink: 0; /* 防止文本被压缩 */
        }
        /* 下载按钮：独立一行，足够空间 */
        .qr-download-btn { 
            padding: 10px 25px; /* 加大按钮尺寸，更易点击 */
            background: #2563eb; 
            color: #fff; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            flex-shrink: 0; /* 防止按钮被压缩 */
            width: 80%; /* 按钮宽度80%，居中显示 */
            margin-top: 5px; /* 顶部增加间距，远离文本 */
        }
        .qr-download-btn:hover {
            background: #1d4ed8;
        }
        .status { 
            text-align: center; 
            padding: 40px 0; 
            color: #64748b; 
            font-size: 16px; 
        }
        
        /* 打印适配 */
        @media print { 
            .alert, .tabs, .actions, .qr-download-btn { display: none; } 
            .qr-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; } 
            .qr-container { width: 140px !important; height: 140px !important; }
            .qr-card { box-shadow: none; border: 1px solid #eee; min-height: auto; }
        }
        /* 移动端适配：进一步优化 */
        @media (max-width: 768px) {
            .qr-grid { 
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
                gap: 20px; 
            }
            .qr-card { 
                min-height: 300px; /* 移动端适当减小最小高度 */
                padding: 20px 10px; 
            }
            .qr-container { width: 160px !important; height: 160px !important; }
            .qr-text-label { font-size: 13px; line-height: 1.5; }
            .qr-download-btn { padding: 8px 20px; font-size: 13px; width: 90%; }
        }
        /* 小屏手机（400px以下） */
        @media (max-width: 400px) {
            .qr-grid { grid-template-columns: 1fr; } /* 单列显示，完全不挤压 */
            .qr-card { min-height: 280px; }
            .qr-container { width: 150px !important; height: 150px !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="errorAlert" class="alert error">❌ 请先测试数据库连接</div>
        <div id="loadingAlert" class="alert loading">⌛ 加载中...</div>

        <h1>QR Code 生成器</h1>
        <p class="subtitle">用户/游戏二维码生成（支持单码下载/文本标注/打印）</p>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('user')">用户 QR Code</button>
            <button class="tab-btn" onclick="switchTab('game')">游戏 QR Code</button>
        </div>
        <div class="actions">
            <button class="action-btn btn-print" onclick="window.print()">列印所有</button>
            <button class="action-btn btn-refresh" onclick="refreshData()">刷新數據</button>
            <button class="action-btn btn-test" onclick="testConn()">測試連接</button>
        </div>

        <div id="userGrid" class="qr-grid status">点击「測試連接」验证数据库</div>
        <div id="gameGrid" class="qr-grid status" style="display: none;">切换后加载游戏数据</div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="js/qrcode.js"></script>
    <script>
        // 全局变量
        let supabaseClient = null;
        let activeTab = 'user';
        const { size: qrSize, color: qrColor, bgColor: qrBg, textSize, textColor } = window.qrConfig.qr;

        // 基础工具函数
        function show(id) { document.getElementById(id).style.display = 'block'; }
        function hide(id) { document.getElementById(id).style.display = 'none'; }
        function hideAllAlerts() { hide('errorAlert'); hide('loadingAlert'); }
        function showError(txt) { show('errorAlert'); document.getElementById('errorAlert').innerText = `❌ ${txt}`; }
        function showLoading(txt) { show('loadingAlert'); document.getElementById('loadingAlert').innerText = `⌛ ${txt || '加载中...'}`; }

        // 校验QRCode库
        function checkQRCodeLib() {
            if (typeof QRCode === 'undefined' || !QRCode.prototype) {
                showError('二维码生成库加载失败，请刷新页面');
                return false;
            }
            return true;
        }

        // 生成二维码
        function createQRCode(container, text) {
            if (!checkQRCodeLib()) return;
            container.innerHTML = '';
            new QRCode(container, {
                text: text,
                width: qrSize,
                colorDark: qrColor,
                colorLight: qrBg,
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // 生成带文本+下载按钮的二维码卡片
        function createQrCard(id, qrText, displayLabel, downloadName) {
            const card = document.createElement('div');
            card.className = 'qr-card';
            
            // 二维码容器
            const qrBox = document.createElement('div');
            qrBox.id = id;
            qrBox.className = 'qr-container';
            createQRCode(qrBox, qrText);

            // 二维码文本标注（增加换行处理，避免超长）
            const textLabel = document.createElement('div');
            textLabel.className = 'qr-text-label';
            textLabel.style.setProperty('--text-size', `${textSize}px`);
            textLabel.style.setProperty('--text-color', textColor);
            // 优化文本显示：超长文本自动截断（可选，如需取消可删除下面一行）
            textLabel.innerText = displayLabel.length > 30 ? displayLabel.slice(0, 27) + '...' : displayLabel;

            // 独立下载按钮
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'qr-download-btn';
            downloadBtn.innerText = '下载此二维码';
            downloadBtn.onclick = () => {
                try {
                    const qrImg = qrBox.querySelector('img');
                    if (!qrImg) {
                        alert('❌ 二维码图片未生成，请重试');
                        return;
                    }
                    const a = document.createElement('a');
                    // 简化下载文件名，避免超长
                    const safeFileName = `${downloadName}_${qrText.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    a.download = `${safeFileName}_QRCode.png`;
                    a.href = qrImg.src;
                    a.click();
                    a.remove();
                } catch (e) {
                    alert(`❌ 下载失败：${e.message.slice(0, 30)}`);
                }
            };

            // 组装卡片
            card.appendChild(qrBox);
            card.appendChild(textLabel);
            card.appendChild(downloadBtn);

            return card;
        }

        // 初始化Supabase
        function initSupabase() {
            if (supabaseClient) return true;
            try {
                supabaseClient = supabase.createClient(
                    window.qrConfig.supabaseUrl,
                    window.qrConfig.supabaseKey,
                    { global: { fetch: (u, o) => fetch(u, { ...o, signal: AbortSignal.timeout(window.qrConfig.timeout) }) } }
                );
                return true;
            } catch (e) {
                showError('Supabase初始化失败：' + e.message.slice(0, 30));
                return false;
            }
        }

        // 测试数据库连接
        async function testConn() {
            hideAllAlerts();
            showLoading('测试数据库连接...');
            if (!checkQRCodeLib()) {
                hide('loadingAlert');
                return;
            }
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('users').select('*').limit(1);
                if (error) throw error;
                hideAllAlerts();
                document.getElementById('userGrid').innerHTML = `✅ 连接成功！点击「刷新數據」加载二维码`;
            } catch (e) {
                const msg = e.message.includes('401') ? 'Supabase Key错误' : 
                            e.message.includes('CORS') ? '跨域配置错误（需在Supabase添加域名）' : 
                            e.message.includes('timeout') ? '请求超时（网络问题）' : 
                            e.message.slice(0, 30);
                showError('连接失败：' + msg);
            }
        }

        // 加载用户数据
        async function loadUsers() {
            hideAllAlerts();
            showLoading('加载用户二维码...');
            if (!checkQRCodeLib()) {
                hide('loadingAlert');
                return;
            }
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('users').select('id, username').order('username');
                if (error) throw error;
                if (!data || data.length === 0) {
                    document.getElementById('userGrid').innerHTML = '❌ 暂无用户数据';
                    hideAllAlerts();
                    return;
                }
                const userGrid = document.getElementById('userGrid');
                userGrid.innerHTML = '';
                data.forEach((u, index) => {
                    const uniqueId = `qr-u-${u.id}-${index}`;
                    const card = createQrCard(
                        uniqueId, 
                        u.username, 
                        `用户名：${u.username}`, 
                        `用户`
                    );
                    userGrid.appendChild(card);
                });
                hideAllAlerts();
            } catch (e) {
                showError('加载用户失败：' + e.message.slice(0, 30));
            }
        }

        // 加载游戏数据
        async function loadGames() {
            hideAllAlerts();
            showLoading('加载游戏二维码...');
            if (!checkQRCodeLib()) {
                hide('loadingAlert');
                return;
            }
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('games').select('id, game_code, game_name').order('game_code');
                if (error) throw error;
                if (!data || data.length === 0) {
                    document.getElementById('gameGrid').innerHTML = '❌ 暂无游戏数据';
                    hideAllAlerts();
                    return;
                }
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';
                data.forEach((g, index) => {
                    const uniqueId = `qr-g-${g.id}-${index}`;
                    // 优化游戏文本显示：缩短换行符，避免占太多行
                    const displayLabel = `游戏码：${g.game_code}\n游戏名：${g.game_name.length > 10 ? g.game_name.slice(0, 7) + '...' : g.game_name}`;
                    const card = createQrCard(
                        uniqueId, 
                        g.game_code, 
                        displayLabel, 
                        `游戏`
                    );
                    gameGrid.appendChild(card);
                });
                hideAllAlerts();
            } catch (e) {
                const errMsg = e.message.includes('games') 
                    ? 'games表不存在或字段错误（检查game_code/game_name字段）' 
                    : e.message.slice(0, 30);
                showError('加载游戏失败：' + errMsg);
            }
        }

        // 切换标签
        function switchTab(tab) {
            if (tab === activeTab) return;
            activeTab = tab;
            const tabs = document.querySelectorAll('.tab-btn');
            tabs[0].className = tab === 'user' ? 'tab-btn active' : 'tab-btn';
            tabs[1].className = tab === 'game' ? 'tab-btn active' : 'tab-btn';
            hide('userGrid'); hide('gameGrid');
            show(tab + 'Grid');
            if (tab === 'game' && document.getElementById('gameGrid').innerHTML.includes('切换后加载')) {
                loadGames();
            }
        }

        // 刷新数据
        function refreshData() {
            if (!checkQRCodeLib()) return;
            activeTab === 'user' ? loadUsers() : loadGames();
        }

        // 页面加载完成
        window.onload = function() {
            hideAllAlerts();
            checkQRCodeLib();
        };
    </script>
</body>
</html>
