<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 生成器</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", "Arial", sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .alert { padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-weight: 600; display: none; }
        .alert-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecdd3; }
        .alert-loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        h1 { text-align: center; color: #dc2626; margin-bottom: 10px; font-size: 24px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 30px; font-size: 16px; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 25px; border: none; border-radius: 6px; background: #e2e8f0; cursor: pointer; font-size: 16px; transition: background 0.2s; }
        .tab-btn.active { background: #dc2626; color: #fff; }
        .tab-btn:hover:not(.active) { background: #cbd5e1; }
        .actions { text-align: center; margin-bottom: 20px; }
        .action-btn { padding: 10px 20px; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 14px; margin: 0 5px; transition: background 0.2s; }
        .btn-print { background: #16a34a; }
        .btn-refresh { background: #f59e0b; }
        .btn-test { background: #6366f1; }
        .btn-print:hover { background: #15803d; }
        .btn-refresh:hover { background: #d97706; }
        .btn-test:hover { background: #4f46e5; }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .qr-card { text-align: center; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .qr-img { width: 150px; height: 150px; margin: 0 auto 15px; border: 1px solid #eee; }
        .qr-label { font-weight: 600; margin-bottom: 10px; font-size: 16px; }
        .download-btn { padding: 6px 15px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        .download-btn:hover { background: #1d4ed8; }
        .status { text-align: center; padding: 50px 0; color: #64748b; font-size: 18px; }
        /* 打印优化 */
        @media print { 
            .alert, .tabs, .actions, .download-btn { display: none; } 
            .qr-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; } 
            .qr-card { box-shadow: none; border: 1px solid #eee; page-break-inside: avoid; }
            .qr-img { width: 120px; height: 120px; }
        }
        /* 移动端适配 */
        @media (max-width: 768px) {
            .qr-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .qr-img { width: 120px; height: 120px; }
            .action-btn { padding: 8px 15px; margin: 0 3px 8px; }
            .tab-btn { padding: 8px 20px; }
            .container { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 错误提示框 -->
        <div id="errorAlert" class="alert alert-error"></div>
        <!-- 加载提示框 -->
        <div id="loadingAlert" class="alert alert-loading">加载中，请稍候...</div>

        <h1>QR Code 生成器</h1>
        <p class="subtitle">用户/游戏二维码生成（支持下载/打印）</p>

        <div class="tabs">
            <button class="tab-btn active" id="tabUser">用户 QR Code</button>
            <button class="tab-btn" id="tabGame">游戏 QR Code</button>
        </div>

        <div class="actions">
            <button class="action-btn btn-print" id="btnPrint">列印所有</button>
            <button class="action-btn btn-refresh" id="btnRefresh">刷新數據</button>
            <button class="action-btn btn-test" id="btnTest">測試連接</button>
        </div>

        <!-- 用户二维码区域 -->
        <div id="userGrid" class="qr-grid status">加载用户数据中...</div>
        <!-- 游戏二维码区域（默认隐藏） -->
        <div id="gameGrid" class="qr-grid status" style="display: none;">加载游戏数据中...</div>
    </div>

    <!-- 第一步：加载Supabase库（和登录页用相同的CDN） -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <!-- 第二步：加载本地配置文件 -->
    <script src="js/qrcode.js"></script>

    <!-- 第三步：原生Canvas二维码生成核心（零第三方库依赖） -->
    <script>
        // 原生QRCode生成器（纯Canvas，无外部依赖）
        class NativeQRCode {
            constructor(text, options = {}) {
                this.text = text || '';
                this.options = {
                    size: 150,
                    margin: 1,
                    color: '#000000',
                    bgColor: '#ffffff',
                    ...options
                };
                // QRCode版本和纠错级别（固定为版本1，高容错）
                this.version = 1;
                this.errorCorrection = 'H';
            }

            // 生成二维码矩阵（简化版，适配短文本：用户名/游戏码）
            generateMatrix() {
                // 简单的QR码编码（适配短文本，足够满足用户名/游戏码需求）
                const text = this.text;
                const matrixSize = 21; // 版本1的QR码矩阵大小21x21
                const matrix = Array(matrixSize).fill(0).map(() => Array(matrixSize).fill(0));

                // 基础定位图案（三个角的正方形）
                this.drawPositionPattern(matrix, 0, 0);
                this.drawPositionPattern(matrix, matrixSize - 7, 0);
                this.drawPositionPattern(matrix, 0, matrixSize - 7);

                // 时序图案（横竖线）
                this.drawTimingPattern(matrix, matrixSize);

                // 数据编码（简化版，仅适配ASCII文本）
                const dataBits = this.encodeTextToBits(text);
                let bitIndex = 0;
                // 跳过定位/时序图案区域，填充数据位
                for (let y = matrixSize - 1; y >= 0; y -= 2) {
                    for (let x = matrixSize - 1; x >= 0; x--) {
                        if (this.isReserved(matrix, x, y)) continue;
                        matrix[y][x] = dataBits[bitIndex % dataBits.length] || 0;
                        bitIndex++;
                        if (x > 0) {
                            if (this.isReserved(matrix, x - 1, y)) continue;
                            matrix[y][x - 1] = dataBits[bitIndex % dataBits.length] || 0;
                            bitIndex++;
                        }
                    }
                }
                return matrix;
            }

            // 绘制定位图案
            drawPositionPattern(matrix, x, y) {
                for (let i = -3; i <= 3; i++) {
                    for (let j = -3; j <= 3; j++) {
                        const px = x + i;
                        const py = y + j;
                        if (px < 0 || py < 0 || px >= matrix.length || py >= matrix.length) continue;
                        // 定位图案：外框黑色，内框白色，中心黑色
                        if (Math.abs(i) === 3 || Math.abs(j) === 3) {
                            matrix[py][px] = 1;
                        } else if (Math.abs(i) < 2 && Math.abs(j) < 2) {
                            matrix[py][px] = 1;
                        } else {
                            matrix[py][px] = 0;
                        }
                    }
                }
            }

            // 绘制时序图案
            drawTimingPattern(matrix, size) {
                // 横向时序线
                for (let x = 8; x < size - 8; x++) {
                    matrix[6][x] = x % 2;
                }
                // 纵向时序线
                for (let y = 8; y < size - 8; y++) {
                    matrix[y][6] = y % 2;
                }
            }

            // 检查是否是保留区域（定位/时序图案）
            isReserved(matrix, x, y) {
                const size = matrix.length;
                // 定位图案区域
                if ((x < 7 && y < 7) || (x > size - 8 && y < 7) || (x < 7 && y > size - 8)) return true;
                // 时序图案区域
                if (x === 6 || y === 6) return true;
                return false;
            }

            // 文本转二进制位（ASCII编码）
            encodeTextToBits(text) {
                const bits = [];
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i);
                    // 转8位二进制
                    for (let j = 7; j >= 0; j--) {
                        bits.push((charCode >> j) & 1);
                    }
                }
                // 添加结束位
                bits.push(0, 0, 0, 0);
                return bits;
            }

            // 渲染到Canvas
            renderToCanvas(canvas) {
                const ctx = canvas.getContext('2d');
                const matrix = this.generateMatrix();
                const matrixSize = matrix.length;
                const cellSize = (this.options.size - 2 * this.options.margin) / matrixSize;
                const margin = this.options.margin;

                // 设置Canvas尺寸
                canvas.width = this.options.size;
                canvas.height = this.options.size;

                // 清空背景
                ctx.fillStyle = this.options.bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 绘制二维码矩阵
                ctx.fillStyle = this.options.color;
                for (let y = 0; y < matrixSize; y++) {
                    for (let x = 0; x < matrixSize; x++) {
                        if (matrix[y][x] === 1) {
                            ctx.fillRect(
                                margin + x * cellSize,
                                margin + y * cellSize,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }
                return canvas;
            }

            // 创建Canvas并返回
            createCanvas() {
                const canvas = document.createElement('canvas');
                this.renderToCanvas(canvas);
                return canvas;
            }
        }

        // ********** 业务逻辑开始 **********
        // 全局元素
        const el = {
            errorAlert: document.getElementById('errorAlert'),
            loadingAlert: document.getElementById('loadingAlert'),
            tabUser: document.getElementById('tabUser'),
            tabGame: document.getElementById('tabGame'),
            btnPrint: document.getElementById('btnPrint'),
            btnRefresh: document.getElementById('btnRefresh'),
            btnTest: document.getElementById('btnTest'),
            userGrid: document.getElementById('userGrid'),
            gameGrid: document.getElementById('gameGrid')
        };

        // 全局变量
        let supabaseClient = null;
        let activeTab = 'user';

        // 工具函数：提示框控制
        function showAlert(dom, text) { dom.innerText = text; dom.style.display = 'block'; }
        function hideAlert(dom) { dom.style.display = 'none'; }
        function showError(text) { showAlert(el.errorAlert, text); hideAlert(el.loadingAlert); }
        function showLoading() { showAlert(el.loadingAlert, '加载中，请稍候...'); hideAlert(el.errorAlert); }
        function clearAllAlert() { hideAlert(el.errorAlert); hideAlert(el.loadingAlert); }

        // 前置校验（复用登录页的Supabase配置）
        function preCheck() {
            // 校验Supabase库
            if (typeof supabase === 'undefined') {
                showError('❌ 数据库连接库加载失败，请检查网络');
                return false;
            }
            // 校验配置文件（和登录页共用，确保一致）
            if (!window.qrConfig || !window.qrConfig.supabaseUrl || !window.qrConfig.supabaseKey) {
                showError('❌ 未找到配置文件js/qrcode.js或凭证为空');
                return false;
            }
            // 校验凭证是否为占位符
            if (window.qrConfig.supabaseUrl.includes("你的项目ID") || window.qrConfig.supabaseKey.includes("你的anon public key")) {
                showError('❌ 请在js/qrcode.js中替换为真实的Supabase URL和Key');
                return false;
            }
            return true;
        }

        // 初始化Supabase（和登录页相同的连接方式）
        function initSupabase() {
            try {
                supabaseClient = supabase.createClient(
                    window.qrConfig.supabaseUrl,
                    window.qrConfig.supabaseKey,
                    {
                        global: {
                            fetch: (url, opts = {}) => {
                                opts.signal = AbortSignal.timeout(window.qrConfig.timeout);
                                return fetch(url, opts);
                            }
                        }
                    }
                );
                return true;
            } catch (err) {
                showError(`❌ 数据库客户端初始化失败：${err.message.slice(0, 50)}`);
                return false;
            }
        }

        // 生成二维码卡片（原生Canvas）
        function createQrCard(qrId, labelText, qrContent, downloadName) {
            const card = document.createElement('div');
            card.className = 'qr-card';

            // 二维码Canvas容器
            const qrCanvas = document.createElement('canvas');
            qrCanvas.id = qrId;
            qrCanvas.className = 'qr-img';
            
            // 使用原生QRCode生成器渲染
            const qrGenerator = new NativeQRCode(qrContent, {
                size: window.qrConfig.qr.size,
                margin: window.qrConfig.qr.margin,
                color: window.qrConfig.qr.color,
                bgColor: window.qrConfig.qr.bgColor
            });
            qrGenerator.renderToCanvas(qrCanvas);

            // 二维码标签
            const label = document.createElement('div');
            label.className = 'qr-label';
            label.innerText = labelText;

            // 下载按钮
            const downBtn = document.createElement('button');
            downBtn.className = 'download-btn';
            downBtn.innerText = '下载QR Code';
            downBtn.onclick = () => {
                try {
                    const a = document.createElement('a');
                    a.download = `${downloadName}-QRCode.png`;
                    a.href = qrCanvas.toDataURL('image/png', 1.0);
                    a.click();
                } catch (err) {
                    alert('❌ 下载失败，请检查浏览器设置');
                }
            };

            // 组装卡片
            card.appendChild(qrCanvas);
            card.appendChild(label);
            card.appendChild(downBtn);
            return card;
        }

        // 加载用户数据（复用登录页的数据库查询逻辑）
        async function loadUserList() {
            if (!supabaseClient) return;
            showLoading();
            el.userGrid.innerHTML = '加载用户数据中...';
            try {
                // 和登录页相同的查询方式
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('id, username')
                    .order('username');
                if (error) throw error;

                if (!data || data.length === 0) {
                    el.userGrid.innerHTML = '❌ 暂无用户数据，请先在数据库添加';
                    hideAlert(el.loadingAlert);
                    return;
                }

                // 生成用户二维码
                el.userGrid.innerHTML = '';
                data.forEach(user => {
                    el.userGrid.appendChild(createQrCard(
                        `qr-user-${user.id}`,
                        user.username,
                        user.username,
                        `user-${user.username}`
                    ));
                });
            } catch (err) {
                el.userGrid.innerHTML = `❌ 加载用户失败：${getFriendlyErrMsg(err)}`;
            } finally {
                hideAlert(el.loadingAlert);
            }
        }

        // 加载游戏数据
        async function loadGameList() {
            if (!supabaseClient) return;
            showLoading();
            el.gameGrid.innerHTML = '加载游戏数据中...';
            try {
                const { data, error } = await supabaseClient
                    .from('games')
                    .select('id, game_code, game_name')
                    .order('game_code');
                if (error) throw error;

                if (!data || data.length === 0) {
                    el.gameGrid.innerHTML = '❌ 暂无游戏数据，请先在数据库添加';
                    hideAlert(el.loadingAlert);
                    return;
                }

                // 生成游戏二维码
                el.gameGrid.innerHTML = '';
                data.forEach(game => {
                    el.gameGrid.appendChild(createQrCard(
                        `qr-game-${game.id}`,
                        `${game.game_code} (${game.game_name})`,
                        game.game_code,
                        `game-${game.game_code}`
                    ));
                });
            } catch (err) {
                el.gameGrid.innerHTML = `❌ 加载游戏失败：${getFriendlyErrMsg(err)}`;
            } finally {
                hideAlert(el.loadingAlert);
            }
        }

        // 测试数据库连接（和登录页共用相同的连接）
        async function testDatabaseConn() {
            if (!supabaseClient) return;
            showLoading();
            el.userGrid.innerHTML = '测试数据库连接中...';
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .limit(1);
                if (error) throw error;
                el.userGrid.innerHTML = `✅ 数据库连接成功！用户表当前有${data.length}条数据`;
            } catch (err) {
                el.userGrid.innerHTML = `❌ 数据库连接失败：${getFriendlyErrMsg(err)}`;
            } finally {
                hideAlert(el.loadingAlert);
            }
        }

        // 友好的错误提示
        function getFriendlyErrMsg(err) {
            if (!err || !err.message) return '未知错误';
            const msg = err.message;
            if (msg.includes('401')) return 'Supabase Key错误（请检查anon public key）';
            if (msg.includes('404')) return 'Supabase URL错误（请检查项目地址）';
            if (msg.includes('CORS')) return '跨域配置错误（需在Supabase添加你的域名）';
            if (msg.includes('timeout') || msg.includes('AbortError')) return '请求超时（网络/数据库服务器问题）';
            if (msg.includes('Failed to fetch')) return '网络连接失败，请检查服务器网络';
            if (msg.includes('relation "users" does not exist')) return '数据库中无users表，请先创建表';
            return msg.slice(0, 50);
        }

        // 标签切换
        function switchTab(tabType) {
            if (tabType === activeTab) return;
            activeTab = tabType;
            el.tabUser.classList.toggle('active', tabType === 'user');
            el.tabGame.classList.toggle('active', tabType === 'game');
            el.userGrid.style.display = tabType === 'user' ? 'grid' : 'none';
            el.gameGrid.style.display = tabType === 'game' ? 'grid' : 'none';
            if (tabType === 'game' && el.gameGrid.innerHTML.includes('加载游戏数据中')) {
                loadGameList();
            }
        }

        // 绑定所有按钮事件
        function bindAllEvents() {
            el.tabUser.onclick = () => switchTab('user');
            el.tabGame.onclick = () => switchTab('game');
            el.btnPrint.onclick = () => window.print();
            el.btnRefresh.onclick = () => {
                activeTab === 'user' ? loadUserList() : loadGameList();
            };
            el.btnTest.onclick = testDatabaseConn;
        }

        // 页面初始化
        async function initPage() {
            if (!preCheck()) return;
            if (!initSupabase()) return;
            bindAllEvents();
            await loadUserList();
            clearAllAlert();
        }

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
