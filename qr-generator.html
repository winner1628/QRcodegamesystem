<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 生成器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; text-align: center; font-weight: 600; }
        .error { background: #fef2f2; color: #dc2626; border: 1px solid #fecdd3; display: none; }
        .loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; display: none; }
        h1 { text-align: center; color: #dc2626; margin-bottom: 8px; font-size: 22px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 15px; }
        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn { padding: 8px 20px; border: none; border-radius: 4px; background: #e2e8f0; cursor: pointer; font-size: 15px; }
        .tab-btn.active { background: #dc2626; color: #fff; }
        .actions { text-align: center; margin-bottom: 20px; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 14px; margin: 0 4px; }
        .btn-print { background: #16a34a; }
        .btn-refresh { background: #f59e0b; }
        .btn-test { background: #6366f1; }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 18px; }
        .qr-card { text-align: center; padding: 15px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .qr-container { width: 180px; height: 180px; margin: 0 auto 10px; background: #fff; border: 1px solid #eee; }
        .qr-img { width: 100%; height: 100%; }
        .qr-label { font-size: 16px; color: #333; font-weight: 600; margin-bottom: 10px; word-break: break-all; }
        .download-btn { padding: 6px 15px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .status { text-align: center; padding: 40px 0; color: #64748b; font-size: 16px; }
        @media print { 
            .alert, .tabs, .actions, .download-btn { display: none; } 
            .qr-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; } 
            .qr-container { width: 140px !important; height: 140px !important; }
        }
        @media (max-width: 768px) {
            .qr-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .qr-container { width: 150px !important; height: 150px !important; }
            .action-btn { padding: 6px 12px; margin: 0 2px 6px; }
            .tab-btn { padding: 6px 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 提示框：直接显示，无需JS控制隐藏 -->
        <div id="errorAlert" class="alert error">❌ 请先测试数据库连接</div>
        <div id="loadingAlert" class="alert loading">⌛ 加载中...</div>

        <h1>QR Code 生成器</h1>
        <p class="subtitle">用户/游戏二维码生成（支持下载/打印）</p>

        <!-- 标签按钮：直接绑定onclick，加载即点 -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('user')">用户 QR Code</button>
            <button class="tab-btn" onclick="switchTab('game')">游戏 QR Code</button>
        </div>

        <!-- 功能按钮：直接绑定onclick，加载即点 -->
        <div class="actions">
            <button class="action-btn btn-print" onclick="window.print()">列印所有</button>
            <button class="action-btn btn-refresh" onclick="refreshData()">刷新數據</button>
            <button class="action-btn btn-test" onclick="testConn()">測試連接</button>
        </div>

        <!-- 内容区域 -->
        <div id="userGrid" class="qr-grid status">点击「測試連接」验证数据库</div>
        <div id="gameGrid" class="qr-grid status" style="display: none;">切换后加载游戏数据</div>
    </div>

    <!-- 先加载Supabase，再加载配置，最后写核心JS → 顺序绝对固定，避免加载失败 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="js/qrcode.js"></script>
    <script>
        // 全局变量：极简，仅保留必要的
        let supabaseClient = null;
        let activeTab = 'user';
        const qrSize = window.qrConfig.qr.size;
        const qrColor = window.qrConfig.qr.color;
        const qrBg = window.qrConfig.qr.bgColor;

        // ========== 基础工具函数：无冗余 ==========
        function show(id) { document.getElementById(id).style.display = 'block'; }
        function hide(id) { document.getElementById(id).style.display = 'none'; }
        function hideAllAlerts() { hide('errorAlert'); hide('loadingAlert'); }
        function showError(txt) { show('errorAlert'); document.getElementById('errorAlert').innerText = `❌ ${txt}`; }
        function showLoading(txt) { show('loadingAlert'); document.getElementById('loadingAlert').innerText = `⌛ ${txt || '加载中...'}`; }

        // ========== 二维码生成：纯函数，硬编码，无任何阻塞 ==========
        function createQRCode(canvas, text) {
            const matrixSize = 21; // 固定版本1，适配短文本
            const mat = Array(matrixSize).fill(0).map(() => Array(matrixSize).fill(0));
            // 绘制定位角
            function drawCorner(x, y) {
                for (let i = -3; i <= 3; i++) for (let j = -3; j <= 3; j++) {
                    const px = x + i, py = y + j;
                    if (px < 0 || py < 0 || px >= matrixSize || py >= matrixSize) continue;
                    mat[py][px] = (Math.abs(i) === 3 || Math.abs(j) === 3) || (Math.abs(i) < 2 && Math.abs(j) < 2) ? 1 : 0;
                }
            }
            drawCorner(0, 0);
            drawCorner(14, 0);
            drawCorner(0, 14);
            // 时序线
            for (let i = 8; i < 13; i++) mat[6][i] = mat[i][6] = i % 2;
            // 填充数据
            let bits = [];
            for (let i = 0; i < text.length; i++) {
                let code = text.charCodeAt(i);
                for (let j = 7; j >= 0; j--) bits.push((code >> j) & 1);
            }
            let b = 0;
            for (let y = 20; y >= 0; y -= 2) {
                for (let x = 20; x >= 0; x--) {
                    if ((x <7 && y<7)||(x>13&&y<7)||(x<7&&y>13)||x===6||y===6) continue;
                    mat[y][x] = bits[b % bits.length] || 0;
                    b++;
                    if (x>0 && !((x-1<7&&y<7)||(x-1>13&&y<7)||(x-1<7&&y>13)||x-1===6||y===6)) {
                        mat[y][x-1] = bits[b % bits.length] || 0;
                        b++;
                    }
                }
            }
            // 渲染到Canvas
            canvas.width = canvas.height = qrSize;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = qrBg;
            ctx.fillRect(0, 0, qrSize, qrSize);
            ctx.fillStyle = qrColor;
            const cell = (qrSize - 16) / matrixSize; // 固定内边距8*2
            for (let y = 0; y < matrixSize; y++) for (let x = 0; x < matrixSize; x++) {
                if (mat[y][x] === 1) ctx.fillRect(8 + x*cell, 8 + y*cell, cell, cell);
            }
        }

        // ========== 生成QR卡片：直接创建DOM，无冗余 ==========
        function createQrCard(id, label, content, downName) {
            const card = document.createElement('div');
            card.className = 'qr-card';
            // QR容器+Canvas
            const qrBox = document.createElement('div');
            qrBox.className = 'qr-container';
            const canvas = document.createElement('canvas');
            canvas.id = id;
            canvas.className = 'qr-img';
            createQRCode(canvas, content); // 立即生成QR
            qrBox.appendChild(canvas);
            // 文字
            const qrLabel = document.createElement('div');
            qrLabel.className = 'qr-label';
            qrLabel.innerText = label;
            // 下载按钮
            const downBtn = document.createElement('button');
            downBtn.className = 'download-btn';
            downBtn.innerText = '下载QR Code';
            downBtn.onclick = () => {
                const a = document.createElement('a');
                a.download = `${downName}-QRCode.png`;
                a.href = canvas.toDataURL('image/png', 1.0);
                a.click();
            };
            // 组装
            card.appendChild(qrBox);
            card.appendChild(qrLabel);
            card.appendChild(downBtn);
            return card;
        }

        // ========== 数据库相关：极简封装，异步执行 ==========
        // 初始化Supabase：仅执行一次
        function initSupabase() {
            if (supabaseClient) return true;
            try {
                supabaseClient = supabase.createClient(
                    window.qrConfig.supabaseUrl,
                    window.qrConfig.supabaseKey,
                    { global: { fetch: (u, o) => fetch(u, { ...o, signal: AbortSignal.timeout(window.qrConfig.timeout) }) } }
                );
                return true;
            } catch (e) {
                showError('Supabase初始化失败：' + e.message.slice(0, 30));
                return false;
            }
        }

        // 测试连接：点击即执行，实时反馈
        async function testConn() {
            hideAllAlerts();
            showLoading('测试数据库连接...');
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('users').select('*').limit(1);
                if (error) throw error;
                hideAllAlerts();
                document.getElementById('userGrid').innerHTML = `✅ 连接成功！用户表有${data.length}条数据，点击「刷新數據」加载二维码`;
            } catch (e) {
                showError('连接失败：' + (e.message.includes('401') ? 'Key错误' : e.message.includes('CORS') ? '跨域错误' : e.message.slice(0, 30)));
            }
        }

        // 加载用户数据
        async function loadUsers() {
            hideAllAlerts();
            showLoading('加载用户二维码...');
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('users').select('id, username').order('username');
                if (error) throw error;
                if (!data || data.length === 0) {
                    document.getElementById('userGrid').innerHTML = '❌ 暂无用户数据';
                    hideAllAlerts();
                    return;
                }
                const userGrid = document.getElementById('userGrid');
                userGrid.innerHTML = '';
                data.forEach(u => {
                    userGrid.appendChild(createQrCard(`qr-u-${u.id}`, u.username, u.username, `user-${u.username}`));
                });
                hideAllAlerts();
            } catch (e) {
                showError('加载用户失败：' + e.message.slice(0, 30));
            }
        }

        // 加载游戏数据
        async function loadGames() {
            hideAllAlerts();
            showLoading('加载游戏二维码...');
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('games').select('id, game_code, game_name').order('game_code');
                if (error) throw error;
                if (!data || data.length === 0) {
                    document.getElementById('gameGrid').innerHTML = '❌ 暂无游戏数据';
                    hideAllAlerts();
                    return;
                }
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';
                data.forEach(g => {
                    gameGrid.appendChild(createQrCard(`qr-g-${g.id}`, `${g.game_code}\n(${g.game_name})`, g.game_code, `game-${g.game_code}`));
                });
                hideAllAlerts();
            } catch (e) {
                showError('加载游戏失败：' + e.message.slice(0, 30));
            }
        }

        // ========== 页面操作：直接绑定，点击即执行 ==========
        // 切换标签
        function switchTab(tab) {
            if (tab === activeTab) return;
            activeTab = tab;
            // 切换按钮样式
            const tabs = document.querySelectorAll('.tab-btn');
            tabs[0].className = tab === 'user' ? 'tab-btn active' : 'tab-btn';
            tabs[1].className = tab === 'game' ? 'tab-btn active' : 'tab-btn';
            // 切换内容
            hide('userGrid'); hide('gameGrid');
            show(tab + 'Grid');
            // 首次加载数据
            if (tab === 'game' && document.getElementById('gameGrid').innerHTML.includes('切换后加载')) {
                loadGames();
            }
        }

        // 刷新数据
        function refreshData() {
            activeTab === 'user' ? loadUsers() : loadGames();
        }

        // 页面加载完成：仅隐藏提示框，无其他操作
        window.onload = function() {
            hideAllAlerts();
        };
    </script>
</body>
</html>
