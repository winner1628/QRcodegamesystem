<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 生成器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; text-align: center; font-weight: 600; display: none; }
        .alert-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecdd3; }
        .alert-loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        h1 { text-align: center; color: #dc2626; margin-bottom: 8px; font-size: 22px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 15px; }
        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn { padding: 8px 20px; border: none; border-radius: 4px; background: #e2e8f0; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .tab-btn.active { background: #dc2626; color: #fff; }
        .tab-btn:hover:not(.active) { background: #cbd5e1; }
        .actions { text-align: center; margin-bottom: 20px; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 14px; margin: 0 4px; transition: 0.2s; }
        .btn-print { background: #16a34a; }
        .btn-refresh { background: #f59e0b; }
        .btn-test { background: #6366f1; }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 18px; }
        .qr-card { text-align: center; padding: 15px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .qr-container { width: var(--qr-size); height: var(--qr-size); margin: 0 auto 10px; background: #fff; border: 1px solid #eee; }
        .qr-img { width: 100%; height: 100%; }
        .qr-label { font-size: var(--qr-text-size); color: var(--qr-text-color); font-weight: 600; margin-bottom: 10px; word-break: break-all; padding: 0 5px; }
        .download-btn { padding: 6px 15px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .download-btn:hover { background: #1d4ed8; }
        .status { text-align: center; padding: 40px 0; color: #64748b; font-size: 16px; }
        /* 打印优化 */
        @media print { 
            .alert, .tabs, .actions, .download-btn { display: none; } 
            .qr-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; } 
            .qr-card { box-shadow: none; border: 1px solid #eee; }
            .qr-container { width: 140px !important; height: 140px !important; }
        }
        /* 移动端适配 */
        @media (max-width: 768px) {
            .qr-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .qr-container { width: 150px !important; height: 150px !important; }
            .action-btn { padding: 6px 12px; margin: 0 2px 6px; }
            .tab-btn { padding: 6px 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="errorAlert" class="alert alert-error"></div>
        <div id="loadingAlert" class="alert alert-loading">加载中...</div>

        <h1>QR Code 生成器</h1>
        <p class="subtitle">用户/游戏二维码生成（支持下载/打印）</p>

        <div class="tabs">
            <button class="tab-btn active" id="tabUser">用户 QR Code</button>
            <button class="tab-btn" id="tabGame">游戏 QR Code</button>
        </div>

        <div class="actions">
            <button class="action-btn btn-print" id="btnPrint">列印所有</button>
            <button class="action-btn btn-refresh" id="btnRefresh">刷新數據</button>
            <button class="action-btn btn-test" id="btnTest">測試連接</button>
        </div>

        <div id="userGrid" class="qr-grid status">加载用户数据中...</div>
        <div id="gameGrid" class="qr-grid status" style="display: none;">加载游戏数据中...</div>
    </div>

    <!-- 加载Supabase（和登录页同CDN，轻量） -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <!-- 加载本地配置 -->
    <script src="js/qrcode.js"></script>

    <script>
        /********************* 轻量版QRCode生成器（仅版本1，适配短文本，无阻塞） *********************/
        class SimpleQRCode {
            constructor(text, options) {
                this.text = text || '';
                this.opts = { ...window.qrConfig.qr, ...options };
                this.matrixSize = 21; // 固定版本1，21x21矩阵，适配用户名/游戏码
            }

            // 生成基础矩阵（固定逻辑，无复杂计算）
            createMatrix() {
                const mat = Array(this.matrixSize).fill(0).map(() => Array(this.matrixSize).fill(0));
                // 绘制定位图案（三个角）
                this.drawCorner(mat, 0, 0);
                this.drawCorner(mat, this.matrixSize - 7, 0);
                this.drawCorner(mat, 0, this.matrixSize - 7);
                // 时序线
                this.drawTiming(mat);
                // 填充数据（简单编码，无阻塞）
                this.fillData(mat, this.text);
                return mat;
            }

            drawCorner(mat, x, y) {
                for (let i = -3; i <= 3; i++) for (let j = -3; j <= 3; j++) {
                    const px = x + i, py = y + j;
                    if (px < 0 || py < 0 || px >= this.matrixSize || py >= this.matrixSize) continue;
                    mat[py][px] = (Math.abs(i) === 3 || Math.abs(j) === 3) || (Math.abs(i) < 2 && Math.abs(j) < 2) ? 1 : 0;
                }
            }

            drawTiming(mat) {
                for (let i = 8; i < this.matrixSize - 8; i++) mat[6][i] = mat[i][6] = i % 2;
            }

            // 简单文本编码（适配ASCII，快速执行）
            fillData(mat, text) {
                let bits = [];
                // 转二进制位
                for (let i = 0; i < text.length; i++) {
                    let code = text.charCodeAt(i);
                    for (let j = 7; j >= 0; j--) bits.push((code >> j) & 1);
                }
                // 填充矩阵（蛇形，跳过保留区域）
                let b = 0;
                for (let y = this.matrixSize - 1; y >= 0; y -= 2) {
                    for (let x = this.matrixSize - 1; x >= 0; x--) {
                        if (this.isReserved(mat, x, y)) continue;
                        mat[y][x] = bits[b % bits.length] || 0;
                        b++;
                        if (x > 0 && !this.isReserved(mat, x - 1, y)) {
                            mat[y][x - 1] = bits[b % bits.length] || 0;
                            b++;
                        }
                    }
                }
            }

            isReserved(mat, x, y) {
                const s = this.matrixSize;
                return (x < 7 && y < 7) || (x > s - 8 && y < 7) || (x < 7 && y > s - 8) || x === 6 || y === 6;
            }

            // 渲染到Canvas（快速绘制，无阻塞）
            render(canvas) {
                const mat = this.createMatrix();
                const size = this.opts.size;
                const margin = this.opts.margin;
                const cell = (size - 2 * margin) / this.matrixSize;

                canvas.width = canvas.height = size;
                const ctx = canvas.getContext('2d');
                // 背景
                ctx.fillStyle = this.opts.bgColor;
                ctx.fillRect(0, 0, size, size);
                // 二维码
                ctx.fillStyle = this.opts.color;
                for (let y = 0; y < this.matrixSize; y++) for (let x = 0; x < this.matrixSize; x++) {
                    if (mat[y][x] === 1) {
                        ctx.fillRect(margin + x * cell, margin + y * cell, cell, cell);
                    }
                }
                return canvas;
            }
        }

        /********************* 页面核心逻辑（极简，按钮即时绑定，无阻塞） *********************/
        // 全局元素（一次性获取，无重复查询）
        const dom = {
            errorAlert: document.getElementById('errorAlert'),
            loadingAlert: document.getElementById('loadingAlert'),
            tabUser: document.getElementById('tabUser'),
            tabGame: document.getElementById('tabGame'),
            btnPrint: document.getElementById('btnPrint'),
            btnRefresh: document.getElementById('btnRefresh'),
            btnTest: document.getElementById('btnTest'),
            userGrid: document.getElementById('userGrid'),
            gameGrid: document.getElementById('gameGrid')
        };

        let supabase = null;
        let activeTab = 'user';

        // 工具函数（极简，快速执行）
        const showError = (txt) => {
            dom.errorAlert.innerText = txt;
            dom.errorAlert.style.display = 'block';
            dom.loadingAlert.style.display = 'none';
        };
        const showLoading = () => {
            dom.loadingAlert.style.display = 'block';
            dom.errorAlert.style.display = 'none';
        };
        const hideAlerts = () => {
            dom.errorAlert.style.display = dom.loadingAlert.style.display = 'none';
        };
        // 友好错误提示
        const getErrMsg = (err) => {
            if (!err) return '未知错误';
            const m = err.message;
            if (m.includes('401')) return 'Supabase Key错误';
            if (m.includes('404')) return 'Supabase URL错误';
            if (m.includes('CORS')) return '跨域配置错误';
            if (m.includes('timeout')) return '请求超时';
            if (m.includes('Failed to fetch')) return '网络错误';
            return m.slice(0, 40);
        };

        // 初始化Supabase（和登录页一致，快速执行）
        const initSupabase = () => {
            try {
                supabase = window.supabase.createClient(
                    window.qrConfig.supabaseUrl,
                    window.qrConfig.supabaseKey,
                    { global: { fetch: (u, o) => fetch(u, { ...o, signal: AbortSignal.timeout(window.qrConfig.timeout) }) } }
                );
                return true;
            } catch (e) {
                showError(`❌ 数据库初始化失败：${getErrMsg(e)}`);
                return false;
            }
        };

        // 生成二维码卡片（快速创建DOM）
        const createQrCard = (id, label, content, downName) => {
            const card = document.createElement('div');
            card.className = 'qr-card';
            // 设置CSS变量
            card.style.setProperty('--qr-size', `${window.qrConfig.qr.size}px`);
            card.style.setProperty('--qr-text-size', `${window.qrConfig.qr.textSize}px`);
            card.style.setProperty('--qr-text-color', window.qrConfig.qr.textColor);

            // 二维码容器+Canvas
            const qrBox = document.createElement('div');
            qrBox.className = 'qr-container';
            const canvas = document.createElement('canvas');
            canvas.id = id;
            canvas.className = 'qr-img';
            // 渲染二维码（轻量生成器）
            new SimpleQRCode(content).render(canvas);
            qrBox.appendChild(canvas);

            // 下方文字
            const qrLabel = document.createElement('div');
            qrLabel.className = 'qr-label';
            qrLabel.innerText = label;

            // 下载按钮
            const downBtn = document.createElement('button');
            downBtn.className = 'download-btn';
            downBtn.innerText = '下载QR Code';
            downBtn.onclick = () => {
                const a = document.createElement('a');
                a.download = `${downName}-QRCode.png`;
                a.href = canvas.toDataURL('image/png', 1.0);
                a.click();
            };

            // 组装卡片
            card.appendChild(qrBox);
            card.appendChild(qrLabel);
            card.appendChild(downBtn);
            return card;
        };

        // 加载用户数据（异步，不阻塞页面）
        const loadUsers = async () => {
            if (!supabase) return;
            showLoading();
            dom.userGrid.innerHTML = '加载用户数据中...';
            try {
                const { data, error } = await supabase.from('users').select('id, username').order('username');
                if (error) throw error;
                if (!data || data.length === 0) {
                    dom.userGrid.innerHTML = '❌ 暂无用户数据';
                    hideAlerts();
                    return;
                }
                dom.userGrid.innerHTML = '';
                data.forEach(u => {
                    dom.userGrid.appendChild(createQrCard(`qr-u-${u.id}`, u.username, u.username, `user-${u.username}`));
                });
            } catch (e) {
                dom.userGrid.innerHTML = `❌ 加载用户失败：${getErrMsg(e)}`;
            } finally {
                hideAlerts();
            }
        };

        // 加载游戏数据（异步，不阻塞页面）
        const loadGames = async () => {
            if (!supabase) return;
            showLoading();
            dom.gameGrid.innerHTML = '加载游戏数据中...';
            try {
                const { data, error } = await supabase.from('games').select('id, game_code, game_name').order('game_code');
                if (error) throw error;
                if (!data || data.length === 0) {
                    dom.gameGrid.innerHTML = '❌ 暂无游戏数据';
                    hideAlerts();
                    return;
                }
                dom.gameGrid.innerHTML = '';
                data.forEach(g => {
                    const label = `${g.game_code}\n(${g.game_name})`;
                    dom.gameGrid.appendChild(createQrCard(`qr-g-${g.id}`, label, g.game_code, `game-${g.game_code}`));
                });
            } catch (e) {
                dom.gameGrid.innerHTML = `❌ 加载游戏失败：${getErrMsg(e)}`;
            } finally {
                hideAlerts();
            }
        };

        // 测试数据库连接（快速反馈）
        const testConn = async () => {
            if (!supabase) return;
            showLoading();
            dom.userGrid.innerHTML = '测试连接中...';
            try {
                const { data } = await supabase.from('users').select('*').limit(1);
                dom.userGrid.innerHTML = `✅ 连接成功！用户表有${data.length}条数据`;
            } catch (e) {
                dom.userGrid.innerHTML = `❌ 连接失败：${getErrMsg(e)}`;
            } finally {
                hideAlerts();
            }
        };

        // 标签切换（即时响应，无延迟）
        const switchTab = (tab) => {
            if (tab === activeTab) return;
            activeTab = tab;
            // 切换样式
            dom.tabUser.classList.toggle('active', tab === 'user');
            dom.tabGame.classList.toggle('active', tab === 'game');
            // 切换内容
            dom.userGrid.style.display = tab === 'user' ? 'grid' : 'none';
            dom.gameGrid.style.display = tab === 'game' ? 'grid' : 'none';
            // 首次加载对应数据
            if (tab === 'game' && dom.gameGrid.innerHTML.includes('加载游戏数据')) loadGames();
        };

        /********************* 页面初始化（** 优先绑定按钮事件 **，保证即时响应） *********************/
        const initPage = () => {
            // 第一步：**优先绑定所有按钮事件**，不管后续逻辑，按钮先能点！
            dom.tabUser.onclick = () => switchTab('user');
            dom.tabGame.onclick = () => switchTab('game');
            dom.btnPrint.onclick = () => window.print();
            dom.btnRefresh.onclick = () => activeTab === 'user' ? loadUsers() : loadGames();
            dom.btnTest.onclick = testConn;

            // 第二步：前置校验（快速）
            if (typeof window.supabase === 'undefined') {
                showError('❌ 加载Supabase库失败');
                return;
            }
            if (!window.qrConfig || !window.qrConfig.supabaseUrl || !window.qrConfig.supabaseKey) {
                showError('❌ 配置文件js/qrcode.js错误');
                return;
            }
            if (window.qrConfig.supabaseUrl.includes('你的项目ID')) {
                showError('❌ 请替换为真实的Supabase凭证');
                return;
            }

            // 第三步：初始化数据库+加载默认数据（异步，不阻塞）
            if (initSupabase()) loadUsers();
        };

        // DOM加载完成后立即初始化（无延迟）
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
