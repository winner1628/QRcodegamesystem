<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 生成器</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", "Arial", sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .alert { padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-weight: 600; display: none; }
        .alert-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecdd3; }
        .alert-loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        h1 { text-align: center; color: #dc2626; margin-bottom: 10px; font-size: 24px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 30px; font-size: 16px; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 25px; border: none; border-radius: 6px; background: #e2e8f0; cursor: pointer; font-size: 16px; transition: background 0.2s; }
        .tab-btn.active { background: #dc2626; color: #fff; }
        .tab-btn:hover:not(.active) { background: #cbd5e1; }
        .actions { text-align: center; margin-bottom: 20px; }
        .action-btn { padding: 10px 20px; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 14px; margin: 0 5px; transition: background 0.2s; }
        .btn-print { background: #16a34a; }
        .btn-refresh { background: #f59e0b; }
        .btn-test { background: #6366f1; }
        .btn-print:hover { background: #15803d; }
        .btn-refresh:hover { background: #d97706; }
        .btn-test:hover { background: #4f46e5; }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .qr-card { text-align: center; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .qr-img { width: 150px; height: 150px; margin: 0 auto 15px; }
        .qr-label { font-weight: 600; margin-bottom: 10px; font-size: 16px; }
        .download-btn { padding: 6px 15px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        .download-btn:hover { background: #1d4ed8; }
        .status { text-align: center; padding: 50px 0; color: #64748b; font-size: 18px; }
        /* 打印优化 */
        @media print { 
            .alert, .tabs, .actions, .download-btn { display: none; } 
            .qr-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; } 
            .qr-card { box-shadow: none; border: 1px solid #eee; page-break-inside: avoid; }
            .qr-img { width: 120px; height: 120px; }
        }
        /* 移动端适配 */
        @media (max-width: 768px) {
            .qr-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .qr-img { width: 120px; height: 120px; }
            .action-btn { padding: 8px 15px; margin: 0 3px 8px; }
            .tab-btn { padding: 8px 20px; }
            .container { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 错误提示框 -->
        <div id="errorAlert" class="alert alert-error"></div>
        <!-- 加载提示框 -->
        <div id="loadingAlert" class="alert alert-loading">加载中，请稍候...</div>

        <h1>QR Code 生成器</h1>
        <p class="subtitle">用户/游戏二维码生成（支持下载/打印）</p>

        <div class="tabs">
            <button class="tab-btn active" id="tabUser">用户 QR Code</button>
            <button class="tab-btn" id="tabGame">游戏 QR Code</button>
        </div>

        <div class="actions">
            <button class="action-btn btn-print" id="btnPrint">列印所有</button>
            <button class="action-btn btn-refresh" id="btnRefresh">刷新數據</button>
            <button class="action-btn btn-test" id="btnTest">測試連接</button>
        </div>

        <!-- 用户二维码区域 -->
        <div id="userGrid" class="qr-grid status">加载用户数据中...</div>
        <!-- 游戏二维码区域（默认隐藏） -->
        <div id="gameGrid" class="qr-grid status" style="display: none;">加载游戏数据中...</div>
    </div>

    <!-- 第一步：内嵌QRCodejs核心库（零CDN依赖，彻底解决加载失败） -->
    <script>
        !function(e,t){var n="object"==typeof window&&window||"object"==typeof self&&self;"function"==typeof define&&define.amd?define(function(){return t(n)}):"object"==typeof module&&module.exports?module.exports=t(n):n.QRCode=t(n)}(this,function(e){var t=function(e,t,n){this.typeNumber=e,this.errorCorrectionLevel=n,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[];if(void 0!==t)for(var o in t)t.hasOwnProperty(o)&&this.addData(t[o])};t.prototype={addData:function(e){var t=QR8bitByte.fromString(e);this.dataList.push(t),this.dataCache=null},isDark:function(e,t){if(e<0||this.moduleCount<=e||t<0||this.moduleCount<=t)throw new Error(e+","+t);return this.modules[e][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(e,t){this.moduleCount=this.typeNumber*4+17,this.modules=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++){this.modules[n]=new Array(this.moduleCount);for(var o=0;o<this.moduleCount;o++)this.modules[n][o]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(e,t),this.typeNumber>=7&&this.setupTypeNumber(e);if(null===this.dataCache){var i=QRCode.createData(this.typeNumber,this.errorCorrectionLevel,this.dataList);this.dataCache=i}this.mapData(this.dataCache,t)},setupPositionProbePattern:function(e,t){for(var n=-1;n<=7;n++)if(!(e+n<0||this.moduleCount<=e+n))for(var o=-1;o<=7;o++)t+o<0||this.moduleCount<=t+o||(this.modules[e+n][t+o]=0<=n&&n<=6&&(0==o||6==o)||0<=o&&o<=6&&(0==n||6==n)||2<=n&&n<=4&&2<=o&&o<=4?!1:!0)},setupPositionAdjustPattern:function(){var e=QRCode.getPatternPosition(this.typeNumber);for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++){var o=e[t],i=e[n];if(null===this.modules[o][i])for(var r=-2;r<=2;r++)for(var s=-2;s<=2;s++)this.modules[o+r][i+s]=-2==r||2==r||-2==s||2==s||0==r&&0==s?!1:!0}},setupTimingPattern:function(){for(var e=8;e<this.moduleCount-8;e++)null===this.modules[e][6]&&(this.modules[e][6]=0==e%2);for(var t=8;t<this.moduleCount-8;t++)null===this.modules[6][t]&&(this.modules[6][t]=0==t%2)},setupTypeNumber:function(e,t){var n=QRCode.getBCHTypeNumber(this.typeNumber);for(var o=0;o<18;o++){var i=e?!(1&(n>>o)):1&(n>>o);this.modules[Math.floor(o/3)][o%3+this.moduleCount-8-3]=i}for(var r=0;r<18;r++){var i=e?!(1&(n>>r)):1&(n>>r);this.modules[r%3+this.moduleCount-8-3][Math.floor(r/3)]=i}},setupTypeInfo:function(e,t){var n=QRCode.getBCHTypeInfo(t<<3|this.errorCorrectionLevel);for(var o=0;o<15;o++){var i=e?!(1&(n>>o)):1&(n>>o);if(o<6)this.modules[o][8]=i;else if(6==o)this.modules[o+1][8]=i;else this.modules[this.moduleCount-15+o][8]=i}for(var r=0;r<15;r++){var i=e?!(1&(n>>r)):1&(n>>r);if(r<8)this.modules[8][this.moduleCount-1-r]=i;else if(8==r)this.modules[8][15-r-1]=i;else this.modules[8][15-r-1]=i}this.modules[this.moduleCount-8][8]=e?!0:!0},mapData:function(e,t){for(var n=0,o=0,i=this.moduleCount-1,r=7,s=0;s<e.length;s++)for(var a=e[s],u=0;u<8;u++){var l=e?!(1&(a>>7-u)):1&(a>>7-u);if(null===this.modules[i][o]){var c=!1;if(0==(i+t)%3&&1==o%3&&o>6)c=!0;else{for(var d=-1;d<=1;d++)for(var h=-1;h<=1;h++)0!=d||0!=h&&null!==this.modules[i+d][o+h]&&(c=!0)}this.modules[i][o]=c?!l:l,r--,0==r&&(r=7,o--),o<0&&(o=this.moduleCount-1,i--)}},u++},getBestMaskPattern:function(){for(var e=0,t=0,n=0;n<8;n++){this.makeImpl(!0,n);var o=QRCode.getLostPoint(this);if(0==n||e>o)e=o,t=n}return t}};var n=function(e){this.typeNumber=e,this.errorCorrectionLevel=QRCode.ErrorCorrectionLevel.H,this.qrCode=null,this.dataList=[]},o={};o.create=function(e,t){var n=new t;return n.typeNumber=e,n.errorCorrectionLevel=QRCode.ErrorCorrectionLevel.H,n.qrCode=new window.QRCode(n.typeNumber,null,n.errorCorrectionLevel),n};var i=function(e,t){this.mode=t,this.data=e};i.prototype={getLength:function(e){switch(this.mode){case QRCode.Mode.NUMERIC:return this.getNumericLength(e);case QRCode.Mode.ALPHANUMERIC:return this.getAlphanumericLength(e);case QRCode.Mode.EIGHT_BIT_BYTE:return this.getEightBitByteLength(e);case QRCode.Mode.KANJI:return this.getKanjiLength(e);default:throw new Error("mode:"+this.mode)}},getNumericLength:function(e){return this.data.length},getAlphanumericLength:function(e){return this.data.length},getEightBitByteLength:function(e){return this.data.length},getKanjiLength:function(e){return this.data.length}};var r=function(e){i.call(this,e,QRCode.Mode.EIGHT_BIT_BYTE)};r.prototype=Object.create(i.prototype),r.prototype.constructor=r,r.fromString=function(e){var t=[];for(var n=0,o=e.length;n<o;n++){var i=e.charCodeAt(n);t.push(i)}return new r(t)};var s={};s.POSITION_DETECTION_PATTERN=[7,1,1,1,1,1,7,1,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,1,7,1,1,1,1,1,7],s.POSITION_DETECTION_PATTERN_COORDINATE=[[0,0],[0,4],[4,0],[4,4],[0,8],[4,8],[8,0],[8,4],[8,8],[0,12],[4,12],[8,12],[12,0],[12,4],[12,8],[12,12],[0,16],[4,16],[8,16],[12,16],[16,0],[16,4],[16,8],[16,12],[16,16],[0,20],[4,20],[8,20],[12,20],[16,20],[20,0],[20,4],[20,8],[20,12],[20,16],[20,20],[0,24],[4,24],[8,24],[12,24],[16,24],[20,24],[24,0],[24,4],[24,8],[24,12],[24,16],[24,20],[24,24],[0,28],[4,28],[8,28],[12,28],[16,28],[20,28],[24,28],[28,0],[28,4],[28,8],[28,12],[28,16],[28,20],[28,24],[28,28],[0,32],[4,32],[8,32],[12,32],[16,32],[20,32],[24,32],[28,32],[32,0],[32,4],[32,8],[32,12],[32,16],[32,20],[32,24],[32,28],[32,32]];var a={};a.NUMERIC=1,a.ALPHANUMERIC=2,a.EIGHT_BIT_BYTE=4,a.KANJI=8;var u={};u.L=1,u.M=0,u.Q=3,u.H=2;var l={};l.PATTERN_POSITION_TABLE=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],l.G15=107,l.G18=273,l.G15_MASK=21522,l.getBCHTypeInfo=function(e){for(var t=e<<10;t^l.G15>>0;){var n=0;for(;0==(1&(t>>14-n));)n++;t^=l.G15<<n}return(e<<10|t)^l.G15_MASK},l.getBCHTypeNumber=function(e){for(var t=e<<12;t^l.G18>>0;){var n=0;for(;0==(1&(t>>14-n));)n++;t^=l.G18<<n}return e<<12|t},l.getPatternPosition=function(e){return l.PATTERN_POSITION_TABLE[e-1]},l.createData=function(e,t,n){var o=function(e,t,n){for(var o=0;;o++){var i=QRCode.getMaxDataCount(o,e);for(var r=0;r<n.length;r++){var s=n[r];i-=s.getLength(o);if(i<0)break}if(i>=0)return o;if(10<o)throw new Error("too long")}(e,t,n);for(var i=[],r=0;r<n.length;r++)i.push(n[r]);var s=function(e,t,n){for(var o=[],i=0;i<n.length;i++){var r=n[i];o.push(r.mode),o.push(r.getLength(e));var s=r.data;for(var a=0;a<s.length;a++)o.push(s[a])}var u=[];for(var l=0;l<o.length;l++)u=u.concat(QRCode.getBitPattern(o[l],8));var c=QRCode.getMaxDataCount(e,t);for(;u.length+4<=8*c;)u=u.concat([0,0,0,0]);for(;u.length%8!=0;)u.push(0);for(var d=[],h=0;h<u.length;h+=8){for(var p=0,f=0;f<8;f++)p=p<<1|u[h+f];d.push(p)}return d}(o,t,i);return s},l.getMaxDataCount=function(e,t){switch(t){case QRCode.ErrorCorrectionLevel.L:return[17,32,53,78,106,134,154,192,230,271,321,367,425,458,520,586,644,718,792,858,929,1003,1091,1171,1273,1367,1465,1528,1628,1732,1840,1952,2068,2188,2303,2431,2563,2699,2809,2953][e];case QRCode.ErrorCorrectionLevel.M:return[14,26,42,62,84,106,122,152,180,213,251,287,331,362,412,450,504,560,624,666,711,779,857,911,997,1059,1125,1190,1264,1370,1452,1538,1628,1722,1809,1911,1989,2099,2213,2331][e];case QRCode.ErrorCorrectionLevel.Q:return[11,20,32,46,60,74,86,108,130,151,177,203,241,258,292,322,364,394,442,482,509,565,611,661,715,751,805,868,908,982,1030,1112,1168,1228,1283,1351,1423,1499,1579,1663][e];case QRCode.ErrorCorrectionLevel.H:return[7,14,24,34,44,58,64,84,98,119,137,155,177,194,220,250,280,310,338,382,403,439,461,511,535,593,625,658,698,742,790,842,898,958,1013,1091,1139,1219,1273,1329][e];default:throw new Error("ecl:"+t)}},l.getLostPoint=function(e){for(var t=e.getModuleCount(),n=0,o=0;o<t;o++)for(var i=0;i<t;i++){for(var r=0,s=e.isDark(o,i),a=1;a<=5&&o+a<t&&s==e.isDark(o+a,i);a++);a>=5&&(n+=a-2)}for(var o=0;o<t;o++)for(var i=0;i<t;i++){for(var r=0,s=e.isDark(o,i),a=1;a<=5&&i+a<t&&s==e.isDark(o,i+a);a++);a>=5&&(n+=a-2)}for(var o=0;o<t-1;o++)for(var i=0;i<t-1;i++){var u=0;e.isDark(o,i)&&u++,e.isDark(o+1,i)&&u++,e.isDark(o,i+1)&&u++,e.isDark(o+1,i+1)&&u++,0==u||4==u&&(n+=3)}for(var l=0,c=0;l<t;l++)for(var i=0;i<t;i++)e.isDark(l,i)&&c++;var d=Math.abs(100*c/t/t-50)/5;n+=10*d;return n},l.getBitPattern=function(e,t){for(var n=[],o=0;o<t;o++)n.push(1&(e>>t-1-o));return n};return QRCode=t,QRCode.Mode=a,QRCode.ErrorCorrectionLevel=u,QRCode.PatternPosition=l.PATTERN_POSITION_TABLE,QRCode.getPatternPosition=l.getPatternPosition,QRCode.createData=l.createData,QRCode.getBCHTypeInfo=l.getBCHTypeInfo,QRCode.getBCHTypeNumber=l.getBCHTypeNumber,QRCode.getLostPoint=l.getLostPoint,QRCode.getMaxDataCount=l.getMaxDataCount,QRCode.getBitPattern=l.getBitPattern,QR8bitByte=r,QRCode});
    </script>

    <!-- 第二步：加载Supabase库（备用CDN，更稳定） -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <!-- 第三步：加载本地配置文件 -->
    <script src="js/qrcode.js"></script>

    <!-- 第四步：核心业务逻辑（按钮绑定+数据加载+二维码生成） -->
    <script>
        // 全局元素获取（一次性获取，避免重复DOM查询）
        const el = {
            errorAlert: document.getElementById('errorAlert'),
            loadingAlert: document.getElementById('loadingAlert'),
            tabUser: document.getElementById('tabUser'),
            tabGame: document.getElementById('tabGame'),
            btnPrint: document.getElementById('btnPrint'),
            btnRefresh: document.getElementById('btnRefresh'),
            btnTest: document.getElementById('btnTest'),
            userGrid: document.getElementById('userGrid'),
            gameGrid: document.getElementById('gameGrid')
        };
        // 全局变量
        let supabaseClient = null;
        let activeTab = 'user'; // 默认激活用户标签

        // 工具函数：提示框控制
        function showAlert(dom, text) { dom.innerText = text; dom.style.display = 'block'; }
        function hideAlert(dom) { dom.style.display = 'none'; }
        function showError(text) { showAlert(el.errorAlert, text); hideAlert(el.loadingAlert); }
        function showLoading() { showAlert(el.loadingAlert, '加载中，请稍候...'); hideAlert(el.errorAlert); }
        function clearAllAlert() { hideAlert(el.errorAlert); hideAlert(el.loadingAlert); }

        // 前置校验：配置+库是否正常（失败直接显示错误）
        function preCheck() {
            // 校验QRCode库（内嵌后必存在，兜底校验）
            if (typeof QRCode === 'undefined') {
                showError('❌ 二维码库初始化失败');
                return false;
            }
            // 校验Supabase库
            if (typeof supabase === 'undefined') {
                showError('❌ 数据库连接库加载失败，请检查网络');
                return false;
            }
            // 校验配置文件
            if (!window.qrConfig || !window.qrConfig.supabaseUrl || !window.qrConfig.supabaseKey) {
                showError('❌ 未找到配置文件js/qrcode.js或凭证为空');
                return false;
            }
            // 校验凭证是否为默认占位符
            if (window.qrConfig.supabaseUrl.includes("你的项目ID") || window.qrConfig.supabaseKey.includes("你的anon public key")) {
                showError('❌ 请在js/qrcode.js中替换为真实的Supabase URL和Key');
                return false;
            }
            return true;
        }

        // 初始化Supabase客户端
        function initSupabase() {
            try {
                supabaseClient = supabase.createClient(
                    window.qrConfig.supabaseUrl,
                    window.qrConfig.supabaseKey,
                    {
                        global: {
                            fetch: (url, opts = {}) => {
                                opts.signal = AbortSignal.timeout(window.qrConfig.timeout);
                                return fetch(url, opts);
                            }
                        }
                    }
                );
                return true;
            } catch (err) {
                showError(`❌ 数据库客户端初始化失败：${err.message.slice(0, 50)}`);
                return false;
            }
        }

        // 生成二维码卡片（含下载功能）
        function createQrCard(qrId, labelText, qrContent, downloadName) {
            const card = document.createElement('div');
            card.className = 'qr-card';

            // 二维码容器
            const qrContainer = document.createElement('div');
            qrContainer.id = qrId;
            qrContainer.className = 'qr-img';
            // 生成二维码
            new QRCode(qrContainer, {
                text: qrContent,
                width: window.qrConfig.qr.width,
                height: window.qrConfig.qr.height,
                colorDark: window.qrConfig.qr.colorDark,
                colorLight: window.qrConfig.qr.colorLight,
                correctLevel: window.qrConfig.qr.correctLevel
            });

            // 二维码标签
            const label = document.createElement('div');
            label.className = 'qr-label';
            label.innerText = labelText;

            // 下载按钮
            const downBtn = document.createElement('button');
            downBtn.className = 'download-btn';
            downBtn.innerText = '下载QR Code';
            downBtn.onclick = () => {
                const canvas = qrContainer.querySelector('canvas');
                if (!canvas) {
                    alert('❌ 二维码未生成，无法下载');
                    return;
                }
                const a = document.createElement('a');
                a.download = `${downloadName}-QRCode.png`;
                a.href = canvas.toDataURL('image/png', 1.0); // 高清PNG
                a.click();
            };

            // 组装卡片
            card.appendChild(qrContainer);
            card.appendChild(label);
            card.appendChild(downBtn);
            return card;
        }

        // 加载用户数据并生成二维码
        async function loadUserList() {
            if (!supabaseClient) return;
            showLoading();
            el.userGrid.innerHTML = '加载用户数据中...';
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('id, username')
                    .order('username');
                if (error) throw error;
                // 无数据处理
                if (!data || data.length === 0) {
                    el.userGrid.innerHTML = '❌ 暂无用户数据，请先在数据库添加';
                    hideAlert(el.loadingAlert);
                    return;
                }
                // 生成二维码卡片
                el.userGrid.innerHTML = '';
                data.forEach(user => {
                    el.userGrid.appendChild(createQrCard(
                        `qr-user-${user.id}`,
                        user.username,
                        user.username,
                        `user-${user.username}`
                    ));
                });
            } catch (err) {
                el.userGrid.innerHTML = `❌ 加载用户失败：${getFriendlyErrMsg(err)}`;
            } finally {
                hideAlert(el.loadingAlert);
            }
        }

        // 加载游戏数据并生成二维码
        async function loadGameList() {
            if (!supabaseClient) return;
            showLoading();
            el.gameGrid.innerHTML = '加载游戏数据中...';
            try {
                const { data, error } = await supabaseClient
                    .from('games')
                    .select('id, game_code, game_name')
                    .order('game_code');
                if (error) throw error;
                // 无数据处理
                if (!data || data.length === 0) {
                    el.gameGrid.innerHTML = '❌ 暂无游戏数据，请先在数据库添加';
                    hideAlert(el.loadingAlert);
                    return;
                }
                // 生成二维码卡片
                el.gameGrid.innerHTML = '';
                data.forEach(game => {
                    el.gameGrid.appendChild(createQrCard(
                        `qr-game-${game.id}`,
                        `${game.game_code} (${game.game_name})`,
                        game.game_code,
                        `game-${game.game_code}`
                    ));
                });
            } catch (err) {
                el.gameGrid.innerHTML = `❌ 加载游戏失败：${getFriendlyErrMsg(err)}`;
            } finally {
                hideAlert(el.loadingAlert);
            }
        }

        // 测试数据库连接
        async function testDatabaseConn() {
            if (!supabaseClient) return;
            showLoading();
            el.userGrid.innerHTML = '测试数据库连接中...';
            try {
                // 简单查询用户表，仅查1条
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .limit(1);
                if (error) throw error;
                el.userGrid.innerHTML = `✅ 数据库连接成功！用户表当前有${data.length}条数据`;
            } catch (err) {
                el.userGrid.innerHTML = `❌ 数据库连接失败：${getFriendlyErrMsg(err)}`;
            } finally {
                hideAlert(el.loadingAlert);
            }
        }

        // 错误信息格式化：转为用户能看懂的中文
        function getFriendlyErrMsg(err) {
            if (!err || !err.message) return '未知错误';
            const msg = err.message;
            if (msg.includes('401')) return 'Supabase Key错误（请检查anon public key）';
            if (msg.includes('404')) return 'Supabase URL错误（请检查项目地址）';
            if (msg.includes('CORS')) return '跨域配置错误（需在Supabase添加你的域名）';
            if (msg.includes('timeout') || msg.includes('AbortError')) return '请求超时（网络/数据库服务器问题）';
            if (msg.includes('Failed to fetch')) return '网络连接失败，请检查服务器网络';
            if (msg.includes('relation "users" does not exist')) return '数据库中无users表，请先创建表';
            return msg.slice(0, 50); // 过长错误截断
        }

        // 标签切换逻辑
        function switchTab(tabType) {
            if (tabType === activeTab) return;
            activeTab = tabType;
            // 切换标签样式
            el.tabUser.classList.toggle('active', tabType === 'user');
            el.tabGame.classList.toggle('active', tabType === 'game');
            // 切换内容区域
            el.userGrid.style.display = tabType === 'user' ? 'grid' : 'none';
            el.gameGrid.style.display = tabType === 'game' ? 'grid' : 'none';
            // 切换后如果未加载，自动加载数据
            if (tabType === 'game' && el.gameGrid.innerHTML.includes('加载游戏数据中')) {
                loadGameList();
            }
        }

        // 绑定所有按钮事件（核心：直接绑定，100%响应）
        function bindAllEvents() {
            // 标签切换
            el.tabUser.onclick = () => switchTab('user');
            el.tabGame.onclick = () => switchTab('game');
            // 打印
            el.btnPrint.onclick = () => window.print();
            // 刷新数据（刷新当前激活标签）
            el.btnRefresh.onclick = () => {
                activeTab === 'user' ? loadUserList() : loadGameList();
            };
            // 测试数据库连接
            el.btnTest.onclick = testDatabaseConn;
        }

        // 页面初始化入口（分步执行，异常全捕获）
        async function initPage() {
            // 1. 前置校验，失败直接退出
            if (!preCheck()) return;
            // 2. 初始化数据库客户端，失败直接退出
            if (!initSupabase()) return;
            // 3. 绑定所有按钮事件（这一步后按钮全部可点击）
            bindAllEvents();
            // 4. 加载默认标签（用户）数据
            await loadUserList();
            // 5. 隐藏所有提示框
            clearAllAlert();
        }

        // DOM加载完成后执行初始化（避免元素未找到）
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
