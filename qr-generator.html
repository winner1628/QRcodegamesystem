<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 生成器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; text-align: center; font-weight: 600; display: none; }
        .error { background: #fef2f2; color: #dc2626; border: 1px solid #fecdd3; }
        .loading { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        h1 { text-align: center; color: #dc2626; margin-bottom: 8px; font-size: 22px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 15px; }
        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn { padding: 8px 20px; border: none; border-radius: 4px; background: #e2e8f0; cursor: pointer; font-size: 15px; }
        .tab-btn.active { background: #dc2626; color: #fff; }
        .actions { text-align: center; margin-bottom: 20px; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 14px; margin: 0 4px; }
        .btn-print { background: #16a34a; }
        .btn-refresh { background: #f59e0b; }
        .btn-test { background: #6366f1; }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 18px; }
        .qr-card { text-align: center; padding: 15px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .qr-container { width: 180px; height: 180px; margin: 0 auto 10px; background: #fff; border: 1px solid #eee; }
        .qr-img { width: 100%; height: 100%; }
        .qr-label { font-size: 16px; color: #333; font-weight: 600; margin-bottom: 10px; word-break: break-all; }
        .download-btn { padding: 6px 15px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .status { text-align: center; padding: 40px 0; color: #64748b; font-size: 16px; }
        @media print { 
            .alert, .tabs, .actions, .download-btn { display: none; } 
            .qr-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; } 
            .qr-container { width: 140px !important; height: 140px !important; }
        }
        @media (max-width: 768px) {
            .qr-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .qr-container { width: 150px !important; height: 150px !important; }
            .action-btn { padding: 6px 12px; margin: 0 2px 6px; }
            .tab-btn { padding: 6px 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="errorAlert" class="alert error">❌ 请先测试数据库连接</div>
        <div id="loadingAlert" class="alert loading">⌛ 加载中...</div>

        <h1>QR Code 生成器</h1>
        <p class="subtitle">用户/游戏二维码生成（支持下载/打印）</p>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('user')">用户 QR Code</button>
            <button class="tab-btn" onclick="switchTab('game')">游戏 QR Code</button>
        </div>
        <div class="actions">
            <button class="action-btn btn-print" onclick="window.print()">列印所有</button>
            <button class="action-btn btn-refresh" onclick="refreshData()">刷新數據</button>
            <button class="action-btn btn-test" onclick="testConn()">測試連接</button>
        </div>

        <div id="userGrid" class="qr-grid status">点击「測試連接」验证数据库</div>
        <div id="gameGrid" class="qr-grid status" style="display: none;">切换后加载游戏数据</div>
    </div>

    <!-- 修复1：更换稳定的QRCode.js CDN地址 + 调整加载顺序（先加载QRCode，再加载其他） -->
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="js/qrcode.js"></script>
    <script>
        // 全局变量
        let supabaseClient = null;
        let activeTab = 'user';
        const { size: qrSize, color: qrColor, bgColor: qrBg, textSize, textColor } = window.qrConfig.qr;

        // 基础工具函数
        function show(id) { document.getElementById(id).style.display = 'block'; }
        function hide(id) { document.getElementById(id).style.display = 'none'; }
        function hideAllAlerts() { hide('errorAlert'); hide('loadingAlert'); }
        function showError(txt) { show('errorAlert'); document.getElementById('errorAlert').innerText = `❌ ${txt}`; }
        function showLoading(txt) { show('loadingAlert'); document.getElementById('loadingAlert').innerText = `⌛ ${txt || '加载中...'}`; }

        // 修复2：增加QRCode库加载校验 + 兜底逻辑
        function checkQRCodeLib() {
            if (typeof QRCode === 'undefined') {
                showError('二维码生成库加载失败，请检查网络或刷新页面');
                return false;
            }
            return true;
        }

        // 核心：生成二维码（增加前置校验）
        function createQRCode(canvas, text) {
            // 先校验库是否加载成功
            if (!checkQRCodeLib()) return;
            
            // 使用标准的QRCode.js生成（兼容所有扫码工具）
            QRCode.toCanvas(canvas, text, {
                width: qrSize,
                color: {
                    dark: qrColor,
                    light: qrBg
                },
                margin: 1
            }, (error) => {
                if (error) showError('二维码生成失败：' + error.message.slice(0, 20));
            });
        }

        // 生成二维码卡片
        function createQrCard(id, label, content, downName) {
            const card = document.createElement('div');
            card.className = 'qr-card';

            const qrBox = document.createElement('div');
            qrBox.className = 'qr-container';
            
            const canvas = document.createElement('canvas');
            canvas.id = id;
            canvas.className = 'qr-img';
            createQRCode(canvas, content); // 生成二维码
            
            qrBox.appendChild(canvas);

            const qrLabel = document.createElement('div');
            qrLabel.className = 'qr-label';
            qrLabel.innerText = label;
            qrLabel.style.fontSize = `${textSize}px`;
            qrLabel.style.color = textColor;

            const downBtn = document.createElement('button');
            downBtn.className = 'download-btn';
            downBtn.innerText = '下载QR Code';
            downBtn.onclick = () => {
                try {
                    const a = document.createElement('a');
                    a.download = `${downName}-QRCode.png`;
                    a.href = canvas.toDataURL('image/png', 1.0);
                    a.click();
                } catch (e) {
                    alert('❌ 下载失败，请检查浏览器权限');
                }
            };

            card.appendChild(qrBox);
            card.appendChild(qrLabel);
            card.appendChild(downBtn);
            return card;
        }

        // 初始化Supabase
        function initSupabase() {
            if (supabaseClient) return true;
            try {
                supabaseClient = supabase.createClient(
                    window.qrConfig.supabaseUrl,
                    window.qrConfig.supabaseKey,
                    { global: { fetch: (u, o) => fetch(u, { ...o, signal: AbortSignal.timeout(window.qrConfig.timeout) }) } }
                );
                return true;
            } catch (e) {
                showError('Supabase初始化失败：' + e.message.slice(0, 30));
                return false;
            }
        }

        // 测试数据库连接
        async function testConn() {
            hideAllAlerts();
            showLoading('测试数据库连接...');
            // 先校验QRCode库
            if (!checkQRCodeLib()) {
                hide('loadingAlert');
                return;
            }
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('users').select('*').limit(1);
                if (error) throw error;
                hideAllAlerts();
                document.getElementById('userGrid').innerHTML = `✅ 连接成功！点击「刷新數據」加载二维码`;
            } catch (e) {
                const msg = e.message.includes('401') ? 'Supabase Key错误' : 
                            e.message.includes('CORS') ? '跨域配置错误（需在Supabase添加域名）' : 
                            e.message.includes('timeout') ? '请求超时（网络问题）' : 
                            e.message.slice(0, 30);
                showError('连接失败：' + msg);
            }
        }

        // 加载用户数据（修复3：增加库校验）
        async function loadUsers() {
            hideAllAlerts();
            showLoading('加载用户二维码...');
            if (!checkQRCodeLib()) {
                hide('loadingAlert');
                return;
            }
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('users').select('id, username').order('username');
                if (error) throw error;
                if (!data || data.length === 0) {
                    document.getElementById('userGrid').innerHTML = '❌ 暂无用户数据';
                    hideAllAlerts();
                    return;
                }
                const userGrid = document.getElementById('userGrid');
                userGrid.innerHTML = '';
                data.forEach(u => {
                    userGrid.appendChild(createQrCard(`qr-u-${u.id}`, u.username, u.username, `user-${u.username}`));
                });
                hideAllAlerts();
            } catch (e) {
                showError('加载用户失败：' + e.message.slice(0, 30));
            }
        }

        // 加载游戏数据（修复4：和用户数据逻辑保持一致，增加库校验）
        async function loadGames() {
            hideAllAlerts();
            showLoading('加载游戏二维码...');
            // 先校验QRCode库是否加载成功
            if (!checkQRCodeLib()) {
                hide('loadingAlert');
                return;
            }
            if (!initSupabase()) return;
            try {
                const { data, error } = await supabaseClient.from('games').select('id, game_code, game_name').order('game_code');
                if (error) throw error;
                if (!data || data.length === 0) {
                    document.getElementById('gameGrid').innerHTML = '❌ 暂无游戏数据';
                    hideAllAlerts();
                    return;
                }
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';
                data.forEach(g => {
                    const label = `${g.game_code}\n(${g.game_name})`;
                    gameGrid.appendChild(createQrCard(`qr-g-${g.id}`, label, g.game_code, `game-${g.game_code}`));
                });
                hideAllAlerts();
            } catch (e) {
                // 明确提示错误原因
                const errMsg = e.message.includes('QRCode is not defined') 
                    ? '二维码库加载失败，请刷新页面' 
                    : e.message.slice(0, 30);
                showError('加载游戏失败：' + errMsg);
            }
        }

        // 切换标签
        function switchTab(tab) {
            if (tab === activeTab) return;
            activeTab = tab;
            const tabs = document.querySelectorAll('.tab-btn');
            tabs[0].className = tab === 'user' ? 'tab-btn active' : 'tab-btn';
            tabs[1].className = tab === 'game' ? 'tab-btn active' : 'tab-btn';
            hide('userGrid'); hide('gameGrid');
            show(tab + 'Grid');
            if (tab === 'game' && document.getElementById('gameGrid').innerHTML.includes('切换后加载')) {
                loadGames();
            }
        }

        // 刷新数据
        function refreshData() {
            // 先校验QRCode库
            if (!checkQRCodeLib()) return;
            activeTab === 'user' ? loadUsers() : loadGames();
        }

        // 页面加载完成：先校验QRCode库
        window.onload = function() {
            hideAllAlerts();
            // 页面加载后立即校验库
            checkQRCodeLib();
        };
    </script>
</body>
</html>
