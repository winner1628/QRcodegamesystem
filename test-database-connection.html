<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库连接测试 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.5/dist/umd/supabase.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        info: '#0ea5e9',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .btn-primary {
                @apply bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all;
            }
            .btn-secondary {
                @apply bg-secondary text-white px-6 py-3 rounded-lg font-medium hover:bg-secondary/90 focus:outline-none focus:ring-2 focus:ring-secondary/50 transition-all;
            }
            .card {
                @apply bg-white rounded-xl shadow-lg border border-gray-200;
            }
            .status-indicator {
                @apply w-3 h-3 rounded-full inline-block mr-2;
            }
            .status-online {
                @apply bg-success;
            }
            .status-offline {
                @apply bg-error;
            }
            .status-warning {
                @apply bg-warning;
            }
            .log-entry {
                @apply p-2 border-l-4 mb-2 transition-all;
            }
            .log-success {
                @apply border-success bg-green-50;
            }
            .log-error {
                @apply border-error bg-red-50;
            }
            .log-warning {
                @apply border-warning bg-yellow-50;
            }
            .log-info {
                @apply border-info bg-blue-50;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">数据库连接测试</h1>
            <p class="text-gray-600 mt-2">测试系统与数据库的连接和表结构</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 左侧状态面板 -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fa fa-database mr-2"></i>连接状态
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Supabase URL:</span>
                        <span id="databaseUrl" class="text-sm text-gray-500 truncate max-w-[200px]">
                            -
                        </span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">客户端初始化:</span>
                        <span id="clientStatus" class="flex items-center">
                            <span class="status-indicator status-offline"></span>
                            <span>未初始化</span>
                        </span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">数据库连接:</span>
                        <span id="connectionStatus" class="flex items-center">
                            <span class="status-indicator status-offline"></span>
                            <span>未连接</span>
                        </span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="testConnectionBtn" class="btn-primary w-full mb-3">
                        <i class="fa fa-plug mr-2"></i>测试连接
                    </button>
                    
                    <button id="checkTablesBtn" class="btn-secondary w-full">
                        <i class="fa fa-table mr-2"></i>检查表结构
                    </button>
                </div>
            </div>

            <!-- 右侧表结构面板 -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fa fa-list-alt mr-2"></i>表结构检查
                </h2>
                
                <div id="tablesContainer" class="space-y-3 mb-4">
                    <div class="text-gray-500 text-center py-8">
                        <i class="fa fa-info-circle text-2xl mb-2"></i>
                        <p>点击上方按钮检查表结构...</p>
                    </div>
                </div>
                
                <div class="text-center">
                    <a href="index.html" class="text-primary hover:text-primary/80 transition-colors">
                        <i class="fa fa-arrow-left mr-1"></i>返回首页
                    </a>
                </div>
            </div>
        </div>

        <!-- 日志面板 -->
        <div class="card p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fa fa-terminal mr-2"></i>测试日志
            </h2>
            
            <div id="logsContainer" class="h-60 overflow-y-auto bg-gray-50 rounded-lg p-3">
                <div class="text-gray-500 text-center py-8">
                    <i class="fa fa-info-circle text-2xl mb-2"></i>
                    <p>点击上方按钮开始测试...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM 元素
        const elements = {
            databaseUrl: document.getElementById('databaseUrl'),
            clientStatus: document.getElementById('clientStatus'),
            connectionStatus: document.getElementById('connectionStatus'),
            testConnectionBtn: document.getElementById('testConnectionBtn'),
            checkTablesBtn: document.getElementById('checkTablesBtn'),
            tablesContainer: document.getElementById('tablesContainer'),
            logsContainer: document.getElementById('logsContainer')
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            updateDatabaseUrl();
        });

        // 初始化事件监听器
        function initializeEventListeners() {
            elements.testConnectionBtn.addEventListener('click', testConnection);
            elements.checkTablesBtn.addEventListener('click', checkTables);
        }

        // 更新数据库 URL 显示
        function updateDatabaseUrl() {
            if (window.AppConfig && window.AppConfig.supabase) {
                elements.databaseUrl.textContent = window.AppConfig.supabase.url;
                elements.databaseUrl.title = window.AppConfig.supabase.url;
            }
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            logEntry.innerHTML = `
                <div class="flex items-start">
                    <span class="text-xs text-gray-500 mr-2 whitespace-nowrap">${timestamp}</span>
                    <span class="flex-1">${message}</span>
                </div>
            `;
            
            // 清空初始提示
            if (elements.logsContainer.querySelector('.text-gray-500')) {
                elements.logsContainer.innerHTML = '';
            }
            
            elements.logsContainer.appendChild(logEntry);
            elements.logsContainer.scrollTop = elements.logsContainer.scrollHeight;
        }

        // 更新客户端状态
        function updateClientStatus(status) {
            const indicator = elements.clientStatus.querySelector('.status-indicator');
            const text = elements.clientStatus.querySelector('span:last-child');
            
            indicator.className = `status-indicator status-${status}`;
            text.textContent = status === 'online' ? '已初始化' : 
                              status === 'warning' ? '部分功能' : '未初始化';
        }

        // 更新连接状态
        function updateConnectionStatus(status) {
            const indicator = elements.connectionStatus.querySelector('.status-indicator');
            const text = elements.connectionStatus.querySelector('span:last-child');
            
            indicator.className = `status-indicator status-${status}`;
            text.textContent = status === 'online' ? '已连接' : 
                              status === 'warning' ? '连接受限' : '未连接';
        }

        // 测试连接
        async function testConnection() {
            try {
                elements.testConnectionBtn.disabled = true;
                elements.testConnectionBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>测试中...';
                
                addLog('开始测试数据库连接...', 'info');
                
                // 检查配置
                if (!window.AppConfig || !window.AppConfig.supabase) {
                    throw new Error('AppConfig 未正确加载');
                }
                
                addLog(`使用 Supabase URL: ${window.AppConfig.supabase.url}`, 'info');
                
                // 尝试直接创建客户端
                let supabaseClient;
                try {
                    supabaseClient = window.supabase.createClient(
                        window.AppConfig.supabase.url,
                        window.AppConfig.supabase.key
                    );
                    addLog('成功创建 Supabase 客户端实例', 'success');
                    updateClientStatus('online');
                } catch (clientError) {
                    addLog(`创建客户端失败: ${clientError.message}`, 'error');
                    updateClientStatus('offline');
                    throw clientError;
                }
                
                // 测试连接
                try {
                    // 尝试调用 pg_version RPC
                    const { data, error } = await supabaseClient.rpc('pg_version');
                    
                    if (error) {
                        addLog(`RPC 调用失败: ${error.message}`, 'warning');
                        
                        // 尝试查询表
                        const { data: tablesData, error: tablesError } = await supabaseClient.from('admins').select('id').limit(1);
                        
                        if (tablesError) {
                            throw new Error(`查询失败: ${tablesError.message}`);
                        }
                        
                        addLog('成功查询 admins 表', 'success');
                    } else {
                        addLog(`成功连接到 PostgreSQL ${data}`, 'success');
                    }
                    
                    updateConnectionStatus('online');
                    addLog('数据库连接测试成功！', 'success');
                    
                } catch (connectionError) {
                    addLog(`连接测试失败: ${connectionError.message}`, 'error');
                    updateConnectionStatus('offline');
                    throw connectionError;
                }
                
            } catch (error) {
                addLog(`测试过程中发生异常: ${error.message}`, 'error');
                
            } finally {
                elements.testConnectionBtn.disabled = false;
                elements.testConnectionBtn.innerHTML = '<i class="fa fa-plug mr-2"></i>测试连接';
            }
        }

        // 检查表结构
        async function checkTables() {
            try {
                elements.checkTablesBtn.disabled = true;
                elements.checkTablesBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>检查中...';
                
                addLog('开始检查表结构...', 'info');
                
                // 检查数据库管理器
                let dbManager;
                if (window.databaseManager) {
                    dbManager = window.databaseManager;
                    addLog('使用已存在的数据库管理器', 'info');
                } else {
                    dbManager = new DatabaseManager();
                    window.databaseManager = dbManager;
                    addLog('创建新的数据库管理器实例', 'info');
                }
                
                if (!dbManager.supabase) {
                    throw new Error('数据库管理器未正确初始化');
                }
                
                // 检查表结构
                const tablesToCheck = ['admins', 'users', 'games', 'game_records', 'game_statistics'];
                const tablesStatus = {};
                
                // 清空表容器
                elements.tablesContainer.innerHTML = '';
                
                for (const table of tablesToCheck) {
                    try {
                        const { data, error } = await dbManager.supabase.from(table).select('*').limit(1);
                        
                        if (error) {
                            addLog(`表 ${table} 不存在或无法访问: ${error.message}`, 'error');
                            tablesStatus[table] = { exists: false, error: error.message };
                        } else {
                            const count = data ? data.length : 0;
                            addLog(`成功访问表 ${table} (${count} 条记录)`, 'success');
                            tablesStatus[table] = { exists: true, count: count };
                        }
                    } catch (tableError) {
                        addLog(`检查表 ${table} 时发生异常: ${tableError.message}`, 'error');
                        tablesStatus[table] = { exists: false, error: tableError.message };
                    }
                }
                
                // 显示表状态
                for (const [table, status] of Object.entries(tablesStatus)) {
                    const tableElement = document.createElement('div');
                    tableElement.className = 'flex items-center justify-between p-3 rounded-lg border';
                    
                    if (status.exists) {
                        tableElement.className += ' border-green-200 bg-green-50';
                        tableElement.innerHTML = `
                            <span class="flex items-center">
                                <i class="fa fa-check-circle text-green-500 mr-2"></i>
                                ${table}
                            </span>
                            <span class="text-sm text-gray-600">${status.count} 条记录</span>
                        `;
                    } else {
                        tableElement.className += ' border-red-200 bg-red-50';
                        tableElement.innerHTML = `
                            <span class="flex items-center">
                                <i class="fa fa-times-circle text-red-500 mr-2"></i>
                                ${table}
                            </span>
                            <span class="text-sm text-red-600">不可访问</span>
                        `;
                    }
                    
                    elements.tablesContainer.appendChild(tableElement);
                }
                
                // 检查是否所有表都存在
                const allTablesExist = Object.values(tablesStatus).every(status => status.exists);
                
                if (allTablesExist) {
                    addLog('所有表结构检查完成，表结构正确！', 'success');
                } else {
                    addLog('部分表无法访问，请检查数据库初始化', 'warning');
                }
                
            } catch (error) {
                addLog(`检查表结构过程中发生异常: ${error.message}`, 'error');
                
            } finally {
                elements.checkTablesBtn.disabled = false;
                elements.checkTablesBtn.innerHTML = '<i class="fa fa-table mr-2"></i>检查表结构';
            }
        }
    </script>
</body>
</html>