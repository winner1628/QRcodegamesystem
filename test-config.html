<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置文件測試</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            border: 1px solid;
        }
        .success {
            background-color: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }
        .error {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }
        .warning {
            background-color: #fef3c7;
            border-color: #fcd34d;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6 text-center">配置文件加載測試</h1>
        
        <div id="testResults" class="space-y-4">
            <!-- 測試結果將在這裡顯示 -->
        </div>
        
        <div class="mt-8 text-center">
            <button onclick="runAllTests()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                重新運行所有測試
            </button>
            <a href="index.html" class="ml-4 px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                返回首頁
            </a>
        </div>
    </div>

    <!-- 配置文件 -->
    <script src="config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            runAllTests();
        });
        
        function runAllTests() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';
            
            // 1. 檢查配置文件是否加載
            testConfigLoad();
            
            // 2. 檢查配置結構
            testConfigStructure();
            
            // 3. 檢查URL和密鑰格式
            testConfigValues();
            
            // 4. 測試Supabase連接（如果配置有效）
            if (window.config && window.config.supabase) {
                testSupabaseConnection();
            }
        }
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            
            let icon = '';
            switch (type) {
                case 'success': icon = '✅'; break;
                case 'error': icon = '❌'; break;
                case 'warning': icon = '⚠️'; break;
                default: icon = 'ℹ️';
            }
            
            div.innerHTML = `<strong>${icon} ${message}</strong>`;
            results.appendChild(div);
        }
        
        function testConfigLoad() {
            addResult('正在檢查配置文件加載...');
            
            if (typeof window.config !== 'undefined') {
                addResult('配置文件成功加載到全局作用域', 'success');
                addResult(`配置類型: ${typeof window.config}`, 'success');
                
                // 顯示配置的字符串表示（隱藏敏感信息）
                const configStr = JSON.stringify(window.config, (key, value) => {
                    if (key === 'anonKey' && typeof value === 'string') {
                        return value.substring(0, 10) + '...' + value.substring(value.length - 10);
                    }
                    return value;
                }, 2);
                
                const pre = document.createElement('pre');
                pre.style.backgroundColor = '#f8fafc';
                pre.style.padding = '1rem';
                pre.style.borderRadius = '0.5rem';
                pre.style.overflow = 'auto';
                pre.textContent = configStr;
                document.getElementById('testResults').appendChild(pre);
                
            } else {
                addResult('配置文件未加載到全局作用域', 'error');
                addResult('可能的原因：', 'error');
                addResult('- config.js 文件不存在或路徑錯誤', 'error');
                addResult('- 文件中的JavaScript語法錯誤', 'error');
                addResult('- 全局變量設置失敗', 'error');
            }
        }
        
        function testConfigStructure() {
            addResult('正在檢查配置結構...');
            
            if (!window.config) {
                addResult('跳過結構檢查：配置文件未加載', 'warning');
                return;
            }
            
            const requiredKeys = ['supabase', 'system'];
            let allRequired = true;
            
            requiredKeys.forEach(key => {
                if (!window.config.hasOwnProperty(key)) {
                    addResult(`缺少必需的配置鍵: ${key}`, 'error');
                    allRequired = false;
                } else {
                    addResult(`找到配置鍵: ${key}`, 'success');
                }
            });
            
            if (allRequired) {
                addResult('所有必需的配置鍵都存在', 'success');
            }
        }
        
        function testConfigValues() {
            addResult('正在檢查配置值...');
            
            if (!window.config || !window.config.supabase) {
                addResult('跳過值檢查：配置不完整', 'warning');
                return;
            }
            
            const { url, anonKey } = window.config.supabase;
            
            // 檢查URL
            if (url && typeof url === 'string') {
                if (url.startsWith('https://') && url.includes('.supabase.co')) {
                    addResult(`URL格式正確: ${url}`, 'success');
                } else {
                    addResult(`URL格式可能不正確: ${url}`, 'warning');
                }
            } else {
                addResult('URL缺失或不是字符串', 'error');
            }
            
            // 檢查API密鑰
            if (anonKey && typeof anonKey === 'string') {
                if (anonKey.length > 100 && anonKey.startsWith('eyJhbGci')) {
                    addResult('API密鑰格式看起來正確', 'success');
                    addResult(`密鑰長度: ${anonKey.length} 字符`, 'success');
                } else {
                    addResult('API密鑰格式可能不正確', 'warning');
                    addResult(`密鑰長度: ${anonKey.length} 字符`, 'warning');
                }
            } else {
                addResult('API密鑰缺失或不是字符串', 'error');
            }
        }
        
        function testSupabaseConnection() {
            addResult('正在測試Supabase連接...');
            
            if (!window.config || !window.config.supabase) {
                addResult('跳過連接測試：配置不完整', 'warning');
                return;
            }
            
            const { url, anonKey } = window.config.supabase;
            
            // 創建簡單的fetch請求
            const testUrl = `${url}/rest/v1/games?select=*&limit=1`;
            const headers = {
                'apikey': anonKey,
                'Authorization': `Bearer ${anonKey}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            
            addResult(`正在請求: ${testUrl}`, 'info');
            
            fetch(testUrl, {
                method: 'GET',
                headers: headers,
                mode: 'cors',
                cache: 'no-cache'
            })
            .then(response => {
                addResult(`HTTP狀態碼: ${response.status} ${response.statusText}`, 
                          response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    return response.json().then(data => {
                        addResult(`成功接收數據: ${JSON.stringify(data)}`, 'success');
                    });
                } else {
                    addResult(`請求失敗，可能的原因:`, 'error');
                    if (response.status === 401) {
                        addResult('- API密鑰無效或權限不足', 'error');
                    } else if (response.status === 404) {
                        addResult('- 表不存在或路徑錯誤', 'error');
                    } else if (response.status === 500) {
                        addResult('- Supabase服務器錯誤', 'error');
                    }
                }
            })
            .catch(error => {
                addResult(`網絡錯誤: ${error.message}`, 'error');
                addResult('可能的原因:', 'error');
                addResult('- 網絡連接問題', 'error');
                addResult('- CORS限制', 'error');
                addResult('- URL或密鑰錯誤', 'error');
            });
        }
    </script>
</body>
</html>