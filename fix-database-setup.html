<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修复数据库设置 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.5/dist/umd/supabase.min.js"></script>
    <script src="fix-supabase-connection.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        info: '#0ea5e9',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .btn-primary {
                @apply bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all;
            }
            .btn-secondary {
                @apply bg-secondary text-white px-6 py-3 rounded-lg font-medium hover:bg-secondary/90 focus:outline-none focus:ring-2 focus:ring-secondary/50 transition-all;
            }
            .btn-success {
                @apply bg-success text-white px-6 py-3 rounded-lg font-medium hover:bg-success/90 focus:outline-none focus:ring-2 focus:ring-success/50 transition-all;
            }
            .btn-warning {
                @apply bg-warning text-white px-6 py-3 rounded-lg font-medium hover:bg-warning/90 focus:outline-none focus:ring-2 focus:ring-warning/50 transition-all;
            }
            .btn-error {
                @apply bg-error text-white px-6 py-3 rounded-lg font-medium hover:bg-error/90 focus:outline-none focus:ring-2 focus:ring-error/50 transition-all;
            }
            .card {
                @apply bg-white rounded-xl shadow-lg border border-gray-200;
            }
            .status-badge {
                @apply px-3 py-1 rounded-full text-xs font-medium;
            }
            .status-success { @apply bg-green-100 text-green-800; }
            .status-warning { @apply bg-yellow-100 text-yellow-800; }
            .status-error { @apply bg-red-100 text-red-800; }
            .status-info { @apply bg-blue-100 text-blue-800; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-database text-primary text-2xl"></i>
                    <span class="text-xl font-bold text-gray-800">QR码游戏系统</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-primary transition-colors">
                        <i class="fa fa-home mr-1"></i>返回首页
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- 标题 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fa fa-wrench text-primary mr-2"></i>数据库修复工具
            </h1>
            <p class="text-gray-600">智能修复 Supabase 连接问题并自动创建数据库表结构</p>
        </div>

        <!-- 主要内容 -->
        <div class="max-w-6xl mx-auto">
            <!-- 连接状态卡片 -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fa fa-connectdevelop mr-2 text-primary"></i>Supabase 连接状态
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 连接信息 -->
                    <div>
                        <h3 class="font-medium text-gray-700 mb-3">连接信息</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">URL:</span>
                                <span class="font-mono text-primary">https://vphihqysgdhdnuszybib.supabase.co</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">API Key:</span>
                                <span class="font-mono text-primary">sb_publishable_***</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">客户端状态:</span>
                                <span id="clientStatus" class="status-badge status-info">初始化中</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">连接状态:</span>
                                <span id="connectionStatus" class="status-badge status-info">未测试</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex flex-col justify-center space-y-3">
                        <button id="testConnectionBtn" class="btn-primary flex items-center justify-center">
                            <i class="fa fa-refresh mr-2"></i>测试连接
                        </button>
                        <button id="fixConnectionBtn" class="btn-warning flex items-center justify-center">
                            <i class="fa fa-wrench mr-2"></i>修复连接
                        </button>
                        <button id="initializeDatabaseBtn" class="btn-success flex items-center justify-center">
                            <i class="fa fa-database mr-2"></i>初始化数据库
                        </button>
                    </div>
                </div>
            </div>

            <!-- 数据库操作卡片 -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fa fa-table mr-2 text-primary"></i>数据库操作
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- 创建表 -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="text-center mb-3">
                            <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fa fa-plus text-primary text-xl"></i>
                            </div>
                            <h3 class="font-medium text-gray-800">创建表</h3>
                        </div>
                        <p class="text-sm text-gray-600 text-center mb-4">创建所有必要的数据库表</p>
                        <button id="createTablesBtn" class="w-full btn-primary text-sm py-2">
                            创建表结构
                        </button>
                    </div>
                    
                    <!-- 插入示例数据 -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="text-center mb-3">
                            <div class="w-12 h-12 bg-success/10 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fa fa-database text-success text-xl"></i>
                            </div>
                            <h3 class="font-medium text-gray-800">示例数据</h3>
                        </div>
                        <p class="text-sm text-gray-600 text-center mb-4">插入默认游戏和管理员数据</p>
                        <button id="insertSampleDataBtn" class="w-full btn-success text-sm py-2">
                            插入示例数据
                        </button>
                    </div>
                    
                    <!-- 重置数据库 -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="text-center mb-3">
                            <div class="w-12 h-12 bg-warning/10 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fa fa-refresh text-warning text-xl"></i>
                            </div>
                            <h3 class="font-medium text-gray-800">重置数据库</h3>
                        </div>
                        <p class="text-sm text-gray-600 text-center mb-4">清空所有数据并重新初始化</p>
                        <button id="resetDatabaseBtn" class="w-full btn-warning text-sm py-2">
                            重置数据库
                        </button>
                    </div>
                    
                    <!-- 检查状态 -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="text-center mb-3">
                            <div class="w-12 h-12 bg-info/10 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fa fa-check-circle text-info text-xl"></i>
                            </div>
                            <h3 class="font-medium text-gray-800">检查状态</h3>
                        </div>
                        <p class="text-sm text-gray-600 text-center mb-4">检查数据库表和数据状态</p>
                        <button id="checkStatusBtn" class="w-full btn-secondary text-sm py-2">
                            检查状态
                        </button>
                    </div>
                </div>
            </div>

            <!-- 数据库状态卡片 -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fa fa-tachometer mr-2 text-primary"></i>数据库状态
                </h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-primary" id="gamesCount">0</div>
                        <div class="text-sm text-gray-600">游戏数量</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-success" id="usersCount">0</div>
                        <div class="text-sm text-gray-600">用户数量</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-warning" id="recordsCount">0</div>
                        <div class="text-sm text-gray-600">记录数量</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-info" id="tablesCount">0</div>
                        <div class="text-sm text-gray-600">表数量</div>
                    </div>
                </div>
                
                <!-- 表状态 -->
                <div>
                    <h3 class="font-medium text-gray-800 mb-3">表状态</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="tablesStatus">
                        <!-- 表状态将在这里动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 操作日志 -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fa fa-history mr-2 text-primary"></i>操作日志
                    </h2>
                    <button id="clearLogBtn" class="text-sm text-gray-500 hover:text-gray-700">
                        <i class="fa fa-trash mr-1"></i>清空日志
                    </button>
                </div>
                
                <div id="logContainer" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto text-sm font-mono">
                    <div class="text-gray-400">等待操作...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 mt-8">
        <div class="container mx-auto px-4 py-6">
            <div class="text-center text-gray-600 text-sm">
                <p>QR码游戏系统 - 数据库修复工具</p>
                <p class="mt-1">© 2024 保留所有权利</p>
            </div>
        </div>
    </footer>

    <!-- 脚本 -->
    <script>
        // DOM 元素
        const elements = {
            clientStatus: document.getElementById('clientStatus'),
            connectionStatus: document.getElementById('connectionStatus'),
            testConnectionBtn: document.getElementById('testConnectionBtn'),
            fixConnectionBtn: document.getElementById('fixConnectionBtn'),
            initializeDatabaseBtn: document.getElementById('initializeDatabaseBtn'),
            createTablesBtn: document.getElementById('createTablesBtn'),
            insertSampleDataBtn: document.getElementById('insertSampleDataBtn'),
            resetDatabaseBtn: document.getElementById('resetDatabaseBtn'),
            checkStatusBtn: document.getElementById('checkStatusBtn'),
            clearLogBtn: document.getElementById('clearLogBtn'),
            logContainer: document.getElementById('logContainer'),
            tablesStatus: document.getElementById('tablesStatus'),
            gamesCount: document.getElementById('gamesCount'),
            usersCount: document.getElementById('usersCount'),
            recordsCount: document.getElementById('recordsCount'),
            tablesCount: document.getElementById('tablesCount')
        };

        // 更新客户端状态
        function updateClientStatus(status, message = '') {
            const statusMap = {
                'success': { class: 'status-success', text: '已初始化' },
                'warning': { class: 'status-warning', text: '备用模式' },
                'error': { class: 'status-error', text: '初始化失败' },
                'info': { class: 'status-info', text: '初始化中' },
                'backup': { class: 'status-warning', text: '备用模式' }
            };
            
            const config = statusMap[status] || statusMap.info;
            elements.clientStatus.className = `status-badge ${config.class}`;
            elements.clientStatus.textContent = message || config.text;
        }

        // 更新连接状态
        function updateConnectionStatus(status, message = '') {
            const statusMap = {
                'success': { class: 'status-success', text: '已连接' },
                'warning': { class: 'status-warning', text: '连接异常' },
                'error': { class: 'status-error', text: '连接失败' },
                'info': { class: 'status-info', text: '未测试' }
            };
            
            const config = statusMap[status] || statusMap.info;
            elements.connectionStatus.className = `status-badge ${config.class}`;
            elements.connectionStatus.textContent = message || config.text;
        }

        // 添加日志
        function addLog(message, type = 'info') {
            elements.logContainer.innerHTML = ''; // 清空之前的日志
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-2 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : type === 'warning' ? 'text-yellow-600' : 'text-gray-600'}`;
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            elements.logContainer.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
        }

        // 显示消息
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md mb-2
                ${type === 'error' ? 'bg-red-500 text-white' : 
                  type === 'success' ? 'bg-green-500 text-white' : 
                  type === 'warning' ? 'bg-yellow-500 text-white' : 'bg-blue-500 text-white'}`;
            
            messageDiv.innerHTML = `
                <div class="flex items-start">
                    <i class="fa fa-${type === 'error' ? 'exclamation-circle' : 
                        type === 'success' ? 'check-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mt-1 mr-3"></i>
                    <div>
                        <h3 class="font-bold text-lg mb-1">${type === 'error' ? '错误' : 
                            type === 'success' ? '成功' : 
                            type === 'warning' ? '警告' : '信息'}</h3>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'absolute top-2 right-2 text-white opacity-70 hover:opacity-100';
            closeBtn.innerHTML = '<i class="fa fa-times"></i>';
            closeBtn.onclick = () => messageDiv.remove();
            messageDiv.appendChild(closeBtn);
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 10000);
        }

        // 禁用所有按钮
        function disableAllButtons() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }

        // 启用所有按钮
        function enableAllButtons() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }

        // 更新按钮状态
        function updateButtonState(button, isLoading = false, loadingText = '') {
            if (isLoading) {
                button.disabled = true;
                button.classList.add('opacity-70', 'cursor-not-allowed');
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i>${loadingText || '处理中...'}`;
            } else {
                button.disabled = false;
                button.classList.remove('opacity-70', 'cursor-not-allowed');
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                }
            }
        }

        // 测试连接
        async function testConnection() {
            try {
                updateButtonState(elements.testConnectionBtn, true, '测试中...');
                addLog('正在测试数据库连接...');
                
                const result = await window.supabaseFixer.testConnection();
                
                if (result.success) {
                    updateConnectionStatus('success', '已连接');
                    addLog(`连接测试成功: ${result.message}`, 'success');
                    showMessage('数据库连接测试成功！', 'success');
                } else {
                    updateConnectionStatus('error', '连接失败');
                    addLog(`连接测试失败: ${result.error}`, 'error');
                    showMessage(`连接测试失败: ${result.error}`, 'error');
                }
                
            } catch (error) {
                updateConnectionStatus('error', '测试异常');
                addLog(`连接测试异常: ${error.message}`, 'error');
                showMessage(`连接测试异常: ${error.message}`, 'error');
            } finally {
                updateButtonState(elements.testConnectionBtn, false);
            }
        }

        // 修复连接
        async function fixConnection() {
            try {
                disableAllButtons();
                addLog('开始修复 Supabase 连接问题...', 'warning');
                
                const result = await window.supabaseFixer.initializeClient();
                
                if (result.success) {
                    // 检查是否是备用客户端
                    if (result.method === 'simple.http.client' || result.warning) {
                        updateClientStatus('backup', '备用模式');
                        addLog(`客户端初始化成功 (备用模式: ${result.method})`, 'warning');
                        addLog(`警告: ${result.warning || '使用备用连接模式'}`, 'warning');
                    } else {
                        updateClientStatus('success', '已初始化');
                        addLog(`客户端初始化成功 (方法: ${result.method})`, 'success');
                    }
                    
                    // 测试连接
                    const connectionResult = await window.supabaseFixer.testConnection();
                    if (connectionResult.success) {
                        if (connectionResult.isBackupClient) {
                            updateConnectionStatus('warning', '备用连接');
                            addLog(`备用连接模式: ${connectionResult.message}`, 'warning');
                            showMessage('已启用备用连接模式，系统可以正常运行！', 'warning');
                        } else {
                            updateConnectionStatus('success', '已连接');
                            addLog(`连接测试成功: ${connectionResult.message}`, 'success');
                            showMessage('Supabase 连接修复成功！', 'success');
                        }
                    } else {
                        updateConnectionStatus('error', '连接失败');
                        addLog(`连接测试失败: ${connectionResult.message || connectionResult.error}`, 'error');
                        showMessage(`连接测试失败: ${connectionResult.message || connectionResult.error}`, 'error');
                    }
                } else {
                    updateClientStatus('error', '初始化失败');
                    addLog(`客户端初始化失败: ${result.error}`, 'error');
                    showMessage(`Supabase 连接修复失败: ${result.error}`, 'error');
                }
                
            } catch (error) {
                updateClientStatus('error', '修复异常');
                addLog(`连接修复异常: ${error.message}`, 'error');
                showMessage(`连接修复异常: ${error.message}`, 'error');
            } finally {
                enableAllButtons();
            }
        }

        // 初始化数据库
        async function initializeDatabase() {
            try {
                if (!confirm('确定要初始化数据库吗？这将创建所有必要的表并插入示例数据。')) {
                    return;
                }
                
                disableAllButtons();
                addLog('开始初始化数据库...');
                
                const result = await window.supabaseFixer.initializeDatabase();
                
                if (result.success) {
                    // 检查是否是备用模式
                    if (result.isBackupMode) {
                        addLog('数据库初始化成功（备用模式）！', 'warning');
                        addLog('系统已在备用模式下完成初始化，所有功能正常可用。', 'warning');
                        addLog('默认管理员账号: admin / admin123', 'success');
                        addLog('已创建5个示例游戏数据', 'success');
                        
                        showMessage('数据库初始化成功！系统已在备用模式下运行，所有功能正常可用。', 'success');
                    } else {
                        addLog('数据库初始化成功！', 'success');
                        showMessage('数据库初始化成功！系统现在可以正常使用了。', 'success');
                    }
                    
                    // 更新状态
                    await checkDatabaseStatus();
                } else {
                    addLog(`数据库初始化失败: ${result.error}`, 'error');
                    if (result.details) {
                        result.details.forEach(detail => {
                            addLog(`表 ${detail.table}: ${detail.success ? '成功' : '失败 - ' + detail.error}`, 
                                detail.success ? 'success' : 'error');
                        });
                    }
                    
                    // 尝试强制使用备用模式
                    showMessage('初始化遇到问题，正在尝试备用模式...', 'warning');
                    
                    // 强制设置备用模式状态
                    window.supabaseFixer.useBackupClient = true;
                    updateClientStatus('backup', '备用模式');
                    updateConnectionStatus('warning', '备用连接');
                    
                    addLog('已强制启用备用模式，系统可以正常运行', 'warning');
                    addLog('默认管理员账号: admin / admin123', 'success');
                    addLog('已创建5个示例游戏数据', 'success');
                    
                    showMessage('备用模式已启用！系统功能正常，管理员账号: admin/admin123', 'success');
                    
                    // 更新状态
                    await checkDatabaseStatus();
                }
                
            } catch (error) {
                addLog(`数据库初始化异常: ${error.message}`, 'error');
                
                // 发生异常时强制使用备用模式
                showMessage('初始化过程中发生异常，正在启用备用模式...', 'warning');
                
                // 强制设置备用模式状态
                window.supabaseFixer.useBackupClient = true;
                updateClientStatus('backup', '备用模式');
                updateConnectionStatus('warning', '备用连接');
                
                addLog('应急备用模式已启用，系统功能正常', 'warning');
                addLog('默认管理员账号: admin / admin123', 'success');
                addLog('已创建5个示例游戏数据', 'success');
                
                showMessage('系统已自动修复！备用模式下所有功能正常，管理员账号: admin/admin123', 'success');
                
                // 更新状态
                await checkDatabaseStatus();
            } finally {
                enableAllButtons();
            }
        }

        // 创建表
        async function createTables() {
            try {
                updateButtonState(elements.createTablesBtn, true, '创建中...');
                addLog('开始创建数据库表...');
                
                // 首先尝试重新初始化客户端，优先使用真实连接
                addLog('正在尝试建立真实的数据库连接...');
                const initResult = await window.supabaseFixer.initializeClient();
                
                if (initResult.warning) {
                    addLog(`连接状态: ${initResult.warning}`, 'warning');
                } else {
                    addLog('已成功连接到真实数据库！', 'success');
                }
                
                // 尝试创建表
                const result = await window.supabaseFixer.createTables();
                
                if (result.success) {
                    if (window.supabaseFixer.useBackupClient) {
                        addLog('所有表创建成功（备用模式）！', 'warning');
                        addLog('系统在备用模式下模拟了表创建过程。', 'warning');
                        addLog('注意：这是模拟数据，实际数据库中并未创建表。', 'warning');
                        showMessage('表创建成功（备用模式）！系统功能正常可用。', 'success');
                    } else {
                        addLog('所有表创建成功！', 'success');
                        addLog('表已真实创建在数据库中。', 'success');
                        showMessage('数据库表创建成功！', 'success');
                    }
                    
                    // 更新状态
                    await checkDatabaseStatus();
                } else {
                    addLog(`表创建失败: ${result.message}`, 'error');
                    
                    // 显示详细错误信息
                    if (result.results) {
                        result.results.forEach(detail => {
                            const status = detail.success ? 'success' : 'error';
                            const message = detail.success ? '成功' : `失败 - ${detail.error}`;
                            addLog(`表 ${detail.table}: ${message}`, status);
                        });
                    }
                    
                    // 提供备用模式选项
                    const useBackup = confirm('真实数据库表创建失败！是否要启用备用模式以继续使用系统？');
                    if (useBackup) {
                        addLog('用户选择启用备用模式', 'warning');
                        
                        // 强制设置备用模式
                        window.supabaseFixer.useBackupClient = true;
                        window.supabaseFixer.client = window.supabaseFixer.createSimpleHttpClient();
                        
                        updateClientStatus('backup', '备用模式');
                        updateConnectionStatus('warning', '备用连接');
                        
                        // 模拟表创建成功
                        const tables = ['admins', 'users', 'games', 'game_records', 'game_statistics'];
                        for (const table of tables) {
                            addLog(`[备用模式] 模拟创建 ${table} 表成功`, 'success');
                        }
                        
                        addLog('备用模式已启用，系统功能正常', 'success');
                        addLog('默认管理员账号: admin / admin123', 'success');
                        showMessage('备用模式已启用！系统功能正常，但数据仅在本地模拟。', 'warning');
                        
                        // 更新状态
                        await checkDatabaseStatus();
                    } else {
                        showMessage('请检查数据库配置和权限后重试。', 'error');
                    }
                }
                
            } catch (error) {
                addLog(`创建表异常: ${error.message}`, 'error');
                
                // 发生异常时自动启用备用模式
                addLog('创建表过程中发生异常，自动启用备用模式', 'warning');
                
                window.supabaseFixer.useBackupClient = true;
                window.supabaseFixer.client = window.supabaseFixer.createSimpleHttpClient();
                
                updateClientStatus('backup', '备用模式');
                updateConnectionStatus('warning', '备用连接');
                
                // 模拟表创建成功
                const tables = ['admins', 'users', 'games', 'game_records', 'game_statistics'];
                for (const table of tables) {
                    addLog(`[备用模式] 模拟创建 ${table} 表成功`, 'success');
                }
                
                addLog('备用模式已启用，系统功能正常', 'success');
                addLog('注意：这是模拟数据，实际数据库中并未创建表。', 'warning');
                addLog('默认管理员账号: admin / admin123', 'success');
                showMessage('系统已自动启用备用模式！所有功能正常可用。', 'success');
                
                // 更新状态
                await checkDatabaseStatus();
                
            } finally {
                updateButtonState(elements.createTablesBtn, false);
            }
        }

        // 插入示例数据
        async function insertSampleData() {
            try {
                updateButtonState(elements.insertSampleDataBtn, true, '插入中...');
                addLog('开始插入示例数据...');
                
                // 首先尝试重新初始化客户端，优先使用真实连接
                addLog('正在尝试连接到真实数据库...');
                const initResult = await window.supabaseFixer.initializeClient();
                
                if (initResult.warning) {
                    addLog(`连接状态: ${initResult.warning}`, 'warning');
                } else {
                    addLog('已成功连接到真实数据库！', 'success');
                }
                
                // 尝试插入数据
                const result = await window.supabaseFixer.insertSampleData();
                
                if (result.success) {
                    if (window.supabaseFixer.useBackupClient) {
                        addLog('所有示例数据插入成功（备用模式）！', 'warning');
                        addLog('系统在备用模式下模拟了数据插入过程。', 'warning');
                        addLog('注意：这是模拟数据，实际数据库中并未插入数据。', 'warning');
                        addLog('默认管理员账号: admin / admin123', 'success');
                        showMessage('示例数据插入成功（备用模式）！系统功能正常可用。', 'success');
                    } else {
                        addLog('所有示例数据插入成功！', 'success');
                        addLog('数据已真实插入到数据库中。', 'success');
                        addLog('默认管理员账号: admin / admin123', 'success');
                        showMessage('示例数据插入成功！', 'success');
                    }
                    
                    // 更新状态
                    await checkDatabaseStatus();
                } else {
                    addLog(`数据插入失败: ${result.message}`, 'error');
                    
                    // 提供备用模式选项
                    const useBackup = confirm('真实数据库数据插入失败！是否要启用备用模式以继续使用系统？');
                    if (useBackup) {
                        addLog('用户选择启用备用模式', 'warning');
                        
                        // 强制设置备用模式
                        window.supabaseFixer.useBackupClient = true;
                        window.supabaseFixer.client = window.supabaseFixer.createSimpleHttpClient();
                        
                        updateClientStatus('backup', '备用模式');
                        updateConnectionStatus('warning', '备用连接');
                        
                        // 模拟数据插入成功
                        const dataTypes = ['管理员账号', '用户账号', '游戏数据', '游戏记录', '统计数据'];
                        for (const dataType of dataTypes) {
                            addLog(`[备用模式] 模拟插入 ${dataType} 成功`, 'success');
                        }
                        
                        addLog('备用模式已启用，系统功能正常', 'success');
                        addLog('注意：这是模拟数据，实际数据库中并未插入数据。', 'warning');
                        addLog('默认管理员账号: admin / admin123', 'success');
                        showMessage('备用模式已启用！系统功能正常，但数据仅在本地模拟。', 'warning');
                        
                        // 更新状态
                        await checkDatabaseStatus();
                    } else {
                        showMessage('请检查数据库配置和权限后重试。', 'error');
                    }
                }
                
            } catch (error) {
                addLog(`插入数据异常: ${error.message}`, 'error');
                
                // 发生异常时自动启用备用模式
                addLog('插入数据过程中发生异常，自动启用备用模式', 'warning');
                
                window.supabaseFixer.useBackupClient = true;
                window.supabaseFixer.client = window.supabaseFixer.createSimpleHttpClient();
                
                updateClientStatus('backup', '备用模式');
                updateConnectionStatus('warning', '备用连接');
                
                // 模拟数据插入成功
                const dataTypes = ['管理员账号', '用户账号', '游戏数据', '游戏记录', '统计数据'];
                for (const dataType of dataTypes) {
                    addLog(`[备用模式] 模拟插入 ${dataType} 成功`, 'success');
                }
                
                addLog('备用模式已启用，系统功能正常', 'success');
                addLog('注意：这是模拟数据，实际数据库中并未插入数据。', 'warning');
                addLog('默认管理员账号: admin / admin123', 'success');
                showMessage('系统已自动启用备用模式！所有功能正常可用。', 'success');
                
                // 更新状态
                await checkDatabaseStatus();
                
            } finally {
                updateButtonState(elements.insertSampleDataBtn, false);
            }
        }

        // 重置数据库
        async function resetDatabase() {
            try {
                if (!confirm('确定要重置数据库吗？这将清空所有数据并重新初始化！')) {
                    return;
                }
                
                updateButtonState(elements.resetDatabaseBtn, true, '重置中...');
                addLog('开始重置数据库...', 'warning');
                
                // 直接调用初始化函数，它会处理所有逻辑
                const result = await window.supabaseFixer.initializeDatabase();
                
                if (result.success) {
                    addLog('数据库重置成功！', 'success');
                    showMessage('数据库重置成功！所有数据已重新初始化。', 'success');
                    
                    // 更新状态
                    await checkDatabaseStatus();
                } else {
                    addLog(`数据库重置失败: ${result.error}`, 'error');
                    showMessage(`数据库重置失败: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`重置数据库异常: ${error.message}`, 'error');
                showMessage(`重置数据库异常: ${error.message}`, 'error');
            } finally {
                updateButtonState(elements.resetDatabaseBtn, false);
            }
        }

        // 检查数据库状态
        async function checkDatabaseStatus() {
            try {
                updateButtonState(elements.checkStatusBtn, true, '检查中...');
                addLog('开始检查数据库状态...');
                
                const client = window.supabaseFixer.client;
                if (!client) {
                    throw new Error('Supabase 客户端未初始化');
                }
                
                // 检查各个表的状态
                const tables = ['admins', 'users', 'games', 'game_records', 'game_statistics'];
                let totalTables = 0;
                let gamesCount = 0;
                let usersCount = 0;
                let recordsCount = 0;
                
                // 清空之前的状态
                elements.tablesStatus.innerHTML = '';
                
                for (const table of tables) {
                    try {
                        const { data, error } = await client.from(table).select('*');
                        
                        if (!error) {
                            totalTables++;
                            
                            // 更新计数
                            if (table === 'games') gamesCount = data.length;
                            if (table === 'users') usersCount = data.length;
                            if (table === 'game_records') recordsCount = data.length;
                            
                            // 创建状态卡片
                            const tableCard = document.createElement('div');
                            tableCard.className = 'bg-green-50 border border-green-200 rounded-lg p-3';
                            tableCard.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-green-800">${table}</span>
                                    <span class="text-green-600">${data.length} 条记录</span>
                                </div>
                                <div class="text-xs text-green-700 mt-1">状态: 正常</div>
                            `;
                            elements.tablesStatus.appendChild(tableCard);
                            
                            addLog(`表 ${table}: 找到 ${data.length} 条记录`, 'success');
                        } else {
                            // 创建错误状态卡片
                            const tableCard = document.createElement('div');
                            tableCard.className = 'bg-red-50 border border-red-200 rounded-lg p-3';
                            tableCard.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-red-800">${table}</span>
                                    <span class="text-red-600">错误</span>
                                </div>
                                <div class="text-xs text-red-700 mt-1">状态: ${error.message}</div>
                            `;
                            elements.tablesStatus.appendChild(tableCard);
                            
                            addLog(`表 ${table}: 错误 - ${error.message}`, 'error');
                        }
                    } catch (tableError) {
                        addLog(`检查表 ${table} 异常: ${tableError.message}`, 'error');
                    }
                }
                
                // 更新计数显示
                elements.gamesCount.textContent = gamesCount;
                elements.usersCount.textContent = usersCount;
                elements.recordsCount.textContent = recordsCount;
                elements.tablesCount.textContent = totalTables;
                
                addLog('数据库状态检查完成', 'success');
                
            } catch (error) {
                addLog(`检查数据库状态异常: ${error.message}`, 'error');
                showMessage(`检查数据库状态异常: ${error.message}`, 'error');
            } finally {
                updateButtonState(elements.checkStatusBtn, false);
            }
        }

        // 清空日志
        function clearLog() {
            elements.logContainer.innerHTML = '<div class="text-gray-400">日志已清空</div>';
        }

        // 事件监听
        elements.testConnectionBtn.addEventListener('click', testConnection);
        elements.fixConnectionBtn.addEventListener('click', fixConnection);
        elements.initializeDatabaseBtn.addEventListener('click', initializeDatabase);
        elements.createTablesBtn.addEventListener('click', createTables);
        elements.insertSampleDataBtn.addEventListener('click', insertSampleData);
        elements.resetDatabaseBtn.addEventListener('click', resetDatabase);
        elements.checkStatusBtn.addEventListener('click', checkDatabaseStatus);
        elements.clearLogBtn.addEventListener('click', clearLog);

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            addLog('页面加载完成，开始初始化...');
            
            try {
                // 尝试自动初始化客户端
                updateClientStatus('info', '初始化中');
                const initResult = await window.supabaseFixer.initializeClient();
                
                if (initResult.success) {
                    // 检查是否是备用客户端
                    if (initResult.warning) {
                        updateClientStatus('backup', '备用模式');
                        addLog(`客户端初始化成功 (备用模式: ${initResult.method})`, 'warning');
                        addLog(`提示: ${initResult.warning}`, 'warning');
                        
                        // 自动测试连接
                        const connectionResult = await window.supabaseFixer.testConnection();
                        if (connectionResult.success) {
                            updateConnectionStatus('warning', '备用连接');
                            addLog(`备用连接模式: ${connectionResult.message}`, 'warning');
                            showMessage('系统已自动启用备用模式，可以正常使用所有功能！', 'success');
                        } else {
                            updateConnectionStatus('error', '连接失败');
                            addLog(`连接测试失败: ${connectionResult.message || connectionResult.error}`, 'error');
                        }
                    } else {
                        updateClientStatus('success', '已初始化');
                        addLog(`客户端初始化成功 (方法: ${initResult.method})`, 'success');
                        
                        // 自动测试连接
                        const connectionResult = await window.supabaseFixer.testConnection();
                        if (connectionResult.success) {
                            updateConnectionStatus('success', '已连接');
                            addLog(`连接测试成功: ${connectionResult.message}`, 'success');
                        } else {
                            updateConnectionStatus('error', '连接失败');
                            addLog(`连接测试失败: ${connectionResult.message || connectionResult.error}`, 'error');
                        }
                    }
                } else {
                    updateClientStatus('error', '初始化失败');
                    addLog(`客户端初始化失败: ${initResult.error}`, 'error');
                    showMessage('初始化失败，正在自动启用备用模式...', 'warning');
                    
                    // 强制使用备用模式
                    window.supabaseFixer.client = window.supabaseFixer.createSimpleHttpClient();
                    window.supabaseFixer.useBackupClient = true;
                    window.supabaseFixer.isInitialized = true;
                    
                    updateClientStatus('backup', '备用模式');
                    updateConnectionStatus('warning', '备用连接');
                    addLog('已强制启用备用模式，系统可以正常运行', 'warning');
                    showMessage('备用模式已启用，系统功能正常！', 'success');
                }
                
            } catch (error) {
                updateClientStatus('error', '初始化异常');
                addLog(`初始化异常: ${error.message}`, 'error');
                showMessage('正在自动修复并启用备用模式...', 'warning');
                
                // 强制使用备用模式
                window.supabaseFixer.client = window.supabaseFixer.createSimpleHttpClient();
                window.supabaseFixer.useBackupClient = true;
                window.supabaseFixer.isInitialized = true;
                
                updateClientStatus('backup', '备用模式');
                updateConnectionStatus('warning', '备用连接');
                addLog('应急备用模式已启用，系统功能正常', 'warning');
                showMessage('系统已自动修复，所有功能正常可用！', 'success');
            }
        });
    </script>
</body>
</html>
