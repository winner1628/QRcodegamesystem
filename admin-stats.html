<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据统计 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 30px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px 0 rgba(102, 126, 234, 0.6);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 400px;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 顶部导航 -->
    <nav class="glass-card mx-4 mt-4 mb-6 p-4 flex justify-between items-center">
        <div class="flex items-center">
            <i class="fa fa-bar-chart text-2xl text-white mr-3"></i>
            <h1 class="text-xl font-bold text-white">数据统计</h1>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="window.location.href='admin-main.html'" class="btn-primary">
                <i class="fa fa-arrow-left mr-2"></i>返回控制台
            </button>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all">
                <i class="fa fa-sign-out mr-2"></i>登出
            </button>
        </div>
    </nav>

    <div class="container mx-auto px-4">
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card text-center">
                <div class="stat-number" id="totalGames">0</div>
                <div class="stat-label">游戏总数</div>
            </div>
            <div class="stat-card text-center">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">用户总数</div>
            </div>
            <div class="stat-card text-center">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">记录总数</div>
            </div>
            <div class="stat-card text-center">
                <div class="stat-number" id="avgScore">0</div>
                <div class="stat-label">平均分数</div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 游戏参与度图表 -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-4">游戏参与度</h3>
                <div class="chart-container">
                    <canvas id="gameParticipationChart"></canvas>
                </div>
            </div>
            
            <!-- 用户分数分布图表 -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-4">用户分数分布</h3>
                <div class="chart-container">
                    <canvas id="userScoreChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 最近活动 -->
        <div class="glass-card p-6 mb-8">
            <h3 class="text-xl font-bold text-white mb-4">最近活动</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-transparent">
                    <thead>
                        <tr class="border-b border-gray-300">
                            <th class="py-3 px-4 text-left text-white">时间</th>
                            <th class="py-3 px-4 text-left text-white">用户</th>
                            <th class="py-3 px-4 text-left text-white">游戏</th>
                            <th class="py-3 px-4 text-left text-white">分数</th>
                        </tr>
                    </thead>
                    <tbody id="recentActivities">
                        <tr>
                            <td colspan="4" class="py-4 text-center text-white">暂无数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // 导入模块
        import './js/config.js';
        import './js/database.js';
        import './js/auth.js';

        // 全局变量
        let authManager = new AuthManager();
        let db = new DatabaseManager();
        let gameChart = null;
        let userChart = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 检查登录状态
            if (!authManager.isAdminLoggedIn()) {
                window.location.href = 'admin-login.html';
                return;
            }

            try {
                // 加载统计数据
                await loadStatistics();
                
                // 初始化图表
                await initCharts();
                
                // 加载最近活动
                await loadRecentActivities();
            } catch (error) {
                console.error('加载数据失败:', error);
                alert('加载数据失败，请稍后重试');
            }
        });

        // 加载统计数据
        async function loadStatistics() {
            try {
                // 获取游戏总数
                const games = await db.getAllGames();
                document.getElementById('totalGames').textContent = games.length;

                // 获取用户总数
                const users = await db.getAllUsers();
                document.getElementById('totalUsers').textContent = users.length;

                // 获取记录总数
                const records = await db.getAllGameRecords();
                document.getElementById('totalRecords').textContent = records.length;

                // 计算平均分数
                if (records.length > 0) {
                    const totalScore = records.reduce((sum, record) => sum + record.score, 0);
                    const avgScore = Math.round(totalScore / records.length);
                    document.getElementById('avgScore').textContent = avgScore;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
                throw error;
            }
        }

        // 初始化图表
        async function initCharts() {
            try {
                // 游戏参与度图表
                await initGameParticipationChart();
                
                // 用户分数分布图表
                await initUserScoreChart();
            } catch (error) {
                console.error('初始化图表失败:', error);
            }
        }

        // 初始化游戏参与度图表
        async function initGameParticipationChart() {
            try {
                const games = await db.getAllGames();
                const records = await db.getAllGameRecords();
                
                // 统计每个游戏的参与次数
                const gameParticipation = {};
                games.forEach(game => {
                    gameParticipation[game.name] = 0;
                });
                
                records.forEach(record => {
                    const game = games.find(g => g.id === record.game_id);
                    if (game) {
                        gameParticipation[game.name]++;
                    }
                });

                const ctx = document.getElementById('gameParticipationChart').getContext('2d');
                gameChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(gameParticipation),
                        datasets: [{
                            label: '参与次数',
                            data: Object.values(gameParticipation),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: 'rgba(255, 255, 255, 0.8)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('初始化游戏参与度图表失败:', error);
            }
        }

        // 初始化用户分数分布图表
        async function initUserScoreChart() {
            try {
                const users = await db.getAllUsers();
                
                // 按分数排序
                users.sort((a, b) => b.total_score - a.total_score);
                
                // 取前10名用户
                const topUsers = users.slice(0, 10);

                const ctx = document.getElementById('userScoreChart').getContext('2d');
                userChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: topUsers.map(user => user.name),
                        datasets: [{
                            label: '总分数',
                            data: topUsers.map(user => user.total_score),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: 'rgba(255, 255, 255, 0.8)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('初始化用户分数分布图表失败:', error);
            }
        }

        // 加载最近活动
        async function loadRecentActivities() {
            try {
                const records = await db.getAllGameRecords();
                const users = await db.getAllUsers();
                const games = await db.getAllGames();
                
                // 按时间排序
                records.sort((a, b) => new Date(b.recorded_at) - new Date(a.recorded_at));
                
                // 取最近10条记录
                const recentRecords = records.slice(0, 10);
                
                const tbody = document.getElementById('recentActivities');
                tbody.innerHTML = '';
                
                recentRecords.forEach(record => {
                    const user = users.find(u => u.id === record.user_id);
                    const game = games.find(g => g.id === record.game_id);
                    
                    if (user && game) {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-300 hover:bg-white hover:bg-opacity-10';
                        
                        const time = new Date(record.recorded_at).toLocaleString('zh-TW');
                        
                        row.innerHTML = `
                            <td class="py-3 px-4 text-white">${time}</td>
                            <td class="py-3 px-4 text-white">${user.name}</td>
                            <td class="py-3 px-4 text-white">${game.name}</td>
                            <td class="py-3 px-4 text-white font-bold">${record.score}</td>
                        `;
                        
                        tbody.appendChild(row);
                    }
                });
            } catch (error) {
                console.error('加载最近活动失败:', error);
            }
        }

        // 登出
        function logout() {
            authManager.logout();
            window.location.href = 'admin-login.html';
        }
    </script>
</body>
</html>