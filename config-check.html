<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置检查工具 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }
        .card {
            @apply bg-white rounded-lg shadow-lg p-6 border border-gray-200;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300;
        }
        .config-item {
            @apply mb-4 p-4 border rounded-lg;
        }
        .config-item.success {
            @apply bg-green-50 border-green-300;
        }
        .config-item.error {
            @apply bg-red-50 border-red-300;
        }
        .config-label {
            @apply font-bold text-gray-700;
        }
        .config-value {
            @apply mt-1 text-sm;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="container mx-auto">
        <div class="max-w-2xl mx-auto">
            <div class="card mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">配置检查工具</h1>
                <p class="text-gray-600">此工具用于检查系统配置是否正确</p>
            </div>

            <!-- 配置检查结果 -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">配置状态</h2>
                
                <div id="configAppConfig" class="config-item">
                    <div class="config-label">AppConfig 对象</div>
                    <div id="configAppConfigValue" class="config-value">检查中...</div>
                </div>

                <div id="configSupabase" class="config-item">
                    <div class="config-label">Supabase 客户端</div>
                    <div id="configSupabaseValue" class="config-value">检查中...</div>
                </div>

                <div id="configUrl" class="config-item">
                    <div class="config-label">数据库 URL</div>
                    <div id="configUrlValue" class="config-value">检查中...</div>
                </div>

                <div id="configKey" class="config-item">
                    <div class="config-label">API 密钥</div>
                    <div id="configKeyValue" class="config-value">检查中...</div>
                </div>

                <div id="configAdmin" class="config-item">
                    <div class="config-label">默认管理员</div>
                    <div id="configAdminValue" class="config-value">检查中...</div>
                </div>
            </div>

            <!-- 修复选项 -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">修复选项</h2>
                <div class="space-y-4">
                    <button id="reloadConfigBtn" class="btn-primary">
                        <i class="fa fa-refresh mr-2"></i>重新加载配置
                    </button>
                    <button id="createNewConfigBtn" class="btn-primary">
                        <i class="fa fa-file-text-o mr-2"></i>创建新配置文件
                    </button>
                </div>
            </div>

            <!-- 手动配置表单 -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">手动配置</h2>
                <form id="manualConfigForm" class="space-y-4">
                    <div>
                        <label for="manualUrl" class="block text-gray-700 mb-2">数据库 URL</label>
                        <input type="text" id="manualUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="https://your-project.supabase.co">
                    </div>
                    <div>
                        <label for="manualKey" class="block text-gray-700 mb-2">API 密钥</label>
                        <input type="text" id="manualKey" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="eyJhbGciOiJIUzI1Ni...">
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fa fa-save mr-2"></i>应用配置
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // 页面加载完成后检查配置
        document.addEventListener('DOMContentLoaded', () => {
            checkConfig();
            
            // 绑定事件
            document.getElementById('reloadConfigBtn').addEventListener('click', reloadConfig);
            document.getElementById('createNewConfigBtn').addEventListener('click', createNewConfig);
            document.getElementById('manualConfigForm').addEventListener('submit', handleManualConfig);
        });

        // 检查配置
        function checkConfig() {
            console.log('检查配置...');
            
            // 检查 AppConfig 对象
            checkConfigItem('configAppConfig', 'configAppConfigValue', 
                () => window.AppConfig !== undefined,
                () => typeof window.AppConfig,
                'AppConfig 对象存在',
                'AppConfig 对象不存在'
            );

            // 检查 Supabase 客户端
            checkConfigItem('configSupabase', 'configSupabaseValue', 
                () => window.AppConfig && window.AppConfig.supabase !== undefined,
                () => typeof window.AppConfig.supabase,
                'Supabase 客户端存在',
                'Supabase 客户端不存在'
            );

            // 检查数据库 URL
            checkConfigItem('configUrl', 'configUrlValue', 
                () => window.AppConfig && window.AppConfig.supabase && window.AppConfig.supabase.url,
                () => window.AppConfig.supabase.url,
                '数据库 URL 已配置',
                '数据库 URL 未配置'
            );

            // 检查 API 密钥
            checkConfigItem('configKey', 'configKeyValue', 
                () => window.AppConfig && window.AppConfig.supabase && window.AppConfig.supabase.key,
                () => window.AppConfig.supabase.key.substring(0, 20) + '...',
                'API 密钥已配置',
                'API 密钥未配置'
            );

            // 检查默认管理员
            checkConfigItem('configAdmin', 'configAdminValue', 
                () => window.AppConfig && window.AppConfig.DEFAULT_ADMIN,
                () => `${window.AppConfig.DEFAULT_ADMIN.username}/${window.AppConfig.DEFAULT_ADMIN.password}`,
                '默认管理员已配置',
                '默认管理员未配置'
            );
        }

        // 检查单个配置项
        function checkConfigItem(containerId, valueId, checkFunction, valueFunction, successMessage, errorMessage) {
            const container = document.getElementById(containerId);
            const valueElement = document.getElementById(valueId);
            
            try {
                if (checkFunction()) {
                    container.classList.add('success');
                    container.classList.remove('error');
                    valueElement.textContent = valueFunction();
                } else {
                    container.classList.add('error');
                    container.classList.remove('success');
                    valueElement.textContent = errorMessage;
                }
            } catch (error) {
                container.classList.add('error');
                container.classList.remove('success');
                valueElement.textContent = `错误: ${error.message}`;
            }
        }

        // 重新加载配置
        function reloadConfig() {
            console.log('重新加载配置...');
            
            // 清除缓存并重新加载
            delete window.AppConfig;
            
            // 重新导入配置
            import('./js/config.js').then(() => {
                console.log('配置重新加载成功');
                checkConfig();
            }).catch(error => {
                console.error('配置重新加载失败:', error);
                alert('配置重新加载失败: ' + error.message);
            });
        }

        // 创建新配置文件
        function createNewConfig() {
            if (confirm('确定要创建新的配置文件吗？这将覆盖现有的配置文件。')) {
                console.log('创建新配置文件...');
                
                // 创建新的配置内容
                const newConfigContent = `// 系统配置文件
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm';

const SUPABASE_URL = 'https://vphihqysgdhdnuszybib.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwaGlocXlzZ2RoZG51c3p5YmliaiIsInR5cGUiOiJhbm9uX2FwaSIsImlhdCI6MTcyNjQ5ODQwOSwiZXhwIjoyMDQyMDc0NDA5fQ.2w5qXcR4FbD7Wc-4hOYVcK4QdJ4wYjXm6N6m4Z7g8h9i';

// 初始化Supabase客户端
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 默认管理员账号（仅用于首次设置）
const DEFAULT_ADMIN = {
    username: 'admin',
    password: 'admin123'
};

// 导出配置
window.AppConfig = {
    supabase,
    DEFAULT_ADMIN
};`;
                
                // 创建 Blob 并下载
                const blob = new Blob([newConfigContent], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'config.js';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('新的配置文件已下载，请替换 js/config.js 文件');
            }
        }

        // 处理手动配置
        function handleManualConfig(e) {
            e.preventDefault();
            
            const url = document.getElementById('manualUrl').value.trim();
            const key = document.getElementById('manualKey').value.trim();
            
            if (!url || !key) {
                alert('请填写所有字段');
                return;
            }
            
            console.log('应用手动配置...');
            
            // 创建新的配置内容
            const newConfigContent = `// 系统配置文件
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm';

const SUPABASE_URL = '${url}';
const SUPABASE_ANON_KEY = '${key}';

// 初始化Supabase客户端
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 默认管理员账号（仅用于首次设置）
const DEFAULT_ADMIN = {
    username: 'admin',
    password: 'admin123'
};

// 导出配置
window.AppConfig = {
    supabase,
    DEFAULT_ADMIN
};`;
            
            // 创建 Blob 并下载
            const blob = new Blob([newConfigContent], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('自定义配置文件已下载，请替换 js/config.js 文件');
        }
    </script>
</body>
</html>