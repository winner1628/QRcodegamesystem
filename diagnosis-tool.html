<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统诊断工具 - QR码游戏系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }
        .card {
            @apply bg-white rounded-lg shadow-lg p-6 border border-gray-200;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300;
        }
        .status-success {
            @apply bg-green-100 border-green-300 text-green-800 p-3 rounded-lg mb-3;
        }
        .status-warning {
            @apply bg-yellow-100 border-yellow-300 text-yellow-800 p-3 rounded-lg mb-3;
        }
        .status-error {
            @apply bg-red-100 border-red-300 text-red-800 p-3 rounded-lg mb-3;
        }
        .info-box {
            @apply bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4;
        }
        .test-result {
            @apply bg-gray-50 border border-gray-200 p-4 rounded-lg mb-4;
        }
        .test-success {
            @apply border-green-300 bg-green-50;
        }
        .test-error {
            @apply border-red-300 bg-red-50;
        }
        .test-warning {
            @apply border-yellow-300 bg-yellow-50;
        }
        .log-entry {
            @apply text-sm mb-1;
        }
        .log-success {
            @apply text-green-600;
        }
        .log-error {
            @apply text-red-600;
        }
        .log-info {
            @apply text-blue-600;
        }
        .log-warning {
            @apply text-yellow-600;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="container mx-auto">
        <div class="max-w-4xl mx-auto">
            <div class="card mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fa fa-diagnostics text-blue-600 mr-3"></i>
                    系统诊断工具
                </h1>
                <p class="text-gray-600">全面检测系统功能和数据库连接状态</p>
            </div>

            <!-- 诊断状态 -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">诊断状态</h2>
                
                <div id="diagnosisStatus" class="status-warning">
                    <i class="fa fa-spinner fa-spin mr-2"></i>
                    准备开始诊断...
                </div>

                <div id="configInfo" class="info-box hidden">
                    <h3 class="font-bold text-blue-800 mb-2">配置信息</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="font-semibold">数据库 URL:</span>
                            <span id="dbUrl">加载中...</span>
                        </div>
                        <div>
                            <span class="font-semibold">API 密钥:</span>
                            <span id="apiKey">加载中...</span>
                        </div>
                        <div>
                            <span class="font-semibold">API 密钥长度:</span>
                            <span id="apiKeyLength">加载中...</span>
                        </div>
                        <div>
                            <span class="font-semibold">配置加载:</span>
                            <span id="configStatus">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 诊断按钮 -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">诊断操作</h2>
                <div class="space-y-3">
                    <button id="fullDiagnosisBtn" class="btn-primary w-full">
                        <i class="fa fa-play-circle mr-2"></i>
                        开始全面诊断
                    </button>
                    <button id="connectionTestBtn" class="btn-secondary w-full">
                        <i class="fa fa-database mr-2"></i>
                        仅测试数据库连接
                    </button>
                    <button id="tableTestBtn" class="btn-secondary w-full">
                        <i class="fa fa-table mr-2"></i>
                        测试表结构
                    </button>
                    <button id="functionTestBtn" class="btn-secondary w-full">
                        <i class="fa fa-cogs mr-2"></i>
                        测试核心功能
                    </button>
                    <button id="clearLogBtn" class="btn-secondary w-full">
                        <i class="fa fa-trash mr-2"></i>
                        清空诊断日志
                    </button>
                </div>
            </div>

            <!-- 诊断结果 -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fa fa-file-text mr-2"></i>
                    诊断日志
                </h2>
                <div id="diagnosisLog" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-96 overflow-y-auto text-sm">
                    <div class="text-gray-500 italic">点击上方按钮开始诊断...</div>
                </div>
            </div>

            <!-- 测试结果 -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fa fa-check-circle mr-2"></i>
                    测试结果
                </h2>
                
                <div id="connectionTestResult" class="test-result hidden">
                    <h3 class="font-bold text-gray-800 mb-2">数据库连接测试</h3>
                    <div id="connectionTestContent">测试未开始</div>
                </div>

                <div id="tableTestResult" class="test-result hidden">
                    <h3 class="font-bold text-gray-800 mb-2">表结构测试</h3>
                    <div id="tableTestContent">测试未开始</div>
                </div>

                <div id="functionTestResult" class="test-result hidden">
                    <h3 class="font-bold text-gray-800 mb-2">功能测试</h3>
                    <div id="functionTestContent">测试未开始</div>
                </div>

                <div id="summaryResult" class="test-result hidden">
                    <h3 class="font-bold text-gray-800 mb-2">诊断总结</h3>
                    <div id="summaryContent">诊断未完成</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 导入配置
        import './js/config.js';
        
        // 全局变量
        let diagnosisResults = {
            connection: { success: false, message: '' },
            tables: { success: false, message: '', details: {} },
            functions: { success: false, message: '', details: {} }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 绑定事件
            document.getElementById('fullDiagnosisBtn').addEventListener('click', startFullDiagnosis);
            document.getElementById('connectionTestBtn').addEventListener('click', testConnection);
            document.getElementById('tableTestBtn').addEventListener('click', testTables);
            document.getElementById('functionTestBtn').addEventListener('click', testFunctions);
            document.getElementById('clearLogBtn').addEventListener('click', clearLog);
            
            // 显示配置信息
            showConfigInfo();
        });

        // 显示配置信息
        function showConfigInfo() {
            const configInfo = document.getElementById('configInfo');
            configInfo.classList.remove('hidden');
            
            try {
                const config = window.AppConfig;
                
                if (config && config.supabase) {
                    document.getElementById('dbUrl').textContent = config.supabase.url || '未配置';
                    document.getElementById('apiKey').textContent = (config.supabase.key || '').substring(0, 15) + '...';
                    document.getElementById('apiKeyLength').textContent = (config.supabase.key || '').length;
                    document.getElementById('configStatus').textContent = '✅ 成功';
                } else {
                    document.getElementById('dbUrl').textContent = '未配置';
                    document.getElementById('apiKey').textContent = '未配置';
                    document.getElementById('apiKeyLength').textContent = '0';
                    document.getElementById('configStatus').textContent = '❌ 失败';
                }
            } catch (error) {
                log('配置信息显示失败: ' + error.message, 'error');
            }
        }

        // 记录日志
        function log(message, type = 'info') {
            const logDiv = document.getElementById('diagnosisLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = `log-${type}`;
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            }[type] || 'ℹ️';
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${typeClass}`;
            logEntry.innerHTML = `[${timestamp}] ${typeIcon} ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 清空日志
        function clearLog() {
            document.getElementById('diagnosisLog').innerHTML = '<div class="text-gray-500 italic">日志已清空</div>';
        }

        // 更新状态显示
        function updateStatus(message, type = 'warning') {
            const statusDiv = document.getElementById('diagnosisStatus');
            const typeClass = `status-${type}`;
            const typeIcon = {
                'success': '✅',
                'warning': '⚠️',
                'error': '❌',
                'info': 'ℹ️'
            }[type] || 'ℹ️';
            
            statusDiv.className = typeClass;
            statusDiv.innerHTML = `${typeIcon} ${message}`;
        }

        // 开始全面诊断
        async function startFullDiagnosis() {
            updateStatus('开始全面诊断...', 'warning');
            clearLog();
            log('=== 开始全面系统诊断 ===', 'info');
            
            // 重置结果
            diagnosisResults = {
                connection: { success: false, message: '' },
                tables: { success: false, message: '', details: {} },
                functions: { success: false, message: '', details: {} }
            };
            
            try {
                // 1. 测试数据库连接
                log('1. 开始测试数据库连接...', 'info');
                await testConnection();
                
                // 2. 测试表结构
                if (diagnosisResults.connection.success) {
                    log('2. 开始测试表结构...', 'info');
                    await testTables();
                } else {
                    log('跳过表结构测试，连接失败', 'warning');
                }
                
                // 3. 测试功能
                if (diagnosisResults.tables.success) {
                    log('3. 开始测试核心功能...', 'info');
                    await testFunctions();
                } else {
                    log('跳过功能测试，表结构测试失败', 'warning');
                }
                
                // 4. 生成总结
                log('4. 生成诊断总结...', 'info');
                generateSummary();
                
                updateStatus('诊断完成', 'success');
            } catch (error) {
                log('诊断过程中发生错误: ' + error.message, 'error');
                updateStatus('诊断失败', 'error');
            }
        }

        // 测试数据库连接
        async function testConnection() {
            const resultDiv = document.getElementById('connectionTestResult');
            const contentDiv = document.getElementById('connectionTestContent');
            
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'test-result test-warning';
            contentDiv.innerHTML = '<p>正在测试数据库连接...</p>';
            
            try {
                const config = window.AppConfig;
                
                if (!config || !config.supabase) {
                    throw new Error('配置信息不完整');
                }
                
                log('测试Supabase客户端连接...', 'info');
                const startTime = Date.now();
                
                // 测试基本连接
                const { data, error } = await config.supabase.from('admins').select('id').limit(1);
                
                const endTime = Date.now();
                
                if (error) {
                    throw new Error(`连接失败: ${error.message}`);
                }
                
                log(`连接成功 (${endTime - startTime}ms)，返回 ${data.length} 条记录`, 'success');
                
                diagnosisResults.connection = {
                    success: true,
                    message: `连接成功，响应时间: ${endTime - startTime}ms`
                };
                
                resultDiv.className = 'test-result test-success';
                contentDiv.innerHTML = `
                    <p class="text-green-600 font-bold">✅ 数据库连接成功</p>
                    <ul class="list-disc list-inside text-sm mt-2">
                        <li>响应时间: ${endTime - startTime}ms</li>
                        <li>返回记录数: ${data.length}</li>
                        <li>API密钥长度: ${config.supabase.key.length} 字符</li>
                    </ul>
                `;
                
                return true;
            } catch (error) {
                log('数据库连接测试失败: ' + error.message, 'error');
                
                diagnosisResults.connection = {
                    success: false,
                    message: error.message
                };
                
                resultDiv.className = 'test-result test-error';
                contentDiv.innerHTML = `
                    <p class="text-red-600 font-bold">❌ 数据库连接失败</p>
                    <p class="text-sm mt-2">错误信息: ${error.message}</p>
                    <div class="bg-red-50 p-3 rounded mt-2 text-sm">
                        <p class="font-bold">可能的原因:</p>
                        <ul class="list-disc list-inside">
                            <li>API密钥无效或权限不足</li>
                            <li>网络连接问题</li>
                            <li>数据库URL错误</li>
                            <li>Supabase项目未激活</li>
                        </ul>
                    </div>
                `;
                
                return false;
            }
        }

        // 测试表结构
        async function testTables() {
            const resultDiv = document.getElementById('tableTestResult');
            const contentDiv = document.getElementById('tableTestContent');
            
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'test-result test-warning';
            contentDiv.innerHTML = '<p>正在测试表结构...</p>';
            
            try {
                const config = window.AppConfig;
                const tables = ['admins', 'games', 'users', 'game_records'];
                const tableResults = {};
                
                for (const table of tables) {
                    log(`测试表 ${table}...`, 'info');
                    
                    try {
                        const { data, error } = await config.supabase.from(table).select('*').limit(1);
                        
                        if (error) {
                            tableResults[table] = {
                                success: false,
                                message: error.message,
                                count: 0
                            };
                            log(`表 ${table} 测试失败: ${error.message}`, 'error');
                        } else {
                            tableResults[table] = {
                                success: true,
                                message: '表存在且可访问',
                                count: data.length
                            };
                            log(`表 ${table} 测试成功，当前记录数: ${data.length}`, 'success');
                        }
                    } catch (error) {
                        tableResults[table] = {
                            success: false,
                            message: error.message,
                            count: 0
                        };
                        log(`表 ${table} 测试异常: ${error.message}`, 'error');
                    }
                }
                
                diagnosisResults.tables = {
                    success: Object.values(tableResults).every(r => r.success),
                    message: `${Object.values(tableResults).filter(r => r.success).length}/${tables.length} 个表测试通过`,
                    details: tableResults
                };
                
                // 显示结果
                const successCount = Object.values(tableResults).filter(r => r.success).length;
                const allSuccess = successCount === tables.length;
                
                resultDiv.className = `test-result ${allSuccess ? 'test-success' : 'test-error'}`;
                
                let html = `<p class="font-bold ${allSuccess ? 'text-green-600' : 'text-red-600'}">
                    ${allSuccess ? '✅ 所有表测试通过' : `❌ ${successCount}/${tables.length} 个表测试通过`}
                </p>`;
                
                html += '<div class="grid grid-cols-2 gap-2 mt-3">';
                for (const [table, result] of Object.entries(tableResults)) {
                    html += `
                        <div class="p-2 rounded ${result.success ? 'bg-green-100' : 'bg-red-100'}">
                            <div class="font-semibold">${table}</div>
                            <div class="text-xs">${result.success ? '✅ 正常' : '❌ 错误'}</div>
                            <div class="text-xs">记录: ${result.count}</div>
                        </div>
                    `;
                }
                html += '</div>';
                
                contentDiv.innerHTML = html;
                
                return allSuccess;
            } catch (error) {
                log('表结构测试失败: ' + error.message, 'error');
                
                diagnosisResults.tables = {
                    success: false,
                    message: error.message,
                    details: {}
                };
                
                resultDiv.className = 'test-result test-error';
                contentDiv.innerHTML = `
                    <p class="text-red-600 font-bold">❌ 表结构测试失败</p>
                    <p class="text-sm mt-2">错误信息: ${error.message}</p>
                `;
                
                return false;
            }
        }

        // 测试功能
        async function testFunctions() {
            const resultDiv = document.getElementById('functionTestResult');
            const contentDiv = document.getElementById('functionTestContent');
            
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'test-result test-warning';
            contentDiv.innerHTML = '<p>正在测试核心功能...</p>';
            
            try {
                const config = window.AppConfig;
                const functionResults = {};
                
                // 测试获取游戏列表
                log('测试获取游戏列表功能...', 'info');
                try {
                    const { data, error } = await config.supabase.from('games').select('*');
                    functionResults.getGames = {
                        success: !error,
                        message: error ? error.message : `成功获取 ${data.length} 个游戏`,
                        count: data ? data.length : 0
                    };
                } catch (error) {
                    functionResults.getGames = {
                        success: false,
                        message: error.message,
                        count: 0
                    };
                }
                
                // 测试获取用户列表
                log('测试获取用户列表功能...', 'info');
                try {
                    const { data, error } = await config.supabase.from('users').select('*');
                    functionResults.getUsers = {
                        success: !error,
                        message: error ? error.message : `成功获取 ${data.length} 个用户`,
                        count: data ? data.length : 0
                    };
                } catch (error) {
                    functionResults.getUsers = {
                        success: false,
                        message: error.message,
                        count: 0
                    };
                }
                
                // 测试获取记录
                log('测试获取游戏记录功能...', 'info');
                try {
                    const { data, error } = await config.supabase.from('game_records').select('*').limit(5);
                    functionResults.getRecords = {
                        success: !error,
                        message: error ? error.message : `成功获取 ${data.length} 条记录`,
                        count: data ? data.length : 0
                    };
                } catch (error) {
                    functionResults.getRecords = {
                        success: false,
                        message: error.message,
                        count: 0
                    };
                }
                
                diagnosisResults.functions = {
                    success: Object.values(functionResults).every(r => r.success),
                    message: `${Object.values(functionResults).filter(r => r.success).length}/${Object.keys(functionResults).length} 个功能测试通过`,
                    details: functionResults
                };
                
                // 显示结果
                const successCount = Object.values(functionResults).filter(r => r.success).length;
                const totalCount = Object.keys(functionResults).length;
                const allSuccess = successCount === totalCount;
                
                resultDiv.className = `test-result ${allSuccess ? 'test-success' : 'test-warning'}`;
                
                let html = `<p class="font-bold ${allSuccess ? 'text-green-600' : 'text-yellow-600'}">
                    ${allSuccess ? '✅ 所有功能测试通过' : `⚠️ ${successCount}/${totalCount} 个功能测试通过`}
                </p>`;
                
                html += '<div class="space-y-2 mt-3">';
                const functionNames = {
                    getGames: '获取游戏列表',
                    getUsers: '获取用户列表',
                    getRecords: '获取游戏记录'
                };
                
                for (const [func, result] of Object.entries(functionResults)) {
                    html += `
                        <div class="p-2 rounded ${result.success ? 'bg-green-100' : 'bg-yellow-100'}">
                            <div class="font-semibold">${functionNames[func] || func}</div>
                            <div class="text-xs">${result.success ? '✅ 正常' : '⚠️ 问题'}</div>
                            <div class="text-xs">${result.message}</div>
                        </div>
                    `;
                }
                html += '</div>';
                
                contentDiv.innerHTML = html;
                
                return allSuccess;
            } catch (error) {
                log('功能测试失败: ' + error.message, 'error');
                
                diagnosisResults.functions = {
                    success: false,
                    message: error.message,
                    details: {}
                };
                
                resultDiv.className = 'test-result test-error';
                contentDiv.innerHTML = `
                    <p class="text-red-600 font-bold">❌ 功能测试失败</p>
                    <p class="text-sm mt-2">错误信息: ${error.message}</p>
                `;
                
                return false;
            }
        }

        // 生成总结
        function generateSummary() {
            const resultDiv = document.getElementById('summaryResult');
            const contentDiv = document.getElementById('summaryContent');
            
            resultDiv.classList.remove('hidden');
            
            const allSuccess = diagnosisResults.connection.success && 
                              diagnosisResults.tables.success && 
                              diagnosisResults.functions.success;
            
            const overallStatus = allSuccess ? 'success' : 
                                 diagnosisResults.connection.success ? 'warning' : 'error';
            
            resultDiv.className = `test-result test-${overallStatus}`;
            
            let html = `<p class="font-bold ${allSuccess ? 'text-green-600' : 'text-red-600'}">
                ${allSuccess ? '✅ 系统状态良好' : '❌ 系统存在问题'}
            </p>`;
            
            html += '<div class="space-y-3 mt-3">';
            
            // 连接状态
            html += `
                <div class="p-2 rounded ${diagnosisResults.connection.success ? 'bg-green-100' : 'bg-red-100'}">
                    <div class="font-semibold">数据库连接</div>
                    <div class="text-sm">${diagnosisResults.connection.message}</div>
                </div>
            `;
            
            // 表状态
            html += `
                <div class="p-2 rounded ${diagnosisResults.tables.success ? 'bg-green-100' : 'bg-red-100'}">
                    <div class="font-semibold">表结构</div>
                    <div class="text-sm">${diagnosisResults.tables.message}</div>
                </div>
            `;
            
            // 功能状态
            html += `
                <div class="p-2 rounded ${diagnosisResults.functions.success ? 'bg-green-100' : 'bg-yellow-100'}">
                    <div class="font-semibold">核心功能</div>
                    <div class="text-sm">${diagnosisResults.functions.message}</div>
                </div>
            `;
            
            // 建议
            html += '<div class="bg-blue-50 p-3 rounded">';
            html += '<div class="font-semibold text-blue-800">修复建议:</div>';
            
            if (!diagnosisResults.connection.success) {
                html += `
                    <ul class="list-disc list-inside text-sm mt-1 text-blue-700">
                        <li>检查API密钥是否正确</li>
                        <li>确认Supabase项目已激活</li>
                        <li>验证网络连接</li>
                        <li>检查数据库URL配置</li>
                    </ul>
                `;
            }
            
            if (!diagnosisResults.tables.success) {
                html += `
                    <ul class="list-disc list-inside text-sm mt-1 text-blue-700">
                        <li>确保所有必要的表已创建</li>
                        <li>检查表名是否正确</li>
                        <li>验证用户权限</li>
                    </ul>
                `;
            }
            
            if (!diagnosisResults.functions.success) {
                html += `
                    <ul class="list-disc list-inside text-sm mt-1 text-blue-700">
                        <li>检查数据结构是否匹配</li>
                        <li>验证字段名是否正确</li>
                        <li>检查数据类型兼容性</li>
                    </ul>
                `;
            }
            
            if (allSuccess) {
                html += '<p class="text-sm mt-1 text-blue-700">系统运行正常，无需修复。</p>';
            }
            
            html += '</div>';
            html += '</div>';
            
            contentDiv.innerHTML = html;
        }
    </script>
</body>
</html>